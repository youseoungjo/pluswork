<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--************************************************************************************
* Program Name : WO0401
* Description : 기술문서
* Author :
* Created Date :
* SQL 목록
***************************************************************************************
* SQLID                 설명
***************************************************************************************
* retrieveWO0401List : 메뉴 목록 조회
* insertWO0401 : 기술문서 목록 추가
* updateWO0401 : 기술문서 목록 수정
* deleteWO0401 : 기술문서 목록 삭제
*************************************************************************************-->
<mapper namespace="wo0401">

    <select id="retrieveWO0401List" parameterType="map" resultType="map" >
        <![CDATA[ /* wo0401.retrieveWO0401List */ ]]>
        SELECT
               X.INPUT_NO
             , X.INPUT_NM
             , X.EQ_NO
             , Y.EQ_NM
             , X.ORG_CD
             , dbo.FN_NAME(X.ORG_CD, 'DEPT') ORG_DESC
             , X.WORK_USER_ID
             , dbo.FN_NAME(X.WORK_USER_ID, 'USER')WORK_USER_NM
             , X.START_YMD
             , X.END_YMD
             , X.START_TIME
             , X.END_TIME
             , X.WORK_DESC
             , X.FILE_ATCH_ID
             , (SELECT COUNT(*) FROM SC_FILE WHERE FILE_ATCH_ID = X.FILE_ATCH_ID) AS FILE_CNT
             , X.COMPANY_CD
          FROM WO0401M X
         INNER JOIN EQ0101M Y ON (X.EQ_NO  = Y.EQ_NO AND X.COMPANY_CD = Y.COMPANY_CD)
         WHERE Y.REV_NO = #{revNo}
           AND X.COMPANY_CD = #{companyCd}
        <if test="fInputNo != null &amp;&amp; fInputNo != ''">
           AND X.INPUT_NO LIKE '%' + #{fInputNo} + '%'
        </if>
        <if test="fInputNm != null &amp;&amp; fInputNm != ''">
           AND UPPER(X.INPUT_NM) LIKE '%' + UPPER(#{fInputNm}) + '%'
        </if>
        <if test="fOrgCd != null &amp;&amp; fOrgCd != ''">
           AND X.ORG_CD = #{fOrgCd}
        </if>
        <if test="fStartYmd != null &amp;&amp; fStartYmd != ''">
          <if test="fEndYmd != null &amp;&amp; fEndYmd != ''">
           AND X.START_YMD BETWEEN #{fStartYmd} AND #{fEndYmd}
          </if>
        </if>
         ORDER BY INPUT_NO DESC
    </select>

    <select id="retrieveWO0401ListToTree" parameterType="map" resultType="map" >
        <![CDATA[ /* wo0401.retrieveWO0401ListToTree */ ]]>
        WITH EQ_SUB
          AS (SELECT CLS_CD,
                     PRNT_CLS_CD,
                     CLS_LVL,
                     COMPANY_CD
              FROM   EQ0201M
              WHERE  EQ_CLS = #{eqClsDiv}
                     AND CLS_CD IN (${eqNo})
                     AND COMPANY_CD = #{companyCd}
              UNION ALL
              SELECT M.CLS_CD,
                     M.PRNT_CLS_CD,
                     M.CLS_LVL,
                     M.COMPANY_CD
              FROM   EQ0201M M
                     JOIN EQ_SUB N
                       ON N.CLS_CD = M.PRNT_CLS_CD AND N.COMPANY_CD = M.COMPANY_CD
              WHERE  1 = 1)
        SELECT
               X.INPUT_NO
             , X.INPUT_NM
             , X.EQ_NO
             , Y.EQ_NM
             , X.ORG_CD
             , dbo.FN_NAME(X.ORG_CD, 'DEPT') ORG_DESC
             , X.WORK_USER_ID
             , dbo.FN_NAME(X.WORK_USER_ID, 'USER')WORK_USER_NM
             , X.START_YMD
             , X.END_YMD
             , X.START_TIME
             , X.END_TIME
             , X.WORK_DESC
             , X.COMPANY_CD
          FROM WO0401M X
         INNER JOIN EQ0101M Y ON (X.EQ_NO  = Y.EQ_NO AND X.COMPANY_CD = Y.COMPANY_CD)
         WHERE Y.REV_NO = #{revNo}
           AND X.COMPANY_CD = #{companyCd}
         <if test="eqClsDiv == 'EQ_TP'">
          AND Y.EQ_TP IN (
              SELECT CLS_CD FROM EQ_SUB
              )
         </if>
         <if test="eqClsDiv == 'EQ_LOC'">
          AND Y.EQ_LOC IN (
                SELECT CLS_CD FROM EQ_SUB
              )
         </if>
         <if test="eqClsDiv == 'EQ_PRCS'">
          AND Y.EQ_PRCS IN (
                SELECT CLS_CD FROM EQ_SUB
              )
         </if>
         <if test="eqClsDiv == 'EQ_MY'">
          AND Y.EQ_PRCS IN (
                 SELECT EQ_PRCS
                  FROM EQ0101M
                 WHERE 1=1
                   AND EQ_NO IN (${eqNo})
                   AND COMPANY_CD = #{companyCd}
              )
          AND Y.EQ_NO IN (SELECT EQ_NO FROM EQ0101P WHERE USE_YN = 'Y' AND USER_ID = #{userId} AND COMPANY_CD = #{companyCd})
         </if>
         ORDER BY INPUT_NO DESC
    </select>

    <!-- 설비 정보 저장  -->
    <insert id="insertWO0401" parameterType="map" >
        <![CDATA[ /* wo0401.insertWO0401 */ ]]>
        INSERT INTO WO0401M (
               INPUT_NO
             , INPUT_NM
             , EQ_NO
             , ORG_CD
             , WORK_USER_ID
             , WORK_DESC
             , START_YMD
             , START_TIME
             , END_YMD
             , END_TIME
             , FILE_ATCH_ID
             , COMPANY_CD
             , FST_REG_USER_ID
             , FST_REG_DT
             , FNL_EDIT_USER_ID
             , FNL_EDIT_DT
        )
        VALUES (
                #{inputNo}
              , #{inputNm}
              , #{eqNo}
              , #{orgCd}
              , #{workUserId}
              , #{workDesc}
              , #{startYmd}
              , #{startTime}
              , #{endYmd}
              , #{endTime}
              <if test="fileAtchId == ''">
              , null
              </if>
              <if test="fileAtchId != ''">
              , #{fileAtchId}
              </if>
              , #{companyCd}
              , #{fstRegUserId}
              , GETDATE()
              , #{fnlEditUserId}
              , GETDATE()
        )
    </insert>

    <!-- 해당 설비ID정보 수정 -->
    <update id="updateWO0401" parameterType="map" >
        <![CDATA[ /* wo0401.updateWO0401 */ ]]>
        UPDATE WO0401M
           SET
               INPUT_NM               = #{inputNm}
             , EQ_NO                  = #{eqNo}
             , ORG_CD                 = #{orgCd}
             , WORK_USER_ID           = #{workUserId}
             , WORK_DESC              = #{workDesc}
             , START_YMD              = #{startYmd}
             , START_TIME             = #{startTime}
             , END_YMD                = #{endYmd}
             , END_TIME               = #{endTime}
             <if test="fileAtchId == ''">
             , FILE_ATCH_ID     = null
             </if>
             <if test="fileAtchId != ''">
             , FILE_ATCH_ID     = #{fileAtchId}
             </if>
             , FNL_EDIT_DT            = GETDATE()
             , FNL_EDIT_USER_ID       = #{fnlEditUserId}
         WHERE INPUT_NO = #{inputNo}
           AND COMPANY_CD = #{companyCd}
    </update>

    <!-- 해당 설비ID 삭제 -->
    <delete id="deleteWO0401" parameterType="map" >
        <![CDATA[ /* wo0401.deleteWO0401 */ ]]>
        DELETE
          FROM WO0401M
         WHERE INPUT_NO = #{inputNo}
           AND COMPANY_CD = #{companyCd}
    </delete>
</mapper>