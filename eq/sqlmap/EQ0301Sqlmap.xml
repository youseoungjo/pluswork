<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--************************************************************************************
* Program Name : EQ0301
* Description : 기술문서
* Author :
* Created Date :
* SQL 목록
***************************************************************************************
* SQLID                 설명
***************************************************************************************
* retrieveEQ0301List : 메뉴 목록 조회
* insertEQ0301 : 기술문서 목록 추가
* updateEQ0301 : 기술문서 목록 수정
* deleteEQ0301 : 기술문서 목록 삭제
*************************************************************************************-->
<mapper namespace="eq0301">
    <select id="retrieveEQ0301List" parameterType="map" resultType="map" >
        <![CDATA[ /* eq0301.retrieveEQ0301List */ ]]>
        SELECT
               #{revNo} REV_NO
             , X.TECH_NO
             , X.TECH_NM
             , X.TECH_TP
             , ( SELECT STRING_AGG(Q.FILE_NM,',') WITHIN GROUP(ORDER BY Q.FILE_ID)
                   FROM SC_FILE Q
                  WHERE Q.FILE_ATCH_ID = X.FILE_ATCH_ID
             ) FILE_NM
             , ( SELECT STRING_AGG(W.EQ_NO,',') WITHIN GROUP(ORDER BY W.EQ_NO)
                  FROM EQ0301D Q, EQ0101M W
                 WHERE Q.EQ_NO = W.EQ_NO
                   AND Q.COMPANY_CD = W.COMPANY_CD
                   AND Q.TECH_NO = X.TECH_NO
                   AND W.REV_NO = #{revNo}
                   AND Q.COMPANY_CD = #{companyCd}
             ) EQ_NO
             , CMMNT
             , FILE_ATCH_ID
             , (SELECT COUNT(*) FROM SC_FILE WHERE FILE_ATCH_ID = X.FILE_ATCH_ID) AS FILE_CNT
			 , FST_REG_USER_ID
			 , (SELECT USER_NM FROM SC_USER WHERE COMPANY_CD = #{companyCd} AND USER_ID = X.FST_REG_USER_ID) + ' [' + FST_REG_USER_ID + ']' AS USER_NM
             , ORG_CD
			 , (SELECT ORG_NM FROM SC_ORG WHERE COMPANY_CD = #{companyCd} AND ORG_CD = X.ORG_CD) AS ORG_NM
             , COMPANY_CD
          FROM EQ0301M X
         WHERE 1 = 1
           AND COMPANY_CD = #{companyCd}
         <if test="techNo != null &amp;&amp; techNo != ''">
           AND TECH_NO = #{techNo}
         </if>
         <if test="techNm != null &amp;&amp; techNm != ''">
           AND TECH_NM LIKE '%' + #{techNm} + '%'
         </if>
         ORDER BY CONVERT(INT,X.TECH_NO) DESC
    </select>

    <select id="retrieveEQ0301ListToTree" parameterType="map" resultType="map" >
        <![CDATA[ /* eq0301.retrieveEQ0301ListToTree */ ]]>
        WITH EQ_SUB
          AS (SELECT CLS_CD,
                     PRNT_CLS_CD,
                     CLS_LVL,
					 COMPANY_CD
              FROM   EQ0201M
              WHERE  EQ_CLS = #{eqClsDiv}
                     AND CLS_CD IN (${eqNo}) AND COMPANY_CD = #{companyCd}
              UNION ALL
              SELECT M.CLS_CD,
                     M.PRNT_CLS_CD,
                     M.CLS_LVL,
					 M.COMPANY_CD
              FROM   EQ0201M M
                     JOIN EQ_SUB N
                       ON N.CLS_CD = M.PRNT_CLS_CD AND N.COMPANY_CD = M.COMPANY_CD
              WHERE  1 = 1)
        SELECT
               #{revNo} REV_NO
             , X.TECH_NO
             , X.TECH_NM
             , X.TECH_TP
             , ( SELECT STRING_AGG(Q.FILE_NM,',') WITHIN GROUP(ORDER BY Q.FILE_ID)
                   FROM SC_FILE Q
                  WHERE Q.FILE_ATCH_ID = X.FILE_ATCH_ID
             ) FILE_NM
             , ( SELECT STRING_AGG(W.EQ_NO,',') WITHIN GROUP(ORDER BY W.EQ_NO)
                  FROM EQ0301D Q, EQ0101M W
                 WHERE Q.EQ_NO = W.EQ_NO
                   AND Q.COMPANY_CD = W.COMPANY_CD
                   AND Q.TECH_NO = X.TECH_NO
                   AND W.REV_NO = #{revNo}
                   AND Q.COMPANY_CD = #{companyCd}
             ) EQ_NO
             , CMMNT
             , FILE_ATCH_ID
			 , FST_REG_USER_ID
			 , (SELECT USER_NM FROM SC_USER WHERE COMPANY_CD = #{companyCd} AND USER_ID = X.FST_REG_USER_ID) + ' [' + FST_REG_USER_ID + ']' AS USER_NM
             , ORG_CD
			 , (SELECT ORG_NM FROM SC_ORG WHERE COMPANY_CD = #{companyCd} AND ORG_CD = X.ORG_CD) AS ORG_NM
             , X.COMPANY_CD
          FROM EQ0301M X
         WHERE 1 = 1
           AND X.COMPANY_CD = #{companyCd}
         <if test="eqClsDiv == 'EQ_TP'">
          AND X.TECH_NO IN
              (SELECT Z2.TECH_NO
                  FROM EQ0101M Z1
                  LEFT OUTER JOIN EQ0301D Z2 ON (Z2.EQ_NO = Z1.EQ_NO AND Z2.COMPANY_CD = Z1.COMPANY_CD)
                 WHERE EQ_TP IN (SELECT CLS_CD FROM EQ_SUB)
                   AND Z1.COMPANY_CD = #{companyCd}
               )
         </if>
         <if test="eqClsDiv == 'EQ_LOC'">
          AND X.TECH_NO IN
              (SELECT Z2.TECH_NO
                  FROM EQ0101M Z1
                  LEFT OUTER JOIN EQ0301D Z2 ON (Z2.EQ_NO = Z1.EQ_NO AND Z2.COMPANY_CD = Z1.COMPANY_CD)
                 WHERE EQ_LOC IN (SELECT CLS_CD FROM EQ_SUB)
                   AND Z1.COMPANY_CD = #{companyCd}
               )
         </if>
         <if test="eqClsDiv == 'EQ_PRCS'">
          AND X.TECH_NO IN
              (SELECT Z2.TECH_NO
                  FROM EQ0101M Z1
                  LEFT OUTER JOIN EQ0301D Z2 ON (Z2.EQ_NO = Z1.EQ_NO AND Z2.COMPANY_CD = Z1.COMPANY_CD)
                 WHERE EQ_PRCS IN (SELECT CLS_CD FROM EQ_SUB)
                   AND Z1.COMPANY_CD = #{companyCd}
               )
         </if>
         <if test="eqClsDiv == 'EQ_MY'">
           AND X.TECH_NO IN
               (SELECT Z2.TECH_NO
                  FROM EQ0101M Z1
                  LEFT OUTER JOIN EQ0301D Z2 ON (Z2.EQ_NO = Z1.EQ_NO AND Z2.COMPANY_CD = Z1.COMPANY_CD)
                 WHERE Z1.EQ_NO IN (${eqNo})
                   AND Z1.EQ_NO IN (SELECT EQ_NO FROM EQ0101P WHERE USE_YN = 'Y' AND USER_ID = #{userId} AND COMPANY_CD = #{companyCd})
                   AND Z1.COMPANY_CD = #{companyCd}
               )
         </if>
         ORDER BY CONVERT(INT,X.TECH_NO) DESC
    </select>


    <select id="retrieveEqDocList" parameterType="map" resultType="map" >
        <![CDATA[ /* eq0301.retrieveEqDocList */ ]]>
        SELECT
                X.EQ_NO
              , Y.ITEM_NO
              , Y.EQ_NM
              , X.TECH_NO
              , X.EQ_NO OLD_EQ_NO
              , (SELECT Z.FILE_ATCH_ID FROM EQ0301M Z WHERE X.TECH_NO=Z.TECH_NO AND Z.COMPANY_CD = #{companyCd}) FILE_ATCH_ID
           FROM EQ0301D X, EQ0101M Y
          WHERE X.EQ_NO = Y.EQ_NO
            AND X.COMPANY_CD = Y.COMPANY_CD
            AND Y.REV_NO = #{revNo}
            AND X.TECH_NO = #{techNo}
            AND X.COMPANY_CD = #{companyCd}
          ORDER BY EQ_NO ASC
    </select>


 <!-- 설비 정보 저장  -->
    <insert id="insertEQ0301" parameterType="map" >
        <![CDATA[ /* eq0301.insertEQ0301 */ ]]>
        INSERT INTO EQ0301M (
               TECH_NO
             , COMPANY_CD
             , FILE_ATCH_ID
             , TECH_NM
             , TECH_TP
             , CMMNT
             , ORG_CD
             , FST_REG_USER_ID
             , FST_REG_DT
        )
        VALUES (
               #{techNo}
             , #{companyCd}
             <if test="fileAtchId == ''">
             , null
             </if>
             <if test="fileAtchId != ''">
             , #{fileAtchId}
             </if>
             , #{techNm}
             , #{techTp}
             , #{cmmnt}
             , #{orgCd}
             , #{fstRegUserId}
             , GETDATE()

        )
    </insert>

 <!-- 해당 설비ID정보 수정 -->
    <update id="updateEQ0301" parameterType="map" >
        <![CDATA[ /* eq0301.updateEQ0301 */ ]]>
        UPDATE EQ0301M
           SET
             <if test="fileAtchId == ''">
               FILE_ATCH_ID     = null
             </if>
             <if test="fileAtchId != ''">
               FILE_ATCH_ID     = #{fileAtchId}
             </if>
             , TECH_NM           = #{techNm}
             , TECH_TP           = #{techTp}
             , CMMNT             = #{cmmnt}
             , FNL_EDIT_DT       = GETDATE()
             , FNL_EDIT_USER_ID  = #{fnlEditUserId}
         WHERE TECH_NO           = #{techNo}
           AND COMPANY_CD        = #{companyCd}
    </update>

    <!-- 해당 설비ID 삭제 -->
    <delete id="deleteEQ0301" parameterType="map" >
        <![CDATA[ /* eq0301.deleteEQ0301 */ ]]>
        DELETE
          FROM EQ0301M
         WHERE TECH_NO    = #{techNo}
           AND COMPANY_CD = #{companyCd}
    </delete>

 <!-- 설비문서 정보 저장  -->
    <insert id="insertEqDoc" parameterType="map" >
        <![CDATA[ /* eq0301.insertEqDoc */ ]]>
        INSERT INTO EQ0301D (
               EQ_NO
             , COMPANY_CD
             , TECH_NO
             , FST_REG_USER_ID
             , FST_REG_DT
             , FNL_EDIT_USER_ID
             , FNL_EDIT_DT
        )
        VALUES (
               #{eqNo}
             , #{companyCd}
             , #{techNo}
             , #{fstRegUserId}
             , GETDATE()
             , #{fnlEditUserId}
             , GETDATE()
        )
    </insert>

     <!-- 해당 설비문서ID 수정 -->
    <update id="updateEq" parameterType="map" >
        <![CDATA[ /* eq0301.updateEq */ ]]>
        UPDATE EQ0101M
           SET
             <if test="fileAtchId == ''">
               FILE_ATCH_ID     = null
             </if>
             <if test="fileAtchId != ''">
               FILE_ATCH_ID     = #{fileAtchId}
             </if>
             , FNL_EDIT_DT       = GETDATE()
             , FNL_EDIT_USER_ID  = #{fnlEditUserId}
         WHERE REV_NO = #{revNo}
           AND EQ_NO  = #{eqNo}
           AND COMPANY_CD  = #{companyCd}
    </update>

    <update id="deleteEq" parameterType="map" >
        <![CDATA[ /* eq0301.deleteEq */ ]]>
        UPDATE EQ0101M
           SET
               FILE_ATCH_ID      = ''
             , FNL_EDIT_DT       = GETDATE()
             , FNL_EDIT_USER_ID  = #{fnlEditUserId}
         WHERE REV_NO = (SELECT REV_NO FROM EQ0201R WHERE COMPANY_CD = #{companyCd} AND REV_START_YMD = (SELECT MAX(REV_START_YMD) FROM EQ0201R WHERE CONVERT(VARCHAR, GETDATE(), 23) >= REV_START_YMD))
           AND EQ_NO  = #{eqNo}
           AND COMPANY_CD = #{companyCd}
    </update>

 <!-- 해당 설비문서ID 수정 -->
    <update id="updateEqDoc" parameterType="map" >
        <![CDATA[ /* eq0301.updateEqDoc */ ]]>
        UPDATE EQ0301D
           SET
             <if test="fileAtchId == ''">
               FILE_ATCH_ID     = null
             </if>
             <if test="fileAtchId != ''">
               FILE_ATCH_ID     = #{fileAtchId}
             </if>
             , FNL_EDIT_DT       = GETDATE()
             , FNL_EDIT_USER_ID  = #{fnlEditUserId}
         WHERE EQ_NO = #{eqNo}
           AND COMPANY_CD = #{companyCd}
    </update>

    <!-- 해당 설비문서ID 삭제 -->
    <delete id="deleteEqDoc" parameterType="map" >
        <![CDATA[ /* eq0301.deleteEqDoc */ ]]>
        DELETE
          FROM EQ0301D
         WHERE EQ_NO   = #{eqNo}
           AND TECH_NO = #{techNo}
           AND COMPANY_CD = #{companyCd}
    </delete>

    <select id="retrieveEqAtchId" parameterType="map" resultType="map">
        <![CDATA[ /* eq0301.retrieveEqAtchId */ ]]>
        SELECT
               TO_CHAR(FILE_ATCH_ID) AS FILE_ATCH_ID
          FROM EQ0101M
         WHERE REV_NO = #{revNo}
           AND EQ_NO = #{eqNo}
           AND COMPANY_CD = #{companyCd}
    </select>

</mapper>