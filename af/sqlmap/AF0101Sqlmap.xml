<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--************************************************************************************
* Program Name : AF0101
* Description : 작업요청
* Author :
* Created Date :
* SQL 목록
***************************************************************************************
* SQLID                 설명
***************************************************************************************
* retrieveAF0101List : 메뉴 목록 조회
* insertAF0101 : 작업요청 목록 추가
* updateAF0101 : 작업요청 목록 수정
* deleteAF0101 : 작업요청 목록 삭제
*************************************************************************************-->
<mapper namespace="af0101">
    <select id="retrieveAF0101List" parameterType="map" resultType="map" >
        <![CDATA[ /* af0101.retrieveAF0101List */ ]]>
        SELECT *
          FROM (
                SELECT Y.APPR_YMD + ' ' + LEFT(ISNULL(Y.APPR_TIME,'00'),2) + ':' + RIGHT(ISNULL(Y.APPR_TIME,'00'),2) APPR_YMD
                     , X.COMPANY_CD
                     , X.APPR_NO
                     , X.TITLE
                     , X.APPR_STS
                     , dbo.FN_NAME(X.APPR_STS, 'APPR_STS') APPR_STS_NM
                     , X.APPR_TP
                     , dbo.FN_NAME(X.APPR_TP, 'APPR_TP') APPR_TP_NM
                     , X.DUTY_NO
                     , X.CMMNT
                     , Y.APPR_DESC
                     , Y.APPR_FLOW_NO
                 FROM  AF0101M X, AF0101D Y
                 WHERE X.APPR_NO = Y.APPR_NO
                   and X.COMPANY_CD = Y.COMPANY_CD
                   AND X.COMPANY_CD = #{companyCd}
                   AND Y.FLOW_STS = 'A'
                <if test="apprStartYmd != null &amp;&amp; apprStartYmd != ''">
                   AND Y.APPR_YMD <![CDATA[ >= ]]> #{apprStartYmd}
                </if>
                <if test="apprEndYmd != null &amp;&amp; apprEndYmd != ''">
                   AND Y.APPR_YMD <![CDATA[ <= ]]> #{apprEndYmd}
                </if>
                <if test="fApprNo != null &amp;&amp; fApprNo != ''">
                   AND X.APPR_NO = #{fApprNo}
                </if>
                <if test="fApprNm != null &amp;&amp; fApprNm != ''">
                   AND UPPER(X.TITLE) LIKE '%' + UPPER(#{fApprNm}) + '%'
                </if>
                <if test="fApprSts != null &amp;&amp; fApprSts != ''">
                   AND X.APPR_STS IN (${fApprSts})
                </if>
                <if test="fDutyNo != null &amp;&amp; fDutyNo != ''">
                   AND X.DUTY_NO = #{fDutyNo}
                </if>
                <if test="fApprTp != null &amp;&amp; fApprTp != ''">
                   AND X.APPR_TP IN (${fApprTp})
                </if>
                <if test="fFlowSts != null &amp;&amp; fFlowSts != ''">
                   AND Y.FLOW_STS IN (${fFlowSts})
                </if>
                <if test="fUserId != null &amp;&amp; fUserId != ''">
                   AND Y.USER_ID = #{fUserId}
                </if>
               UNION ALL
               SELECT Y.APPR_YMD + ' ' + LEFT(ISNULL(Y.APPR_TIME,'00'),2) + ':' + RIGHT(ISNULL(Y.APPR_TIME,'00'),2) APPR_YMD
                    , X.COMPANY_CD
                    , X.APPR_NO
                    , X.TITLE
                    , X.APPR_STS
                    , dbo.FN_NAME(X.APPR_STS, 'APPR_STS') APPR_STS_NM
                    , X.APPR_TP
                    , dbo.FN_NAME(X.APPR_TP, 'APPR_TP') APPR_TP_NM
                    , X.DUTY_NO
                    , X.CMMNT
                    , Y.APPR_DESC
                    , Y.APPR_FLOW_NO
                 FROM AF0101M X, AF0101D Y
                WHERE X.APPR_NO = Y.APPR_NO
                  AND X.COMPANY_CD = Y.COMPANY_CD
                  AND X.COMPANY_CD = #{companyCd}
                  AND NOT EXISTS ( SELECT APPR_SEQ_NO FROM AF0101D WHERE APPR_NO = X.APPR_NO AND APPR_SEQ_NO = '0' AND COMPANY_CD = #{companyCd} )
               <if test="apprStartYmd != null &amp;&amp; apprStartYmd != ''">
                  AND Y.APPR_YMD <![CDATA[ >= ]]> #{apprStartYmd}
               </if>
               <if test="apprEndYmd != null &amp;&amp; apprEndYmd != ''">
                  AND Y.APPR_YMD <![CDATA[ <= ]]> #{apprEndYmd}
               </if>
               <if test="fApprNo != null &amp;&amp; fApprNo != ''">
                  AND X.APPR_NO = #{fApprNo}
               </if>
               <if test="fApprNm != null &amp;&amp; fApprNm != ''">
                  AND UPPER(X.TITLE) LIKE '%' + UPPER(#{fApprNm}) + '%'
               </if>
               <if test="fApprSts != null &amp;&amp; fApprSts != ''">
                  AND X.APPR_STS IN (${fApprSts})
               </if>
               <if test="fDutyNo != null &amp;&amp; fDutyNo != ''">
                  AND X.DUTY_NO = #{fDutyNo}
               </if>
               <if test="fApprTp != null &amp;&amp; fApprTp != ''">
                  AND X.APPR_TP IN (${fApprTp})
               </if>
               <if test="fFlowSts != null &amp;&amp; fFlowSts != ''">
                  AND Y.FLOW_STS IN (${fFlowSts})
               </if>
               <if test="fUserId != null &amp;&amp; fUserId != ''">
                  AND Y.USER_ID = #{fUserId}
               </if>
            ) A
        ORDER BY APPR_NO DESC
    </select>

    <select id="retrieveAF0101SubList" parameterType="map" resultType="map" >
        <![CDATA[ /* af0101.retrieveAF0101SubList */ ]]>
        SELECT
               X.APPR_SEQ_NO
             , dbo.FN_NAME(X.FLOW_STS, 'FLOW_STS') FLOW_STS
             , X.APPR_YMD + ' ' + LEFT(ISNULL(X.APPR_TIME,'00'),2) + ':' + RIGHT(ISNULL(X.APPR_TIME,'00'),2) APPR_YMD
             ,CASE WHEN X.APPR_SEQ_NO = 0 THEN dbo.FN_NAME(X.FLOW_STS, 'FLOW_STS') ELSE dbo.FN_NAME(X.APPR_DIV, 'APPR_DIV') END APPR_DIV
             , X.USER_ID  + ' / ' +  dbo.FN_NAME(X.USER_ID, 'USER')  + ' / ' +
               (SELECT dbo.FN_NAME(A.ORG_CD, 'DEPT')
                  FROM SC_USER A
                 WHERE A.USER_ID = X.USER_ID AND A.COMPANY_CD = #{companyCd}) FLOW_USER_INFO
             , X.APPR_DESC
             , X.USER_ID
             , X.APPR_FLOW_NO
             , X.COMPANY_CD
          FROM AF0101D X
         WHERE X.APPR_NO = #{apprNo}
           AND X.COMPANY_CD = #{companyCd}
           AND X.APPR_SEQ_NO <![CDATA[ <> ]]> '999'
         ORDER BY X.APPR_SEQ_NO, X.USER_ID
    </select>


    <update id="setApprWfSts" parameterType="map" >
        <![CDATA[ /* af0101.setApprWfSts */ ]]>
        UPDATE AF0101D
           SET
               FLOW_TRAN         = 'Z'
             , FNL_EDIT_DT       = GETDATE()
             , FNL_EDIT_USER_ID  = #{fnlEditUserId}
         WHERE APPR_NO = #{apprNo}
           AND COMPANY_CD = #{companyCd}
           AND FLOW_TRAN = 'P'
    </update>

    <insert id="insertCancelUser" parameterType="map" >
        <![CDATA[ /* af0101.insertCancelUser */ ]]>
        INSERT INTO AF0101D (
               APPR_NO
             , COMPANY_CD
             , APPR_FLOW_NO
             , APPR_SEQ_NO
             , USER_ID
             , APPR_USER_ID
             , APPR_YMD
             , APPR_TIME
             , FLOW_STS
             , FLOW_TRAN
             , FST_REG_DT
             , FST_REG_USER_ID
             , FNL_EDIT_DT
             , FNL_EDIT_USER_ID
        )
        VALUES (
               #{apprNo}
             , #{companyCd}
             , NEXT VALUE FOR DBO.SQAPP_FLOW_NO
             , (SELECT MAX(A.APPR_SEQ_NO) + 1
                  FROM AF0101D A
                 WHERE A.APPR_NO = #{apprNo} )
             , #{fnlEditUserId}
             , #{fnlEditUserId}
             , CONVERT(VARCHAR, GETDATE(), 23)
             , REPLACE(CONVERT(CHAR(5), GETDATE(), 24),':','')
             , 'E'
             , 'C'
             , GETDATE()
             , #{fstRegUserId}
             , GETDATE()
             , #{fnlEditUserId}
        )
    </insert>

    <insert id="insertNotAppr" parameterType="map" >
        <![CDATA[ /* af0101.insertNotAppr */ ]]>
        INSERT INTO AF0101D (
               APPR_NO
             , COMPANY_CD
             , APPR_FLOW_NO
             , APPR_SEQ_NO
             , USER_ID
             , APPR_DIV
             , FLOW_STS
             , FLOW_TRAN
             , FST_REG_DT
             , FST_REG_USER_ID
             , FNL_EDIT_DT
             , FNL_EDIT_USER_ID
         )
         SELECT
               X.APPR_NO
             , #{companyCd}
             , NEXT VALUE FOR DBO.SQAPP_FLOW_NO
             , '999'
             , X.USER_ID
             , 'NT'
             , 'Z'
             , 'P'
             , GETDATE()
             , #{fstRegUserId}
             , GETDATE()
             , #{fnlEditUserId}
          FROM AF0101D X
         WHERE X.APPR_NO = #{apprNo}
           AND X.COMPANY_CD = #{companyCd}
           AND X.APPR_SEQ_NO = 0
    </insert>

    <update id="setApprDocSts" parameterType="map" >
        <![CDATA[ /* af0101.setApprDocSts */ ]]>
        UPDATE AF0101M
           SET
               APPR_STS         = 'APP05'
             , FNL_EDIT_DT       = GETDATE()
             , FNL_EDIT_USER_ID  = #{fnlEditUserId}
         WHERE APPR_NO = #{apprNo}
           AND COMPANY_CD = #{companyCd}
    </update>
</mapper>