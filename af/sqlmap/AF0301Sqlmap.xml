<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--************************************************************************************
* Program Name : AF0101
* Description : 작업요청
* Author :
* Created Date :
* SQL 목록
***************************************************************************************
* SQLID                 설명
***************************************************************************************
* retrieveAF0101List : 메뉴 목록 조회
* insertAF0101 : 작업요청 목록 추가
* updateAF0101 : 작업요청 목록 수정
* deleteAF0101 : 작업요청 목록 삭제
*************************************************************************************-->
<mapper namespace="af0301">
    <select id="retrieveAF0301List" parameterType="map" resultType="map" >
        <![CDATA[ /* af0301.retrieveAF0301List */ ]]>
        SELECT  CASE WHEN Y.FLOW_TRAN = 'P' THEN 'N' ELSE 'Y' END FLOW_TRAN_YN
              , X.APPR_NO
              , dbo.FN_NAME(Y.FLOW_STS, 'FLOW_STS') FLOW_STS_NM
              , X.TITLE
              , X.APPR_STS
              , dbo.FN_NAME(X.APPR_STS, 'APPR_STS') APPR_STS_NM
              , X.APPR_TP
              , dbo.FN_NAME(X.APPR_TP, 'APPR_TP') APPR_TP_NM
              , (SELECT STRING_AGG(A.DUTY_NO,',') WITHIN GROUP (ORDER BY A.DUTY_NO)
                   FROM AF0101A A
                  WHERE A.APPR_NO = X.APPR_NO AND A.COMPANY_CD = #{companyCd}) DUTY_NO
              , Y.APPR_YMD + ' ' + LEFT(ISNULL(Y.APPR_TIME,'00'),2) + ':' + RIGHT(ISNULL(Y.APPR_TIME,'00'),2) APPR_SUMIT_YMD
              , Y.APPR_FLOW_NO
              , Y.FLOW_TRAN
              , Y.APPR_SEQ_NO
              , X.APPR_YMD
              , X.COMPANY_CD
           FROM AF0101M X, AF0101D Y
          WHERE X.APPR_NO = Y.APPR_NO
            AND X.COMPANY_CD = Y.COMPANY_CD
            AND X.COMPANY_CD = #{companyCd}
          <if test="userId != null &amp;&amp; userId != ''">
            AND UPPER(Y.USER_ID) = UPPER(#{userId})
          </if>
        <if test="fCheckR != null &amp;&amp; fCheckR != ''">
          <if test='fCheckR == "N"'>
            AND Y.FLOW_STS <![CDATA[ <> ]]> 'A'
            AND Y.APPR_DIV = 'NT'
            AND Y.FLOW_TRAN = 'P'
            AND Y.FLOW_STS = 'Z'
          </if>
          <if test='fCheckR == "Y"'>
            AND Y.FLOW_STS <![CDATA[ <> ]]> 'A'
            AND Y.APPR_DIV = 'NT'
            AND Y.FLOW_TRAN = 'C'
            AND Y.FLOW_STS = 'F'
          </if>
        </if>
        <if test="apprStartYmd != null &amp;&amp; apprStartYmd != ''">
          <if test="apprEndYmd != null &amp;&amp; apprEndYmd != ''">
            AND X.APPR_YMD <![CDATA[ >= ]]> #{apprStartYmd}
            AND X.APPR_YMD <![CDATA[ <= ]]> #{apprEndYmd}
          </if>
        </if>
        <if test="apprSumitStartYmd != null &amp;&amp; apprSumitStartYmd != ''">
          <if test="apprSumitEndYmd != null &amp;&amp; apprSumitEndYmd != ''">
            AND Y.APPR_YMD <![CDATA[ >= ]]> #{apprSumitStartYmd}
            AND Y.APPR_YMD <![CDATA[ <= ]]> #{apprSumitEndYmd}
          </if>
        </if>
        <if test="fApprNo != null &amp;&amp; fApprNo != ''">
            AND X.APPR_NO = #{fApprNo}
        </if>
        <if test="fApprNm != null &amp;&amp; fApprNm != ''">
            AND UPPER(X.TITLE) LIKE '%' + UPPER(#{fApprNm}) + '%'
        </if>
        <if test="fApprSts != null &amp;&amp; fApprSts != ''">
            AND X.APPR_STS IN (${fApprSts})
        </if>
        <if test="fApprSts != null &amp;&amp; fApprSts != ''">
            AND X.APPR_STS IN (${fApprSts})
        </if>
        <if test="fDutyNo != null &amp;&amp; fDutyNo != ''">
            AND X.DUTY_NO = #{fDutyNo}
            AND Y.APPR_SEQ_NO <![CDATA[ <> ]]> '999'
        </if>
        <if test="fApprTp != null &amp;&amp; fApprTp != ''">
            AND X.APPR_TP IN (${fApprTp})
        </if>
          ORDER BY Y.FNL_EDIT_DT , Y.APPR_FLOW_NO , X.APPR_NO DESC
    </select>

    <select id="retrieveAF0301SubList" parameterType="map" resultType="map" >
        <![CDATA[ /* af0301.retrieveAF0301SubList */ ]]>
        SELECT
               X.APPR_SEQ_NO
             , dbo.FN_NAME(X.FLOW_STS, 'FLOW_STS') FLOW_STS
             , X.APPR_YMD + ' ' + LEFT(ISNULL(X.APPR_TIME,'00'),2) + ':' + RIGHT(ISNULL(X.APPR_TIME,'00'),2) APPR_YMD
			 , CASE WHEN X.APPR_SEQ_NO = 0 THEN dbo.FN_NAME(X.FLOW_STS, 'FLOW_STS') ELSE dbo.FN_NAME(X.APPR_DIV, 'APPR_DIV') END APPR_DIV
             , X.USER_ID  + ' / ' +  dbo.FN_NAME(X.USER_ID, 'USER')  + ' / ' +
               (SELECT dbo.FN_NAME(A.ORG_CD, 'DEPT')
                  FROM SC_USER A
                 WHERE A.USER_ID = X.USER_ID AND A.COMPANY_CD = #{companyCd}) FLOW_USER_INFO
             , X.APPR_DESC
             , X.USER_ID
             , X.APPR_FLOW_NO
             , X.COMPANY_CD
          FROM AF0101D X
         WHERE X.APPR_NO = #{apprNo}
           AND X.COMPANY_CD = #{companyCd}
           AND X.APPR_SEQ_NO <![CDATA[ <> ]]> '999'
         ORDER BY X.APPR_SEQ_NO, X.USER_ID
    </select>

    <update id="confirmAF0301List" parameterType="map" >
        <![CDATA[ /* af0301.confirmAF0301List */ ]]>
        UPDATE AF0101D
          SET
              FLOW_TRAN        = 'C'
            , FLOW_STS         = 'F'
            , APPR_USER_ID     = #{apprUserId}
            , APPR_YMD         = CONVERT(VARCHAR, GETDATE(), 23)
            , APPR_TIME        = REPLACE(CONVERT(CHAR(5), GETDATE(), 24),':','')
            , FNL_EDIT_DT      = GETDATE()
            , FNL_EDIT_USER_ID = #{fnlEditUserId}
        WHERE APPR_FLOW_NO = #{apprFlowNo}
          AND COMPANY_CD = #{companyCd}
          AND FLOW_TRAN = 'P'
    </update>
</mapper>