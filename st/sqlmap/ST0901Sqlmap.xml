<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--************************************************************************************
* Program Name : 점검데이터작성
* Description : 점검데이터작성
* Author : jit13
* Created Date :
* SQL 목록
***************************************************************************************
* SQLID                 설명
***************************************************************************************
* retrieveST0801     : 점검데이터 목록 조회
*************************************************************************************-->
<mapper namespace="st0901">
    <select id="retrieveST0901List" parameterType="map" resultType="map" >
        <![CDATA[ /* st0901.retrieveST0901List */ ]]>
        SELECT EQ_LOC_MDM
	, Z.LineCode EQ_LOC
    , (SELECT CLS_NM FROM EQ0201M WHERE CLS_CD = EQ_LOC_MDM AND COMPANY_CD = #{companyCd}) EQ_LOC_NM
    , ISNULL(CONVERT(INT, COUNT(EQ_NO)),0) FAILURE_CNT    -- 고장건수
    , ISNULL(CONVERT(INT, SUM(REPAIR_HOUR)),0) REPAIR_HOUR    -- 수리시간
    , ISNULL(CONVERT(INT, SUM(BROKEN_HOUR)),0) BROKEN_HOUR    -- 정지시간
    , ISNULL(CONVERT(INT, (SELECT ROUND(SUM(CYCLETIME) / 60,0) FROM EQ0901W W2 WHERE W2.LOCATIONID = EQ_LOC_MDM AND W2.EVENTDATE BETWEEN #{fStartDate} AND #{fEndDate})),0) WORK_HOUR -- 가동시간
    , ISNULL(CONVERT(INT, ROUND(SUM(REPAIR_HOUR) / COUNT(EQ_NO),0)),0) MTTR  -- MTTR
    , ISNULL(CONVERT(INT, ROUND((SELECT ROUND(SUM(CYCLETIME) / 60,0) FROM EQ0901W W2 WHERE W2.LOCATIONID = EQ_LOC_MDM AND W2.EVENTDATE BETWEEN #{fStartDate} AND #{fEndDate}) / COUNT(EQ_NO) / 60,0)),0) MTBF   -- MTBF
    , ISNULL(CONVERT(INT, SUM(USER_COST)),0) USER_AMT        -- 총인건비
    , ISNULL(CONVERT(INT, SUM(USER_COST)),0) + ISNULL(CONVERT(INT, SUM(MAT_COST)),0) REPAIR_AMT    -- 총수리비
       FROM
  (
   SELECT CASE WHEN C.cls_lvl = '7' THEN C.CLS_CD
                        WHEN C8.cls_lvl = '7' THEN C8.CLS_CD
                        WHEN C7.cls_lvl = '7' THEN C7.CLS_CD
                        ELSE NULL
                 END EQ_LOC_MDM
                 , W1.EQ_NO
          , DATEDIFF(MINUTE, CONVERT(CHAR(16), CONVERT(VARCHAR, W1.START_YMD + ' ' + W1.START_TIME + ':00', 120), 120), CONVERT(CHAR(16), CONVERT(VARCHAR, W1.END_YMD + ' ' +W1.END_TIME + ':00', 120), 120)) REPAIR_HOUR
          , DATEDIFF(MINUTE, CONVERT(CHAR(16), CONVERT(VARCHAR, W1.BROKEN_START_YMD + ' ' + W1.BROKEN_START_TIME + ':00', 120), 120), CONVERT(CHAR(16), CONVERT(VARCHAR, W1.BROKEN_END_YMD + ' ' +W1.BROKEN_END_TIME + ':00', 120), 120))  BROKEN_HOUR
          , USER_COST USER_COST
          , MAT_COST MAT_COST
          , B.FACTORY_CODE
     from WO0201M W1
                 JOIN EQ0101M B
                   ON W1.EQ_NO = B.EQ_NO
                 LEFT JOIN eq0201m C
                   ON B.EQ_LOC = C.CLS_CD
                  AND C.EQ_CLS = 'EQ_LOC'
                  AND C.CLS_LVL >= '7'
                 LEFT JOIN eq0201m C8
                   ON C8.cls_cd = C.prnt_cls_cd
                  AND C8.CLS_LVL >= '7'
                 LEFT JOIN eq0201m C7
                   ON C7.cls_cd = C8.prnt_cls_cd
                  AND C7.CLS_LVL >= '7'
                 OUTER APPLY(
                      SELECT SUM(USER_COST) USER_COST FROM WO0302C W3 WHERE W3.WO_NO = W1.WO_NO
                 )USER_COST
                 OUTER APPLY(
                  SELECT SUM(X.USE_QTY * Y.UNIT_COST) MAT_COST
            FROM WO0301P X
            INNER JOIN PT0101M Y ON X.PLANT_CODE = Y.PLANT_CODE AND X.FACTORY_CODE = Y.FACTORY_CODE AND X.PART_CD = Y.PART_CD
            WHERE X.WO_NO = W1.WO_NO) MAT_COST

       WHERE W1.END_YMD <![CDATA[ >= ]]> #{fStartDate}
         AND W1.END_YMD <![CDATA[ <= ]]> #{fEndDate}
         AND W1.WO_STS = 'YZ'
         <if test="fWoTp != null &amp;&amp; fWoTp != ''">
			AND W1.WO_TP IN (${fWoTp})
         </if>
      AND B.EQ_LOC IS NOT NULL
         AND B.PLANT_CODE = #{plantCode}
         AND B.FACTORY_CODE = #{factoryCode}
         AND B.EQ_STS = '1'
         AND ISNULL(B.EQ_PRCS,'') > ''
       ) E
       INNER JOIN EQ0201L Z
		ON E.FACTORY_CODE = Z.FactoryCode
		AND E.EQ_LOC_MDM = Z.LineID
		GROUP BY EQ_LOC_MDM, Z.LineCode
		</select>
</mapper>