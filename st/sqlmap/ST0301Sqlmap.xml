<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--************************************************************************************
* Program Name : 작업오더집계작성
* CHART_NM : 작업오더집계작성
* Author : jit13
* Created Date :
* SQL 목록
***************************************************************************************
* SQLID                 설명
***************************************************************************************
* retrieveMT0301     : 작업오더집계 목록 조회
*************************************************************************************-->
<mapper namespace="st0301">
    <!-- 작업오더집계작성 조회 -->
    <select id="retrieveST0301Chart" parameterType="map" resultType="map" >
        <![CDATA[ /* st0301.retrieveST0301Chart */ ]]>
        <if test='fcon == "A"'>
        SELECT
               '"' + dbo.FN_NAME(REQ_ORG_CD,'DEPT') + '"'  CHART_NM
             , ETC_WO_COUNT
             , OH_COUNT
             , ETC_COUNT
         FROM (
               SELECT
                      Z.REQ_ORG_CD
                    , SUM(CASE WHEN X.PJT_CD = NULL THEN 1 ELSE 0 END) ETC_WO_COUNT
					, SUM(CASE WHEN Y.OH_PJT_YN = 'Y' THEN 1 ELSE 0 END) OH_COUNT
					, SUM(CASE WHEN X.OUTSRC_YN = 'Y' THEN 1 ELSE 0 END) ETC_COUNT
                    , SUM(CASE WHEN X.PJT_CD = NULL THEN 1 ELSE 0 END) + SUM(CASE WHEN Y.OH_PJT_YN = 'Y' THEN 1 ELSE 0 END) + SUM(CASE WHEN X.OUTSRC_YN = 'Y' THEN 1 ELSE 0 END) TOTAL_COUNT
                 FROM WO0201M X
				 LEFT OUTER JOIN PT0902M Y ON (Y.PJT_CD = X.PJT_CD)
				 LEFT OUTER JOIN WO0101M Z ON (Z.REQ_NO = X.REQ_NO)
                WHERE Z.REQ_ORG_CD IS NOT NULL
                <if test="fStartDate != null &amp;&amp; fStartDate != ''">
                  AND X.PLAN_START_YMD <![CDATA[ >= ]]> #{fStartDate}
                </if>
                <if test="fEndDate != null &amp;&amp; fEndDate != ''">
                  AND X.PLAN_END_YMD   <![CDATA[ <= ]]> #{fEndDate}
                </if>
                  AND X.WO_STS = 'YZ'
                GROUP BY Z.REQ_ORG_CD
              ) A
        </if>
        <if test='fcon == "B"'>
        SELECT
               '"' + dbo.FN_NAME(PLAN_ORG_CD,'DEPT') + '"' CHART_NM
             , ETC_WO_COUNT
             , ETC_COUNT
          FROM (
                SELECT
                       X.PLAN_ORG_CD
                     , SUM(CASE WHEN X.PJT_CD = NULL THEN 1 ELSE 0 END) ETC_WO_COUNT
					 , SUM(CASE WHEN Y.OH_PJT_YN = 'Y' THEN 1 ELSE 0 END) OH_COUNT
					 , SUM(CASE WHEN X.OUTSRC_YN = 'Y' THEN 1 ELSE 0 END) ETC_COUNT
                     , SUM(CASE WHEN X.PJT_CD = NULL THEN 1 ELSE 0 END) + SUM(CASE WHEN Y.OH_PJT_YN = 'Y' THEN 1 ELSE 0 END) + SUM(CASE WHEN X.OUTSRC_YN = 'Y' THEN 1 ELSE 0 END) TOTAL_COUNT
                  FROM WO0201M  X
                  LEFT OUTER JOIN PT0902M Y ON (Y.PJT_CD = X.PJT_CD)
                 WHERE X.PLAN_ORG_CD IS NOT NULL
                <if test="fStartDate != null &amp;&amp; fStartDate != ''">
                   AND X.PLAN_START_YMD <![CDATA[ >= ]]> #{fStartDate}
                </if>
                <if test="fEndDate != null &amp;&amp; fEndDate != ''">
                   AND X.PLAN_END_YMD   <![CDATA[ <= ]]> #{fEndDate}
                </if>
                   AND X.WO_STS = 'YZ'
                 GROUP BY X.PLAN_ORG_CD
               ) A
        </if>
        <if test='fcon == "C"'>
        <if test="finputNo != null &amp;&amp; finputNo != ''">
        WITH T AS (
            SELECT EQ_NO, EQ_PRCS, REV_NO
        	  FROM EQ0101M
        	 WHERE EQ_NO = #{finputNo}
        	UNION ALL
           SELECT M.EQ_NO, M.EQ_PRCS, M.REV_NO
        	  FROM EQ0101M M JOIN T N ON M.EQ_PRCS = N.EQ_NO
        )
        </if>
        SELECT
               '"' + dbo.FN_NAME(EQ_NO,'EQUIP') + '"'  CHART_NM
             , ETC_WO_COUNT
             , ETC_COUNT
          FROM (
                SELECT
                       X.EQ_NO EQ_NO
                     , SUM(CASE WHEN X.PJT_CD = NULL THEN 1 ELSE 0 END) ETC_WO_COUNT
					 , SUM(CASE WHEN Y.OH_PJT_YN = 'Y' THEN 1 ELSE 0 END) OH_COUNT
					 , SUM(CASE WHEN X.OUTSRC_YN = 'Y' THEN 1 ELSE 0 END) ETC_COUNT
                     , SUM(CASE WHEN X.PJT_CD = NULL THEN 1 ELSE 0 END) + SUM(CASE WHEN Y.OH_PJT_YN = 'Y' THEN 1 ELSE 0 END) + SUM(CASE WHEN X.OUTSRC_YN = 'Y' THEN 1 ELSE 0 END) TOTAL_COUNT
                  FROM WO0201M X
                  LEFT OUTER JOIN PT0902M Y ON (Y.PJT_CD = X.PJT_CD)
                 WHERE X.EQ_NO IS NOT NULL
                  <if test="finputNo != null &amp;&amp; finputNo != ''">
                   AND X.EQ_NO IN (
                        SELECT EQ_NO FROM T WHERE REV_NO = #{revNo}
                   )
                  </if>
               <if test="fStartDate != null &amp;&amp; fStartDate != ''">
                   AND X.PLAN_START_YMD <![CDATA[ >= ]]> #{fStartDate}
               </if>
               <if test="fEndDate != null &amp;&amp; fEndDate != ''">
                   AND X.PLAN_END_YMD   <![CDATA[ <= ]]> #{fEndDate}
               </if>
                   AND X.WO_STS = 'YZ'
                 GROUP BY  X.EQ_NO
               ) X
        </if>
        <if test='fcon == "D"'>
        SELECT
               '"' + dbo.FN_NAME(REQ_USER_ID,'USER') + '"'  CHART_NM
             , ETC_WO_COUNT
             , ETC_COUNT
          FROM (
                SELECT
                       W.REQ_USER_ID
                     , SUM(CASE WHEN X.PJT_CD = NULL THEN 1 ELSE 0 END) ETC_WO_COUNT
					 , SUM(CASE WHEN Y.OH_PJT_YN = 'Y' THEN 1 ELSE 0 END) OH_COUNT
					 , SUM(CASE WHEN X.OUTSRC_YN = 'Y' THEN 1 ELSE 0 END) ETC_COUNT
                     , SUM(CASE WHEN X.PJT_CD = NULL THEN 1 ELSE 0 END) + SUM(CASE WHEN Y.OH_PJT_YN = 'Y' THEN 1 ELSE 0 END) + SUM(CASE WHEN X.OUTSRC_YN = 'Y' THEN 1 ELSE 0 END) TOTAL_COUNT
                  FROM WO0201M  X
                  LEFT OUTER JOIN PT0902M Y ON (Y.PJT_CD = X.PJT_CD)
                  LEFT OUTER JOIN WO0101M W ON (W.REQ_NO = X.REQ_NO)
                 INNER JOIN  SC_USER Z ON (Z.USER_ID = W.REQ_USER_ID)
                 WHERE X.EQ_NO IS NOT NULL
                <if test="finputNo != null &amp;&amp; finputNo != ''">
                   AND W.REQ_USER_ID = #{finputNo}
                </if>
                <if test="fStartDate != null &amp;&amp; fStartDate != ''">
                   AND X.PLAN_START_YMD <![CDATA[ >= ]]> #{fStartDate}
                </if>
                <if test="fEndDate != null &amp;&amp; fEndDate != ''">
                   AND X.PLAN_END_YMD   <![CDATA[ <= ]]> #{fEndDate}
                </if>
                   AND X.WO_STS = 'YZ'
                 GROUP BY W.REQ_USER_ID
               ) X
        </if>
    </select>

    <select id="retrieveST0301List" parameterType="map" resultType="map" >
        <![CDATA[ /* st0301.retrieveST0301List */ ]]>
        <if test='fcon == "A"'>
        SELECT
               REQ_ORG_CD CHART_CD
             , dbo.FN_NAME(REQ_ORG_CD,'DEPT') CHART_NM
             , ETC_WO_COUNT
             , ROUND(100*ETC_WO_COUNT / CASE WHEN TOTAL_COUNT = 0 THEN 1 ELSE TOTAL_COUNT END,1) ETC_WO_RATE
             , ETC_COUNT
             , ROUND(100*ETC_COUNT / CASE WHEN TOTAL_COUNT = 0 THEN 1 ELSE TOTAL_COUNT END,1) ETC_RATE
             , TOTAL_COUNT
          FROM (
                SELECT
                       Z.REQ_ORG_CD
                     , SUM(CASE WHEN X.PJT_CD = NULL THEN 1 ELSE 0 END) ETC_WO_COUNT
                     , SUM(CASE WHEN Y.OH_PJT_YN = 'Y' THEN 1 ELSE 0 END) OH_COUNT
                     , SUM(CASE WHEN X.OUTSRC_YN = 'Y' THEN 1 ELSE 0 END) ETC_COUNT
                     , SUM(CASE WHEN X.PJT_CD = NULL THEN 1 ELSE 0 END) + SUM(CASE WHEN Y.OH_PJT_YN = 'Y' THEN 1 ELSE 0 END) + SUM(CASE WHEN X.OUTSRC_YN = 'Y' THEN 1 ELSE 0 END) TOTAL_COUNT
                  FROM WO0201M X
                  LEFT OUTER JOIN PT0902M Y ON (Y.PJT_CD = X.PJT_CD)
                  LEFT OUTER JOIN WO0101M Z ON (Z.REQ_NO = X.REQ_NO)
                 WHERE Z.REQ_ORG_CD IS NOT NULL
               <if test="fStartDate != null &amp;&amp; fStartDate != ''">
                   AND X.PLAN_START_YMD <![CDATA[ >= ]]> #{fStartDate}
               </if>
               <if test="fEndDate != null &amp;&amp; fEndDate != ''">
                   AND X.PLAN_END_YMD   <![CDATA[ <= ]]> #{fEndDate}
               </if>
                   AND X.WO_STS = 'YZ'
                 GROUP BY  Z.REQ_ORG_CD
               ) A
        </if>
        <if test='fcon == "B"'>
        SELECT
               PLAN_ORG_CD CHART_CD
             , dbo.FN_NAME(PLAN_ORG_CD,'DEPT') CHART_NM
             , ETC_WO_COUNT
             , ROUND(100*ETC_WO_COUNT / CASE WHEN TOTAL_COUNT = 0 THEN 1 ELSE TOTAL_COUNT END,1) ETC_WO_RATE
             , ETC_COUNT
             , ROUND(100*ETC_COUNT / CASE WHEN TOTAL_COUNT = 0 THEN 1 ELSE TOTAL_COUNT END,1) ETC_RATE
             , TOTAL_COUNT
          FROM (
                SELECT
                       X.PLAN_ORG_CD
                     , SUM(CASE WHEN X.PJT_CD = NULL THEN 1 ELSE 0 END) ETC_WO_COUNT
                     , SUM(CASE WHEN Y.OH_PJT_YN = 'Y' THEN 1 ELSE 0 END) OH_COUNT
                     , SUM(CASE WHEN X.OUTSRC_YN = 'Y' THEN 1 ELSE 0 END) ETC_COUNT
                     , SUM(CASE WHEN X.PJT_CD = NULL THEN 1 ELSE 0 END) + SUM(CASE WHEN Y.OH_PJT_YN = 'Y' THEN 1 ELSE 0 END) + SUM(CASE WHEN X.OUTSRC_YN = 'Y' THEN 1 ELSE 0 END) TOTAL_COUNT
                  FROM WO0201M  X
                  LEFT OUTER JOIN PT0902M Y ON (Y.PJT_CD = X.PJT_CD)
                 WHERE X.PLAN_ORG_CD IS NOT NULL
               <if test="fStartDate != null &amp;&amp; fStartDate != ''">
                   AND X.PLAN_START_YMD <![CDATA[ >= ]]> #{fStartDate}
               </if>
               <if test="fEndDate != null &amp;&amp; fEndDate != ''">
                   AND X.PLAN_END_YMD   <![CDATA[ <= ]]> #{fEndDate}
               </if>
                   AND X.WO_STS = 'YZ'
                 GROUP BY X.PLAN_ORG_CD
               ) A
        </if>
        <if test='fcon == "C"'>
        <if test="finputNo != null &amp;&amp; finputNo != ''">
        WITH T AS (
            SELECT EQ_NO, EQ_PRCS, REV_NO
        	  FROM EQ0101M
        	 WHERE EQ_NO = #{finputNo}
        	UNION ALL
           SELECT M.EQ_NO, M.EQ_PRCS, M.REV_NO
        	  FROM EQ0101M M JOIN T N ON M.EQ_PRCS = N.EQ_NO
        )
        </if>
        SELECT (
                SELECT
                       EQ_NO FROM EQ0101M WHERE EQ_NO=X.EQ_NO AND REV_NO = #{revNo}) CHART_CD
                     , dbo.FN_NAME(X.EQ_NO,'EQUIP') CHART_NM
                     , ETC_WO_COUNT
                     , ROUND(100*ETC_WO_COUNT / CASE WHEN TOTAL_COUNT = 0 THEN 1 ELSE TOTAL_COUNT END, 1) ETC_WO_RATE
                     , ETC_COUNT
                     , ROUND(100*ETC_COUNT / CASE WHEN TOTAL_COUNT = 0 THEN 1 ELSE TOTAL_COUNT END, 1) ETC_RATE
                     , TOTAL_COUNT
                     , X.EQ_NO
                  FROM (
                        SELECT
                               X.EQ_NO EQ_NO
                             , SUM(CASE WHEN X.PJT_CD = NULL THEN 1 ELSE 0 END) ETC_WO_COUNT
                             , SUM(CASE WHEN Y.OH_PJT_YN = 'Y' THEN 1 ELSE 0 END) OH_COUNT
                             , SUM(CASE WHEN X.OUTSRC_YN = 'Y' THEN 1 ELSE 0 END) ETC_COUNT
                             , SUM(CASE WHEN X.PJT_CD = NULL THEN 1 ELSE 0 END) + SUM(CASE WHEN Y.OH_PJT_YN = 'Y' THEN 1 ELSE 0 END) + SUM(CASE WHEN X.OUTSRC_YN = 'Y' THEN 1 ELSE 0 END) TOTAL_COUNT
                          FROM WO0201M X
                          LEFT OUTER JOIN PT0902M Y ON (Y.PJT_CD = X.PJT_CD)
                         WHERE X.EQ_NO IS NOT NULL
                        <if test="finputNo != null &amp;&amp; finputNo != ''">
                           AND X.EQ_NO IN (
                               SELECT EQ_NO FROM T WHERE REV_NO = #{revNo}
                           )
                        </if>
                        <if test="fStartDate != null &amp;&amp; fStartDate != ''">
                           AND X.PLAN_START_YMD <![CDATA[ >= ]]> #{fStartDate}
                        </if>
                        <if test="fEndDate != null &amp;&amp; fEndDate != ''">
                           AND X.PLAN_END_YMD   <![CDATA[ <= ]]> #{fEndDate}
                        </if>
                           AND X.WO_STS = 'YZ'
                         GROUP BY X.EQ_NO
                       ) X
                 WHERE TOTAL_COUNT !='0'
        </if>
        <if test='fcon == "D"'>
        SELECT
               X.REQ_USER_ID CHART_CD
             , dbo.FN_NAME(X.REQ_USER_ID,'USER') CHART_NM
             , ETC_WO_COUNT
             , ROUND(100*ETC_WO_COUNT / CASE WHEN TOTAL_COUNT = 0 THEN 1 ELSE TOTAL_COUNT END, 1) ETC_WO_RATE
             , ETC_COUNT
             , ROUND(100*ETC_COUNT / CASE WHEN TOTAL_COUNT = 0 THEN 1 ELSE TOTAL_COUNT END, 1)  ETC_RATE
             , TOTAL_COUNT
             , X.REQ_USER_ID
          FROM (
                SELECT
                       W.REQ_USER_ID
                     , SUM(CASE WHEN X.PJT_CD = NULL THEN 1 ELSE 0 END) ETC_WO_COUNT
                             , SUM(CASE WHEN Y.OH_PJT_YN = 'Y' THEN 1 ELSE 0 END) OH_COUNT
                             , SUM(CASE WHEN X.OUTSRC_YN = 'Y' THEN 1 ELSE 0 END) ETC_COUNT
                             , SUM(CASE WHEN X.PJT_CD = NULL THEN 1 ELSE 0 END) + SUM(CASE WHEN Y.OH_PJT_YN = 'Y' THEN 1 ELSE 0 END) + SUM(CASE WHEN X.OUTSRC_YN = 'Y' THEN 1 ELSE 0 END) TOTAL_COUNT
                  FROM WO0201M  X
                  LEFT OUTER JOIN PT0902M Y ON (Y.PJT_CD = X.PJT_CD)
                  LEFT OUTER JOIN WO0101M W ON (W.REQ_NO = X.REQ_NO)
                 INNER JOIN  SC_USER Z ON (Z.USER_ID = W.REQ_USER_ID)
                 WHERE X.EQ_NO IS NOT NULL
                <if test="finputNo != null &amp;&amp; finputNo != ''">
                   AND W.REQ_USER_ID = #{finputNo}
                </if>
                <if test="fStartDate != null &amp;&amp; fStartDate != ''">
                 AND X.PLAN_START_YMD <![CDATA[ >= ]]> #{fStartDate}
                </if>
                <if test="fEndDate != null &amp;&amp; fEndDate != ''">
                 AND X.PLAN_END_YMD   <![CDATA[ <= ]]> #{fEndDate}
                </if>
                 AND X.WO_STS = 'YZ'
               GROUP BY W.REQ_USER_ID
               ) X
        </if>
    </select>

    <select id="retrieveST0301SubList" parameterType="map" resultType="map" >
        <![CDATA[ /* st0301.retrieveST0301SubList */ ]]>
        SELECT
               X.WO_NO
             , X.WO_NM
             , dbo.FN_NAME(X.WO_TP ,'WO_TP') WO_TP_NM
             , dbo.FN_NAME(X.WO_STS, 'WO_STS') WO_STS_NM
             , dbo.FN_NAME(X.PLAN_ORG_CD, 'DEPT') PLAN_ORG_CD_NM
             , dbo.FN_NAME(X.PLAN_USER_ID, 'USER') PLAN_USER_NM
             , Y.EQ_NO
             , Y.EQ_NM
             , X.PLAN_START_YMD
             , X.PLAN_END_YMD
             , X.START_YMD
             , X.END_YMD
             , X.REQ_NO
             , X.EQ_NO
          FROM WO0201M X
         INNER JOIN EQ0101M Y ON (Y.EQ_NO = X.EQ_NO)
          LEFT OUTER JOIN PT0902M Z ON (Z.PJT_CD = X.PJT_CD)
          LEFT OUTER JOIN WO0101M S ON (S.REQ_NO = X.REQ_NO)
         WHERE Y.REV_NO = #{revNo}
           AND X.PJT_CD IS NULL
        <if test="chartCd != null &amp;&amp; chartCd != ''">
           AND UPPER(${whereCon}) = UPPER(#{chartCd})
        </if>
        <if test="fStartDate != null &amp;&amp; fStartDate != ''">
           AND X.PLAN_START_YMD <![CDATA[ >= ]]> #{fStartDate}
        </if>
        <if test="fEndDate != null &amp;&amp; fEndDate != ''">
           AND X.PLAN_END_YMD <![CDATA[ <= ]]> #{fEndDate}
        </if>
           AND X.WO_STS = 'YZ'
    </select>
</mapper>