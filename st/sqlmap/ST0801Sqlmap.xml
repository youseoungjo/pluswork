<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--************************************************************************************
* Program Name : 점검데이터작성
* Description : 점검데이터작성
* Author : jit13
* Created Date :
* SQL 목록
***************************************************************************************
* SQLID                 설명
***************************************************************************************
* retrieveST0801     : 점검데이터 목록 조회
*************************************************************************************-->
<mapper namespace="st0801">
    <select id="retrieveST0801List" parameterType="map" resultType="map" >
        <![CDATA[ /* st0801.retrieveST0801List */ ]]>
        SELECT EQ_LINE AS EQ_NO
	         , SUM(TOTAL_CNT) AS TOTAL_CNT
	         , SUM(TOTAL_TIME) AS TOTAL_TIME
	         , SUM(TOTAL_AMT) AS TOTAL_AMT
	         , SUM(EM_CNT) AS EM_CNT
	         , SUM(EM_TIME) AS EM_TIME
	         , SUM(EM_AMT) AS EM_AMT
	         , SUM(BM_CNT) AS BM_CNT
	         , SUM(BM_TIME) AS BM_TIME
	         , SUM(BM_AMT) AS BM_AMT
	         , SUM(PM_CNT) AS PM_CNT
	         , SUM(PM_TIME) AS PM_TIME
	         , SUM(PM_AMT) AS PM_AMT
	         , SUM(CM_CNT) AS CM_CNT
	         , SUM(CM_TIME) AS CM_TIME
	         , SUM(CM_AMT) AS CM_AMT
	         , SUM(GM_CNT) AS GM_CNT
	         , SUM(GM_TIME) AS GM_TIME
	         , SUM(GM_AMT) AS GM_AMT
	         , ISNULL((SELECT CLS_NM FROM EQ0201M WHERE CLS_CD = EQ_LINE AND CLS_TYPE = 'E' AND EQ_CLS = 'EQ_PRCS' AND COMPANY_CD = #{companyCd}), '합계') AS EQ_NM
          FROM(
                SELECT X.EQ_NO
			         , DBO.FN_NAME(X.EQ_NO, 'EQ_LINE') AS EQ_LINE
                     , SUM(1) TOTAL_CNT
                     , SUM(DATEDIFF(MINUTE, CONVERT(CHAR(19), START_YMD + ' ' + START_TIME + ':00', 120), CONVERT(CHAR(19), END_YMD + ' ' + END_TIME + ':00', 120))) AS TOTAL_TIME
                     , SUM( ISNULL(Y.PT_COST,0)  + ISNULL(Y.LABOR_COST, 0) + ISNULL(Y.ETC_COST, 0)) TOTAL_AMT
                     , SUM(CASE Y.WO_TP WHEN 'WT01' THEN 1 ELSE 0 END) EM_CNT
                     , SUM(CASE Y.WO_TP WHEN 'WT01' THEN DATEDIFF(MINUTE, CONVERT(CHAR(19), START_YMD + ' ' + START_TIME + ':00', 120), CONVERT(CHAR(19), END_YMD + ' ' + END_TIME + ':00', 120)) ELSE 0 END ) EM_TIME
                     , SUM(CASE Y.WO_TP WHEN 'WT01' THEN ISNULL(Y.PT_COST,0) + ISNULL(Y.LABOR_COST, 0) + ISNULL(Y.ETC_COST, 0) ELSE 0 END) EM_AMT
                     , SUM(CASE Y.WO_TP WHEN 'WT02' THEN 1 ELSE 0 END) BM_CNT
                     , SUM(CASE Y.WO_TP WHEN 'WT02' THEN DATEDIFF(MINUTE, CONVERT(CHAR(19), START_YMD + ' ' + START_TIME + ':00', 120), CONVERT(CHAR(19), END_YMD + ' ' + END_TIME + ':00', 120)) ELSE 0 END ) BM_TIME
                     , SUM(CASE Y.WO_TP WHEN 'WT02' THEN ISNULL(Y.PT_COST,0)    + ISNULL(Y.LABOR_COST, 0) + ISNULL(Y.ETC_COST, 0) ELSE 0 END ) BM_AMT
                     , SUM(CASE Y.WO_TP WHEN 'WT03' THEN 1 ELSE 0 END) PM_CNT
                     , SUM(CASE Y.WO_TP WHEN 'WT03' THEN DATEDIFF(MINUTE, CONVERT(CHAR(19), START_YMD + ' ' + START_TIME + ':00', 120), CONVERT(CHAR(19), END_YMD + ' ' + END_TIME + ':00', 120)) ELSE 0 END ) PM_TIME
                     , SUM(CASE Y.WO_TP WHEN 'WT03' THEN ISNULL(Y.PT_COST,0) + ISNULL(Y.LABOR_COST, 0) + ISNULL(Y.ETC_COST, 0) ELSE 0 END) PM_AMT
                     , SUM(CASE Y.WO_TP WHEN 'WT04' THEN 1 ELSE 0 END) CM_CNT
                     , SUM(CASE Y.WO_TP WHEN 'WT04' THEN DATEDIFF(MINUTE, CONVERT(CHAR(19), START_YMD + ' ' + START_TIME + ':00', 120), CONVERT(CHAR(19), END_YMD + ' ' + END_TIME + ':00', 120)) ELSE 0 END ) CM_TIME
                     , SUM(CASE Y.WO_TP WHEN 'WT04' THEN ISNULL(Y.PT_COST,0) + ISNULL(Y.LABOR_COST, 0) + ISNULL(Y.ETC_COST, 0) ELSE 0 END) CM_AMT
                     , SUM(CASE Y.WO_TP WHEN 'WT05' THEN 1 ELSE 0 END) GM_CNT
                     , SUM(CASE Y.WO_TP WHEN 'WT05' THEN DATEDIFF(MINUTE, CONVERT(CHAR(19), START_YMD + ' ' + START_TIME + ':00', 120), CONVERT(CHAR(19), END_YMD + ' ' + END_TIME + ':00', 120)) ELSE 0 END ) GM_TIME
                     , SUM(CASE Y.WO_TP WHEN 'WT05' THEN ISNULL(Y.PT_COST,0) + ISNULL(Y.LABOR_COST, 0) + ISNULL(Y.ETC_COST, 0) ELSE 0 END) GM_AMT
                  FROM EQ0101M X
                 INNER JOIN WO0201M Y ON (X.EQ_NO = Y.EQ_NO AND X.COMPANY_CD = Y.COMPANY_CD)
                 WHERE Y.WO_STS = 'YZ'
                   AND X.REV_NO = #{revNo}
                   AND X.COMPANY_CD = #{companyCd}
                 <if test="fOrgCd != null &amp;&amp; fOrgCd != ''">
                   AND UPPER(Y.ORG_CD) = UPPER(#{fOrgCd})
                 </if>
                 <if test="fStartDate != null &amp;&amp; fStartDate != ''">
                   AND Y.START_YMD <![CDATA[ >= ]]> #{fStartDate}
                 </if>
                 <if test="fEndDate != null &amp;&amp; fEndDate != ''">
                   AND Y.START_YMD <![CDATA[ <= ]]> #{fEndDate}
                 </if>
                 GROUP BY GROUPING SETS ((X.EQ_NO),())
		 ) A
		 WHERE 1=1
           <if test="flineCd != null &amp;&amp; flineCd != ''">
           AND A.EQ_LINE IN (${flineCd})
           </if>
		 GROUP BY A.EQ_LINE
		 ORDER BY CASE WHEN A.EQ_LINE IS NULL THEN 1 ELSE 0 END, A.EQ_LINE ASC



    </select>

    <select id="retrieveST0801SubList" parameterType="map" resultType="map" >
        <![CDATA[ /* st0801.retrieveST0801SubList */ ]]>
        SELECT
               X.WO_NO
             , X.COMPANY_CD
             , X.WO_NM
             , dbo.FN_NAME(X.WO_TP,'WO_TP') WO_TP
             , dbo.FN_NAME(X.ORG_CD,'DEPT') ORG_NM
             , START_YMD
             , START_TIME
             , END_YMD
             , END_TIME
             , ISNULL(x.LABOR_COST, 0) LABOR_COST
             , ISNULL(X.ETC_COST, 0) ETC_COST
             , ISNULL(X.PT_COST,0) PT_COST
             , ISNULL(X.PT_COST,0) + ISNULL(X.LABOR_COST, 0) + ISNULL(X.ETC_COST, 0) TOTAL_COST
             , DATEDIFF(MINUTE, CONVERT(CHAR(19), START_YMD + ' ' + START_TIME + ':00', 120), CONVERT(CHAR(19), END_YMD + ' ' + END_TIME + ':00', 120)) TOTAL_TIME
          FROM WO0201M x
         WHERE 1=1
           AND X.WO_STS = 'YZ'
           AND X.COMPANY_CD = #{companyCd}
        <if test="fEqNo != null &amp;&amp; fEqNo != ''">
           AND DBO.FN_NAME(X.EQ_NO, 'EQ_LINE') = #{fEqNo} <!-- 설비별 행 클릭 시 있어야됨/ 종 합계 행 클릭 시 제거 -->
        </if>
        <if test="fWoTp != null &amp;&amp; fWoTp != ''">
           AND X.WO_TP = #{fWoTp}  <!-- EM:WT01/ BM:WT02/ PM:WT03/ CM:WT04/ GM:WT05 -->
        </if>
        <if test="flineCd != null &amp;&amp; flineCd != ''">
           AND DBO.FN_NAME(X.EQ_NO, 'EQ_LINE') = #{flineCd}
        </if>
        <if test="fStartDate != null &amp;&amp; fStartDate != ''">
           AND X.START_YMD <![CDATA[ >= ]]> #{fStartDate}
        </if>
        <if test="fEndDate != null &amp;&amp; fEndDate != ''">
           AND X.START_YMD <![CDATA[ <= ]]> #{fEndDate}
        </if>
        <if test="fOrgCd != null &amp;&amp; fOrgCd != ''">
           AND UPPER(X.ORG_CD) = UPPER(#{fOrgCd})
        </if>
         ORDER BY WO_NO DESC
    </select>
</mapper>