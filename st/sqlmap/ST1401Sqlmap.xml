<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--************************************************************************************
* Program Name : W/O 현황
* Description : W/O 현황
* Author : jit13
* Created Date :
* SQL 목록
***************************************************************************************
* SQLID                 설명
***************************************************************************************
* retrieveST1401     : W/O 현황 목록 조회
*************************************************************************************-->
<mapper namespace="st1401">
    <!-- 담당자별 W/O 현황 차트 조회 -->
    <select id="retrieveST1401Chart1" parameterType="map" resultType="map" >
        <![CDATA[ /* st1401.retrieveST1401Chart1 */ ]]>
        SELECT
                dbo.FN_NAME(WORK_USER_ID,'USER') WORK_USER_NM
              , EM_CNT
              , BM_CNT
              , PM_CNT
              , CM_CNT
              , GM_CNT
              , SUM(EM_CNT+BM_CNT+PM_CNT+CM_CNT+GM_CNT) AS TOTAL_CNT
              , WORK_MINUTE_DIFF
              , USER_COST
              , (SELECT TOP 1 COMM_CD_NM FROM SC_COMM_CD WHERE COMM_GRP_CD = 'WORK_HOUR') * (DATEDIFF(day, #{fStartDate}, #{fEndDate})+1) AS WORK_HOUR
              , ROUND((1.00 * WORK_MINUTE_DIFF) / ((SELECT TOP 1 COMM_CD_NM FROM SC_COMM_CD WHERE COMM_GRP_CD = 'WORK_HOUR') * (DATEDIFF(day, #{fStartDate}, #{fEndDate})+1)*60) * 100, 2) AS WORK_RATE
           FROM (
                  SELECT
                         X.WORK_USER_ID
                       , SUM(CASE WHEN Y.WO_TP = 'WT01' THEN 1 ELSE 0 END) EM_CNT
                       , SUM(CASE WHEN Y.WO_TP = 'WT02' THEN 1 ELSE 0 END) BM_CNT
                       , SUM(CASE WHEN Y.WO_TP = 'WT03' THEN 1 ELSE 0 END) PM_CNT
                       , SUM(CASE WHEN Y.WO_TP = 'WT04' THEN 1 ELSE 0 END) CM_CNT
                       , SUM(CASE WHEN Y.WO_TP = 'WT05' THEN 1 ELSE 0 END) GM_CNT
                       , ISNULL(SUM(X.USER_COST),0) USER_COST
                       , ISNULL(SUM(X.WORK_HOUR),0) AS WORK_MINUTE_DIFF
                    FROM WO0302C X
                   INNER JOIN WO0201M Y ON (X.WO_NO = Y.WO_NO AND X.COMPANY_CD = Y.COMPANY_CD)
                   WHERE Y.WO_STS ='YZ'
                    AND X.COMPANY_CD = #{companyCd}
                    AND Y.END_YMD <![CDATA[ >= ]]> #{fStartDate}
                    AND Y.END_YMD <![CDATA[ <= ]]> #{fEndDate}
                    <if test="fWoTp != null &amp;&amp; fWoTp != ''">
                    AND Y.WO_TP IN (${fWoTp})
                    </if>
                   GROUP BY X.WORK_USER_ID
                ) AS A
          GROUP BY WORK_USER_ID, EM_CNT, BM_CNT, PM_CNT, CM_CNT, GM_CNT, USER_COST, WORK_MINUTE_DIFF
    </select>

    <!-- 담당자별 W/O 현황 리스트 조회 -->
    <select id="retrieveST1401List1" parameterType="map" resultType="map" >
        <![CDATA[ /* st1401.retrieveST1401List1 */ ]]>
        SELECT
                dbo.FN_NAME(WORK_USER_ID,'USER') WORK_USER_NM
              , EM_CNT
              , BM_CNT
              , PM_CNT
              , CM_CNT
              , GM_CNT
              , SUM(EM_CNT+BM_CNT+PM_CNT+CM_CNT+GM_CNT) AS TOTAL_CNT
              , WORK_MINUTE_DIFF
              , USER_COST
              , (SELECT TOP 1 COMM_CD_NM FROM SC_COMM_CD WHERE COMM_GRP_CD = 'WORK_HOUR') * (DATEDIFF(day, #{fStartDate}, #{fEndDate})+1) AS WORK_HOUR
              , ROUND((1.00 * WORK_MINUTE_DIFF) / ((SELECT TOP 1 COMM_CD_NM FROM SC_COMM_CD WHERE COMM_GRP_CD = 'WORK_HOUR') * (DATEDIFF(day, #{fStartDate}, #{fEndDate})+1)*60) * 100, 2) AS WORK_RATE
           FROM (
                  SELECT
                         X.WORK_USER_ID
                       , SUM(CASE WHEN Y.WO_TP = 'WT01' THEN 1 ELSE 0 END) EM_CNT
                       , SUM(CASE WHEN Y.WO_TP = 'WT02' THEN 1 ELSE 0 END) BM_CNT
                       , SUM(CASE WHEN Y.WO_TP = 'WT03' THEN 1 ELSE 0 END) PM_CNT
                       , SUM(CASE WHEN Y.WO_TP = 'WT04' THEN 1 ELSE 0 END) CM_CNT
                       , SUM(CASE WHEN Y.WO_TP = 'WT05' THEN 1 ELSE 0 END) GM_CNT
                       , ISNULL(SUM(X.USER_COST),0) USER_COST
                       , ISNULL(SUM(X.WORK_HOUR),0) AS WORK_MINUTE_DIFF
                    FROM WO0302C X
                   INNER JOIN WO0201M Y ON (X.WO_NO = Y.WO_NO AND X.COMPANY_CD = Y.COMPANY_CD)
                   WHERE Y.WO_STS ='YZ'
                    AND X.COMPANY_CD = #{companyCd}
                    AND Y.END_YMD <![CDATA[ >= ]]> #{fStartDate}
                    AND Y.END_YMD <![CDATA[ <= ]]> #{fEndDate}
                   GROUP BY X.WORK_USER_ID
                ) AS A
          GROUP BY WORK_USER_ID, EM_CNT, BM_CNT, PM_CNT, CM_CNT, GM_CNT, USER_COST, WORK_MINUTE_DIFF
    </select>

    <!-- 요일별 W/O 현황 조회 -->
    <select id="retrieveST1401Chart2" parameterType="map" resultType="map" >
        <![CDATA[ /* st1401.retrieveST1401Chart2 */ ]]>
        SELECT
               CASE WHEN DAT.WEEKEND = '1' THEN '일요일'
                    WHEN DAT.WEEKEND = '2' THEN '월요일'
                    WHEN DAT.WEEKEND = '3' THEN '화요일'
                    WHEN DAT.WEEKEND = '4' THEN '수요일'
                    WHEN DAT.WEEKEND = '5' THEN '목요일'
                    WHEN DAT.WEEKEND = '6' THEN '금요일'
                    ELSE '토요일' END AS WEEKEND
             , ISNULL(EM_CNT,0) EM_CNT, ISNULL(BM_CNT,0) BM_CNT, ISNULL(PM_CNT,0) PM_CNT, ISNULL(CM_CNT,0) CM_CNT
             , ISNULL(EM_CNT,0) + ISNULL(BM_CNT,0) + ISNULL(PM_CNT,0) + ISNULL(CM_CNT,0) AS TOTAL_CNT
          FROM (
                 SELECT '1' AS WEEKEND
                 UNION ALL
                 SELECT '2'
                 UNION ALL
                 SELECT '3'
                 UNION ALL
                 SELECT '4'
                 UNION ALL
                 SELECT '5'
                 UNION ALL
                 SELECT '6'
                 UNION ALL
                 SELECT '7'
                ) AS DAT LEFT JOIN (
        			SELECT
        				  DATEPART(WEEKDAY,X.END_YMD) AS WEEKEND
        				, SUM(CASE WHEN X.WO_TP = 'WT01' THEN 1 ELSE 0 END) EM_CNT
        				, SUM(CASE WHEN X.WO_TP = 'WT02' THEN 1 ELSE 0 END) BM_CNT
        				, SUM(CASE WHEN X.WO_TP = 'WT03' THEN 1 ELSE 0 END) PM_CNT
        				, SUM(CASE WHEN X.WO_TP = 'WT04' THEN 1 ELSE 0 END) CM_CNT

        			FROM WO0201M X
        			WHERE X.WO_STS ='YZ'
        			  AND X.COMPANY_CD = #{companyCd}
                    <if test="fStartDate != null &amp;&amp; fStartDate != ''">
                      AND X.END_YMD <![CDATA[ >= ]]> #{fStartDate}
                    </if>
                    <if test="fEndDate != null &amp;&amp; fEndDate != ''">
                      AND X.END_YMD <![CDATA[ <= ]]> #{fEndDate}
                    </if>
                    <if test="fWoTp != null &amp;&amp; fWoTp != ''">
                    AND X.WO_TP IN (${fWoTp})
                    </if>
                    GROUP BY DATEPART(WEEKDAY,X.END_YMD)
                ) AS SOC
                ON DAT.WEEKEND = SOC.WEEKEND

    </select>

    <!-- 시간별 W/O 현황 차트 조회 -->
    <select id="retrieveST1401Chart3" parameterType="map" resultType="map" >
        <![CDATA[ /* st1401.retrieveST1401Chart3 */ ]]>
        SELECT DAT.HOUR, ISNULL(EM_CNT,0) AS EM_CNT, ISNULL(BM_CNT,0) AS BM_CNT, ISNULL(PM_CNT,0) AS PM_CNT, ISNULL(CM_CNT,0) AS CM_CNT
             , ISNULL(EM_CNT,0) + ISNULL(BM_CNT,0) + ISNULL(PM_CNT,0) + ISNULL(CM_CNT,0) AS TOTAL_CNT
          FROM (
          	SELECT '07' AS HOUR
          	UNION ALL
          	SELECT '08'
          	UNION ALL
          	SELECT '09'
          	UNION ALL
          	SELECT '10'
          	UNION ALL
          	SELECT '11'
          	UNION ALL
          	SELECT '12'
          	UNION ALL
          	SELECT '13'
          	UNION ALL
          	SELECT '14'
          	UNION ALL
          	SELECT '15'
          	UNION ALL
          	SELECT '16'
          	UNION ALL
          	SELECT '17'
          	UNION ALL
          	SELECT '18'
          	UNION ALL
          	SELECT '19'
          	UNION ALL
          	SELECT '20'
          	UNION ALL
          	SELECT '21'
          	UNION ALL
          	SELECT '22'
          	UNION ALL
          	SELECT '23'
          	UNION ALL
          	SELECT '00'
          	UNION ALL
          	SELECT '01'
          	UNION ALL
          	SELECT '02'
          	UNION ALL
          	SELECT '03'
          	UNION ALL
          	SELECT '04'
          	UNION ALL
          	SELECT '05'
          	UNION ALL
          	SELECT '06'

          	) AS DAT
          	LEFT JOIN
          		(
          			SELECT
          				  LEFT(X.END_TIME,2) AS HOUR
          				, SUM(CASE WHEN X.WO_TP = 'WT01' THEN 1 ELSE 0 END) EM_CNT
          				, SUM(CASE WHEN X.WO_TP = 'WT02' THEN 1 ELSE 0 END) BM_CNT
          				, SUM(CASE WHEN X.WO_TP = 'WT03' THEN 1 ELSE 0 END) PM_CNT
          				, SUM(CASE WHEN X.WO_TP = 'WT04' THEN 1 ELSE 0 END) CM_CNT
          				, SUM(CASE WHEN X.WO_TP = 'WT05' THEN 1 ELSE 0 END) GM_CNT

          			FROM WO0201M X
          			WHERE X.WO_STS ='YZ'
          			  AND X.COMPANY_CD = #{companyCd}
          			<if test="fStartDate != null &amp;&amp; fStartDate != ''">
                      AND X.END_YMD <![CDATA[ >= ]]> #{fStartDate}
                    </if>
                    <if test="fEndDate != null &amp;&amp; fEndDate != ''">
                      AND X.END_YMD <![CDATA[ <= ]]> #{fEndDate}
                    </if>
                    <if test="fWoTp != null &amp;&amp; fWoTp != ''">
                    AND X.WO_TP IN (${fWoTp})
                    </if>
          			GROUP BY LEFT(X.END_TIME,2)
          		) AS SOC
          		ON DAT.HOUR = SOC.HOUR

    </select>
    <!-- 시간별 W/O 현황 그리드 조회 -->
    <select id="retrieveST1401List3" parameterType="map" resultType="map" >
        <![CDATA[ /* st1401.retrieveST1401List3 */ ]]>
        SELECT DBO.FN_NAME(TP_TB.WO_TP, 'WO_TP') AS WO_TP, ISNULL(HOUR07,0) AS HOUR07, ISNULL(HOUR08,0) AS HOUR08, ISNULL(HOUR09,0) AS HOUR09
             , ISNULL(HOUR10,0) AS HOUR10, ISNULL(HOUR11,0) AS HOUR11, ISNULL(HOUR12,0) AS HOUR12, ISNULL(HOUR13,0) AS HOUR13
             , ISNULL(HOUR14,0) AS HOUR14, ISNULL(HOUR15,0) AS HOUR15, ISNULL(HOUR16,0) AS HOUR16, ISNULL(HOUR17,0) AS HOUR17
             , ISNULL(HOUR18,0) AS HOUR18, ISNULL(HOUR19,0) AS HOUR19, ISNULL(HOUR20,0) AS HOUR20, ISNULL(HOUR21,0) AS HOUR21
             , ISNULL(HOUR22,0) AS HOUR22, ISNULL(HOUR23,0) AS HOUR23, ISNULL(HOUR00,0) AS HOUR00, ISNULL(HOUR01,0) AS HOUR01
             , ISNULL(HOUR02,0) AS HOUR02, ISNULL(HOUR03,0) AS HOUR03, ISNULL(HOUR04,0) AS HOUR04, ISNULL(HOUR05,0) AS HOUR05
             , ISNULL(HOUR06,0) AS HOUR06
             , ISNULL(HOUR07,0) + ISNULL(HOUR08,0) + ISNULL(HOUR09,0) + ISNULL(HOUR10,0) + ISNULL(HOUR11,0) + ISNULL(HOUR12,0)
               + ISNULL(HOUR13,0) + ISNULL(HOUR14,0) + ISNULL(HOUR15,0) + ISNULL(HOUR16,0) + ISNULL(HOUR17,0) + ISNULL(HOUR18,0)
               + ISNULL(HOUR19,0) + ISNULL(HOUR20,0) + ISNULL(HOUR21,0) + ISNULL(HOUR22,0) + ISNULL(HOUR23,0) + ISNULL(HOUR00,0)
               + ISNULL(HOUR01,0) + ISNULL(HOUR02,0) + ISNULL(HOUR03,0) + ISNULL(HOUR04,0) + ISNULL(HOUR05,0) + ISNULL(HOUR06,0) AS TOTAL_CNT
          FROM (
                 SELECT 'WT01' AS WO_TP
                 UNION ALL
                 SELECT 'WT02'
                 UNION ALL
                 SELECT 'WT03'
                 UNION ALL
                 SELECT 'WT04'
                 ) AS TP_TB
                 LEFT JOIN (
                 SELECT
                        X.WO_TP
                      , SUM(CASE WHEN LEFT(X.END_TIME,2) = '07' THEN 1 ELSE 0 END) AS HOUR07
                      , SUM(CASE WHEN LEFT(X.END_TIME,2) = '08' THEN 1 ELSE 0 END) AS HOUR08
                 	  , SUM(CASE WHEN LEFT(X.END_TIME,2) = '09' THEN 1 ELSE 0 END) AS HOUR09
                 	  , SUM(CASE WHEN LEFT(X.END_TIME,2) = '10' THEN 1 ELSE 0 END) AS HOUR10
                 	  , SUM(CASE WHEN LEFT(X.END_TIME,2) = '11' THEN 1 ELSE 0 END) AS HOUR11
                 	  , SUM(CASE WHEN LEFT(X.END_TIME,2) = '12' THEN 1 ELSE 0 END) AS HOUR12
                 	  , SUM(CASE WHEN LEFT(X.END_TIME,2) = '13' THEN 1 ELSE 0 END) AS HOUR13
                 	  , SUM(CASE WHEN LEFT(X.END_TIME,2) = '14' THEN 1 ELSE 0 END) AS HOUR14
                 	  , SUM(CASE WHEN LEFT(X.END_TIME,2) = '15' THEN 1 ELSE 0 END) AS HOUR15
                 	  , SUM(CASE WHEN LEFT(X.END_TIME,2) = '16' THEN 1 ELSE 0 END) AS HOUR16
                 	  , SUM(CASE WHEN LEFT(X.END_TIME,2) = '17' THEN 1 ELSE 0 END) AS HOUR17
                 	  , SUM(CASE WHEN LEFT(X.END_TIME,2) = '18' THEN 1 ELSE 0 END) AS HOUR18
                 	  , SUM(CASE WHEN LEFT(X.END_TIME,2) = '19' THEN 1 ELSE 0 END) AS HOUR19
                 	  , SUM(CASE WHEN LEFT(X.END_TIME,2) = '20' THEN 1 ELSE 0 END) AS HOUR20
                 	  , SUM(CASE WHEN LEFT(X.END_TIME,2) = '21' THEN 1 ELSE 0 END) AS HOUR21
                 	  , SUM(CASE WHEN LEFT(X.END_TIME,2) = '22' THEN 1 ELSE 0 END) AS HOUR22
                 	  , SUM(CASE WHEN LEFT(X.END_TIME,2) = '23' THEN 1 ELSE 0 END) AS HOUR23
                 	  , SUM(CASE WHEN LEFT(X.END_TIME,2) = '00' THEN 1 ELSE 0 END) AS HOUR00
                 	  , SUM(CASE WHEN LEFT(X.END_TIME,2) = '01' THEN 1 ELSE 0 END) AS HOUR01
                 	  , SUM(CASE WHEN LEFT(X.END_TIME,2) = '02' THEN 1 ELSE 0 END) AS HOUR02
                 	  , SUM(CASE WHEN LEFT(X.END_TIME,2) = '03' THEN 1 ELSE 0 END) AS HOUR03
                 	  , SUM(CASE WHEN LEFT(X.END_TIME,2) = '04' THEN 1 ELSE 0 END) AS HOUR04
                 	  , SUM(CASE WHEN LEFT(X.END_TIME,2) = '05' THEN 1 ELSE 0 END) AS HOUR05
                 	  , SUM(CASE WHEN LEFT(X.END_TIME,2) = '06' THEN 1 ELSE 0 END) AS HOUR06
                 FROM WO0201M X
                 WHERE X.WO_STS ='YZ'
                   AND X.COMPANY_CD = #{companyCd}
                 <if test="fStartDate != null &amp;&amp; fStartDate != ''">
                   AND X.END_YMD <![CDATA[ >= ]]> #{fStartDate}
                 </if>
                 <if test="fEndDate != null &amp;&amp; fEndDate != ''">
                   AND X.END_YMD <![CDATA[ <= ]]> #{fEndDate}
                 </if>
                 GROUP BY X.WO_TP
               ) AS SOC ON TP_TB.WO_TP = SOC.WO_TP

    </select>
</mapper>