<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--************************************************************************************
* Program Name : 점검데이터작성
* Description : 점검데이터작성
* Author : jit13
* Created Date :
* SQL 목록
***************************************************************************************
* SQLID                 설명
***************************************************************************************
* retrieveST0801     : 점검데이터 목록 조회
*************************************************************************************-->
<mapper namespace="st1001">
    <select id="retrieveST1001List" parameterType="map" resultType="map" >
        <![CDATA[ /* st1001.retrieveST1001List */ ]]>
        SELECT COMPANY_CD
             , PLANT_CODE
             , FACTORY_CODE
             , CONFIRM_YEAR
             , KPI_DIV
             , (CASE WHEN KPI_DIV = 'MTTR' THEN (SELECT COMM_CD_NM FROM SC_COMM_CD WHERE COMM_GRP_CD = 'KPI_DIV' AND COMM_CD = KPI_DIV)
					WHEN KPI_DIV = 'MTBF' THEN (SELECT COMM_CD_NM FROM SC_COMM_CD WHERE COMM_GRP_CD = 'KPI_DIV' AND COMM_CD = KPI_DIV)
					WHEN KPI_DIV = 'PM' THEN '설비정기점검율(건수)'
					ELSE '' END )KPI_DIV_NM
             , MNG_STD
             , CASE WHEN KPI_DIV = 'MTTR' THEN '달성율(평균)'
			        WHEN KPI_DIV = 'MTBF' THEN '달성율(평균)'
					WHEN KPI_DIV = 'PM' THEN '달성율(건수)'
					ELSE '' END MNG_STD_NM
             , ISNULL(YEAR_PLAN, 0) YEAR_PLAN
             , ISNULL(MON_01,0) MON_01
             , ISNULL(MON_02,0) MON_02
             , ISNULL(MON_03,0) MON_03
             , ISNULL(MON_04,0) MON_04
             , ISNULL(MON_05,0) MON_05
             , ISNULL(MON_06,0) MON_06
             , ISNULL(MON_07,0) MON_07
             , ISNULL(MON_08,0) MON_08
             , ISNULL(MON_09,0) MON_09
             , ISNULL(MON_10,0) MON_10
             , ISNULL(MON_11,0) MON_11
             , ISNULL(MON_12,0) MON_12
             , ISNULL(YEAR_PLAN, 0) TOTAL
          FROM ST1001M
         WHERE PLANT_CODE   = #{plantCode}
           AND FACTORY_CODE = #{factoryCode}
           AND CONFIRM_YEAR = #{fYearDate}
           AND COMPANY_CD = #{companyCd}
         ORDER BY (SELECT ARRAY_ORD FROM SC_COMM_CD WHERE COMM_GRP_CD = 'KPI_DIV' AND COMM_CD = KPI_DIV)
	</select>

 	<insert id="insertST1001" parameterType="map" >
        <![CDATA[ /* st1001.insertST1001 */ ]]>
        INSERT INTO ST1001M (
               COMPANY_CD
             , PLANT_CODE
             , FACTORY_CODE
             , CONFIRM_YEAR
             , KPI_DIV
             , MNG_STD
             , YEAR_PLAN
             , MON_01
             , MON_02
             , MON_03
             , MON_04
             , MON_05
             , MON_06
             , MON_07
             , MON_08
             , MON_09
             , MON_10
             , MON_11
             , MON_12
             , FST_REG_DT
             , FST_REG_USER_ID
             , FNL_EDIT_DT
             , FNL_EDIT_USER_ID
        )
        VALUES (
               #{companyCd}
             , #{plantCode}
             , #{factoryCode}
             , #{confirmYear}
             , #{kpiDiv}
             , #{mngStd}
             , #{yearPlan}
             , #{mon01}
             , #{mon02}
             , #{mon03}
             , #{mon04}
             , #{mon05}
             , #{mon06}
             , #{mon07}
             , #{mon08}
             , #{mon09}
             , #{mon10}
             , #{mon11}
             , #{mon12}
             , GETDATE()
             , #{fstRegUserId}
             , GETDATE()
             , #{fnlEditUserId}
        )
    </insert>

    <update id="updateST1001" parameterType="map" >
        <![CDATA[ /* st1001.updateST1001 */ ]]>
        UPDATE ST1001M
           SET
               YEAR_PLAN        = #{yearPlan}
             , MON_01           = #{mon01}
             , MON_02           = #{mon02}
             , MON_03           = #{mon03}
             , MON_04           = #{mon04}
             , MON_05           = #{mon05}
             , MON_06           = #{mon06}
             , MON_07           = #{mon07}
             , MON_08           = #{mon08}
             , MON_09           = #{mon09}
             , MON_10           = #{mon10}
             , MON_11           = #{mon11}
             , MON_12           = #{mon12}
             , FNL_EDIT_DT      = GETDATE()
             , FNL_EDIT_USER_ID = #{fnlEditUserId}
         WHERE PLANT_CODE       = #{plantCode}
           AND FACTORY_CODE     = #{factoryCode}
           AND CONFIRM_YEAR     = #{confirmYear}
           AND KPI_DIV          = #{kpiDiv}
           AND MNG_STD          = #{mngStd}
           AND COMPANY_CD       = #{companyCd}
    </update>

    <select id="retrieveST1001Sub01List" parameterType="map" resultType="map" >
        <![CDATA[ /* st1001.retrieveST1001Sub01List */ ]]>
        SET ANSI_WARNINGS OFF
        SET ARITHIGNORE ON
        SET ARITHABORT OFF;
        WITH
		EQ_PLAN
        AS (
           SELECT
                  M.EQ_NO
                , ISNULL((SELECT COUNT(A.CHK_NO) FROM IN0201M A INNER JOIN IN0401M B ON B.COMPANY_CD = A.COMPANY_CD AND B.CHK_NO = A.CHK_NO WHERE A.COMPANY_CD = #{companyCd} AND A.EQ_NO = M.EQ_NO AND A.PM_TP = 'T' AND A.ACT_YN = 'Y' AND A.DAY_YN = 'N' AND CONVERT(VARCHAR(7), B.ACTL_YMD, 23) = CONCAT(#{fYearDate}, '-01')),0) MON_01
                , ISNULL((SELECT COUNT(A.CHK_NO) FROM IN0201M A INNER JOIN IN0401M B ON B.COMPANY_CD = A.COMPANY_CD AND B.CHK_NO = A.CHK_NO WHERE A.COMPANY_CD = #{companyCd} AND A.EQ_NO = M.EQ_NO AND A.PM_TP = 'T' AND A.ACT_YN = 'Y' AND A.DAY_YN = 'N' AND CONVERT(VARCHAR(7), B.ACTL_YMD, 23) = CONCAT(#{fYearDate}, '-02')),0) MON_02
                , ISNULL((SELECT COUNT(A.CHK_NO) FROM IN0201M A INNER JOIN IN0401M B ON B.COMPANY_CD = A.COMPANY_CD AND B.CHK_NO = A.CHK_NO WHERE A.COMPANY_CD = #{companyCd} AND A.EQ_NO = M.EQ_NO AND A.PM_TP = 'T' AND A.ACT_YN = 'Y' AND A.DAY_YN = 'N' AND CONVERT(VARCHAR(7), B.ACTL_YMD, 23) = CONCAT(#{fYearDate}, '-03')),0) MON_03
                , ISNULL((SELECT COUNT(A.CHK_NO) FROM IN0201M A INNER JOIN IN0401M B ON B.COMPANY_CD = A.COMPANY_CD AND B.CHK_NO = A.CHK_NO WHERE A.COMPANY_CD = #{companyCd} AND A.EQ_NO = M.EQ_NO AND A.PM_TP = 'T' AND A.ACT_YN = 'Y' AND A.DAY_YN = 'N' AND CONVERT(VARCHAR(7), B.ACTL_YMD, 23) = CONCAT(#{fYearDate}, '-04')),0) MON_04
                , ISNULL((SELECT COUNT(A.CHK_NO) FROM IN0201M A INNER JOIN IN0401M B ON B.COMPANY_CD = A.COMPANY_CD AND B.CHK_NO = A.CHK_NO WHERE A.COMPANY_CD = #{companyCd} AND A.EQ_NO = M.EQ_NO AND A.PM_TP = 'T' AND A.ACT_YN = 'Y' AND A.DAY_YN = 'N' AND CONVERT(VARCHAR(7), B.ACTL_YMD, 23) = CONCAT(#{fYearDate}, '-05')),0) MON_05
                , ISNULL((SELECT COUNT(A.CHK_NO) FROM IN0201M A INNER JOIN IN0401M B ON B.COMPANY_CD = A.COMPANY_CD AND B.CHK_NO = A.CHK_NO WHERE A.COMPANY_CD = #{companyCd} AND A.EQ_NO = M.EQ_NO AND A.PM_TP = 'T' AND A.ACT_YN = 'Y' AND A.DAY_YN = 'N' AND CONVERT(VARCHAR(7), B.ACTL_YMD, 23) = CONCAT(#{fYearDate}, '-06')),0) MON_06
                , ISNULL((SELECT COUNT(A.CHK_NO) FROM IN0201M A INNER JOIN IN0401M B ON B.COMPANY_CD = A.COMPANY_CD AND B.CHK_NO = A.CHK_NO WHERE A.COMPANY_CD = #{companyCd} AND A.EQ_NO = M.EQ_NO AND A.PM_TP = 'T' AND A.ACT_YN = 'Y' AND A.DAY_YN = 'N' AND CONVERT(VARCHAR(7), B.ACTL_YMD, 23) = CONCAT(#{fYearDate}, '-07')),0) MON_07
                , ISNULL((SELECT COUNT(A.CHK_NO) FROM IN0201M A INNER JOIN IN0401M B ON B.COMPANY_CD = A.COMPANY_CD AND B.CHK_NO = A.CHK_NO WHERE A.COMPANY_CD = #{companyCd} AND A.EQ_NO = M.EQ_NO AND A.PM_TP = 'T' AND A.ACT_YN = 'Y' AND A.DAY_YN = 'N' AND CONVERT(VARCHAR(7), B.ACTL_YMD, 23) = CONCAT(#{fYearDate}, '-08')),0) MON_08
                , ISNULL((SELECT COUNT(A.CHK_NO) FROM IN0201M A INNER JOIN IN0401M B ON B.COMPANY_CD = A.COMPANY_CD AND B.CHK_NO = A.CHK_NO WHERE A.COMPANY_CD = #{companyCd} AND A.EQ_NO = M.EQ_NO AND A.PM_TP = 'T' AND A.ACT_YN = 'Y' AND A.DAY_YN = 'N' AND CONVERT(VARCHAR(7), B.ACTL_YMD, 23) = CONCAT(#{fYearDate}, '-09')),0) MON_09
                , ISNULL((SELECT COUNT(A.CHK_NO) FROM IN0201M A INNER JOIN IN0401M B ON B.COMPANY_CD = A.COMPANY_CD AND B.CHK_NO = A.CHK_NO WHERE A.COMPANY_CD = #{companyCd} AND A.EQ_NO = M.EQ_NO AND A.PM_TP = 'T' AND A.ACT_YN = 'Y' AND A.DAY_YN = 'N' AND CONVERT(VARCHAR(7), B.ACTL_YMD, 23) = CONCAT(#{fYearDate}, '-10')),0) MON_10
                , ISNULL((SELECT COUNT(A.CHK_NO) FROM IN0201M A INNER JOIN IN0401M B ON B.COMPANY_CD = A.COMPANY_CD AND B.CHK_NO = A.CHK_NO WHERE A.COMPANY_CD = #{companyCd} AND A.EQ_NO = M.EQ_NO AND A.PM_TP = 'T' AND A.ACT_YN = 'Y' AND A.DAY_YN = 'N' AND CONVERT(VARCHAR(7), B.ACTL_YMD, 23) = CONCAT(#{fYearDate}, '-11')),0) MON_11
                , ISNULL((SELECT COUNT(A.CHK_NO) FROM IN0201M A INNER JOIN IN0401M B ON B.COMPANY_CD = A.COMPANY_CD AND B.CHK_NO = A.CHK_NO WHERE A.COMPANY_CD = #{companyCd} AND A.EQ_NO = M.EQ_NO AND A.PM_TP = 'T' AND A.ACT_YN = 'Y' AND A.DAY_YN = 'N' AND CONVERT(VARCHAR(7), B.ACTL_YMD, 23) = CONCAT(#{fYearDate}, '-12')),0) MON_12
             FROM EQ0101M M
            WHERE M.PLANT_CODE   = #{plantCode}
              AND M.FACTORY_CODE = #{factoryCode}
              AND M.COMPANY_CD = #{companyCd}
              AND M.REV_NO       = '202011001'
              AND EXISTS (
                       SELECT 1 FROM IN0201M WHERE EQ_NO = M.EQ_NO AND PM_TP = 'T' AND ACT_YN = 'Y' AND DAY_YN = 'N' AND COMPANY_CD = #{companyCd}
                  )
         ),
         EQ_CMPLT
         AS (
           SELECT
                  C.EQ_NO
                , ISNULL((SELECT COUNT(A.CHK_NO) FROM IN0201M A INNER JOIN IN0401M B ON B.COMPANY_CD = A.COMPANY_CD AND B.CHK_NO = A.CHK_NO WHERE A.COMPANY_CD = #{companyCd} AND A.EQ_NO = C.EQ_NO AND A.PM_TP = 'T' AND A.ACT_YN = 'Y' AND B.CMPLT_YN = 'Y' AND A.DAY_YN = 'N' AND CONVERT(VARCHAR(7), B.ACTL_YMD, 23) = CONCAT(#{fYearDate}, '-01')),0) MON_01
                , ISNULL((SELECT COUNT(A.CHK_NO) FROM IN0201M A INNER JOIN IN0401M B ON B.COMPANY_CD = A.COMPANY_CD AND B.CHK_NO = A.CHK_NO WHERE A.COMPANY_CD = #{companyCd} AND A.EQ_NO = C.EQ_NO AND A.PM_TP = 'T' AND A.ACT_YN = 'Y' AND B.CMPLT_YN = 'Y' AND A.DAY_YN = 'N' AND CONVERT(VARCHAR(7), B.ACTL_YMD, 23) = CONCAT(#{fYearDate}, '-02')),0) MON_02
                , ISNULL((SELECT COUNT(A.CHK_NO) FROM IN0201M A INNER JOIN IN0401M B ON B.COMPANY_CD = A.COMPANY_CD AND B.CHK_NO = A.CHK_NO WHERE A.COMPANY_CD = #{companyCd} AND A.EQ_NO = C.EQ_NO AND A.PM_TP = 'T' AND A.ACT_YN = 'Y' AND B.CMPLT_YN = 'Y' AND A.DAY_YN = 'N' AND CONVERT(VARCHAR(7), B.ACTL_YMD, 23) = CONCAT(#{fYearDate}, '-03')),0) MON_03
                , ISNULL((SELECT COUNT(A.CHK_NO) FROM IN0201M A INNER JOIN IN0401M B ON B.COMPANY_CD = A.COMPANY_CD AND B.CHK_NO = A.CHK_NO WHERE A.COMPANY_CD = #{companyCd} AND A.EQ_NO = C.EQ_NO AND A.PM_TP = 'T' AND A.ACT_YN = 'Y' AND B.CMPLT_YN = 'Y' AND A.DAY_YN = 'N' AND CONVERT(VARCHAR(7), B.ACTL_YMD, 23) = CONCAT(#{fYearDate}, '-04')),0) MON_04
                , ISNULL((SELECT COUNT(A.CHK_NO) FROM IN0201M A INNER JOIN IN0401M B ON B.COMPANY_CD = A.COMPANY_CD AND B.CHK_NO = A.CHK_NO WHERE A.COMPANY_CD = #{companyCd} AND A.EQ_NO = C.EQ_NO AND A.PM_TP = 'T' AND A.ACT_YN = 'Y' AND B.CMPLT_YN = 'Y' AND A.DAY_YN = 'N' AND CONVERT(VARCHAR(7), B.ACTL_YMD, 23) = CONCAT(#{fYearDate}, '-05')),0) MON_05
                , ISNULL((SELECT COUNT(A.CHK_NO) FROM IN0201M A INNER JOIN IN0401M B ON B.COMPANY_CD = A.COMPANY_CD AND B.CHK_NO = A.CHK_NO WHERE A.COMPANY_CD = #{companyCd} AND A.EQ_NO = C.EQ_NO AND A.PM_TP = 'T' AND A.ACT_YN = 'Y' AND B.CMPLT_YN = 'Y' AND A.DAY_YN = 'N' AND CONVERT(VARCHAR(7), B.ACTL_YMD, 23) = CONCAT(#{fYearDate}, '-06')),0) MON_06
                , ISNULL((SELECT COUNT(A.CHK_NO) FROM IN0201M A INNER JOIN IN0401M B ON B.COMPANY_CD = A.COMPANY_CD AND B.CHK_NO = A.CHK_NO WHERE A.COMPANY_CD = #{companyCd} AND A.EQ_NO = C.EQ_NO AND A.PM_TP = 'T' AND A.ACT_YN = 'Y' AND B.CMPLT_YN = 'Y' AND A.DAY_YN = 'N' AND CONVERT(VARCHAR(7), B.ACTL_YMD, 23) = CONCAT(#{fYearDate}, '-07')),0) MON_07
                , ISNULL((SELECT COUNT(A.CHK_NO) FROM IN0201M A INNER JOIN IN0401M B ON B.COMPANY_CD = A.COMPANY_CD AND B.CHK_NO = A.CHK_NO WHERE A.COMPANY_CD = #{companyCd} AND A.EQ_NO = C.EQ_NO AND A.PM_TP = 'T' AND A.ACT_YN = 'Y' AND B.CMPLT_YN = 'Y' AND A.DAY_YN = 'N' AND CONVERT(VARCHAR(7), B.ACTL_YMD, 23) = CONCAT(#{fYearDate}, '-08')),0) MON_08
                , ISNULL((SELECT COUNT(A.CHK_NO) FROM IN0201M A INNER JOIN IN0401M B ON B.COMPANY_CD = A.COMPANY_CD AND B.CHK_NO = A.CHK_NO WHERE A.COMPANY_CD = #{companyCd} AND A.EQ_NO = C.EQ_NO AND A.PM_TP = 'T' AND A.ACT_YN = 'Y' AND B.CMPLT_YN = 'Y' AND A.DAY_YN = 'N' AND CONVERT(VARCHAR(7), B.ACTL_YMD, 23) = CONCAT(#{fYearDate}, '-09')),0) MON_09
                , ISNULL((SELECT COUNT(A.CHK_NO) FROM IN0201M A INNER JOIN IN0401M B ON B.COMPANY_CD = A.COMPANY_CD AND B.CHK_NO = A.CHK_NO WHERE A.COMPANY_CD = #{companyCd} AND A.EQ_NO = C.EQ_NO AND A.PM_TP = 'T' AND A.ACT_YN = 'Y' AND B.CMPLT_YN = 'Y' AND A.DAY_YN = 'N' AND CONVERT(VARCHAR(7), B.ACTL_YMD, 23) = CONCAT(#{fYearDate}, '-10')),0) MON_10
                , ISNULL((SELECT COUNT(A.CHK_NO) FROM IN0201M A INNER JOIN IN0401M B ON B.COMPANY_CD = A.COMPANY_CD AND B.CHK_NO = A.CHK_NO WHERE A.COMPANY_CD = #{companyCd} AND A.EQ_NO = C.EQ_NO AND A.PM_TP = 'T' AND A.ACT_YN = 'Y' AND B.CMPLT_YN = 'Y' AND A.DAY_YN = 'N' AND CONVERT(VARCHAR(7), B.ACTL_YMD, 23) = CONCAT(#{fYearDate}, '-11')),0) MON_11
                , ISNULL((SELECT COUNT(A.CHK_NO) FROM IN0201M A INNER JOIN IN0401M B ON B.COMPANY_CD = A.COMPANY_CD AND B.CHK_NO = A.CHK_NO WHERE A.COMPANY_CD = #{companyCd} AND A.EQ_NO = C.EQ_NO AND A.PM_TP = 'T' AND A.ACT_YN = 'Y' AND B.CMPLT_YN = 'Y' AND A.DAY_YN = 'N' AND CONVERT(VARCHAR(7), B.ACTL_YMD, 23) = CONCAT(#{fYearDate}, '-12')),0) MON_12
             FROM EQ0101M C
            WHERE C.PLANT_CODE   = #{plantCode}
              AND C.FACTORY_CODE = #{factoryCode}
              AND C.COMPANY_CD = #{companyCd}
              AND C.REV_NO       = '202011001'
              AND EXISTS (
                       SELECT 1 FROM IN0201M WHERE EQ_NO = C.EQ_NO AND PM_TP = 'T' AND ACT_YN = 'Y' AND DAY_YN = 'N' AND COMPANY_CD = #{companyCd}
                  )
  )
        SELECT A.GUBUN_SEQ
             , A.GUBUN_ITEM
             , A.GUBUN_DIV
             , A.MON_01
             , A.MON_02
             , A.MON_03
             , A.MON_04
             , A.MON_05
             , A.MON_06
             , A.MON_07
             , A.MON_08
             , A.MON_09
             , A.MON_10
             , A.MON_11
             , A.MON_12
             , CONVERT(INT, A.MON_01) + CONVERT(INT, A.MON_02) + CONVERT(INT, A.MON_03) + CONVERT(INT, A.MON_04) + CONVERT(INT, A.MON_05) + CONVERT(INT, A.MON_06) + CONVERT(INT, A.MON_07) + CONVERT(INT, A.MON_08) + CONVERT(INT, A.MON_09) + CONVERT(INT, A.MON_10) + CONVERT(INT, A.MON_11) + CONVERT(INT, A.MON_12) MON_TOTAL
             , ROUND((CONVERT(FLOAT, A.MON_01) + CONVERT(FLOAT, A.MON_02) + CONVERT(FLOAT, A.MON_03) + CONVERT(FLOAT, A.MON_04) + CONVERT(FLOAT, A.MON_05) + CONVERT(FLOAT, A.MON_06) + CONVERT(FLOAT, A.MON_07) + CONVERT(FLOAT, A.MON_08) + CONVERT(FLOAT, A.MON_09) + CONVERT(FLOAT, A.MON_10) + CONVERT(FLOAT, A.MON_11) + CONVERT(FLOAT, A.MON_12)) / 12 ,0)  MON_AVG
          FROM
             (
           SELECT '01' GUBUN_SEQ
                , (SELECT COMM_CD_NM FROM SC_COMM_CD WHERE COMM_GRP_CD = 'KPI_DIV' AND COMM_CD = KPI_DIV)  GUBUN_ITEM
                , CASE WHEN (SELECT COMM_CD_NM FROM SC_COMM_CD WHERE COMM_GRP_CD = 'KPI_DIV' AND COMM_CD = KPI_DIV) = '설비정기점검율' THEN '목표(건수)'
						ELSE '목표' END GUBUN_DIV
                , ISNULL(MON_01,0) MON_01
                , ISNULL(MON_02,0) MON_02
                , ISNULL(MON_03,0) MON_03
                , ISNULL(MON_04,0) MON_04
                , ISNULL(MON_05,0) MON_05
                , ISNULL(MON_06,0) MON_06
                , ISNULL(MON_07,0) MON_07
                , ISNULL(MON_08,0) MON_08
                , ISNULL(MON_09,0) MON_09
                , ISNULL(MON_10,0) MON_10
                , ISNULL(MON_11,0) MON_11
                , ISNULL(MON_12,0) MON_12
             FROM ST1001M
            WHERE CONFIRM_YEAR = #{fYearDate}
              AND COMPANY_CD   = #{companyCd}
            GROUP BY KPI_DIV , MON_01, MON_02, MON_03, MON_04, MON_05, MON_06, MON_07, MON_08, MON_09, MON_10, MON_11, MON_12
            UNION ALL
           SELECT '02' GUBUN_SEQ
                , 'MTTR(M)' GUBUN_ITEM
                , '실적' GUBUN_DIV
                , ISNULL(SUM(MON_01),0) MON_01
                , ISNULL(SUM(MON_02),0) MON_02
                , ISNULL(SUM(MON_03),0) MON_03
                , ISNULL(SUM(MON_04),0) MON_04
                , ISNULL(SUM(MON_05),0) MON_05
                , ISNULL(SUM(MON_06),0) MON_06
                , ISNULL(SUM(MON_07),0) MON_07
                , ISNULL(SUM(MON_08),0) MON_08
                , ISNULL(SUM(MON_09),0) MON_09
                , ISNULL(SUM(MON_10),0) MON_10
                , ISNULL(SUM(MON_11),0) MON_11
                , ISNULL(SUM(MON_12),0) MON_12
           FROM (
             SELECT CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-01') THEN ISNULL( CONVERT(INT, ROUND((REPAIR_HOUR / FAILURE_CNT),0)),0) ELSE 0 END MON_01
                  , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-02') THEN ISNULL( CONVERT(INT, ROUND((REPAIR_HOUR / FAILURE_CNT),0)),0) ELSE 0 END MON_02
                  , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-03') THEN ISNULL( CONVERT(INT, ROUND((REPAIR_HOUR / FAILURE_CNT),0)),0) ELSE 0 END MON_03
                  , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-04') THEN ISNULL( CONVERT(INT, ROUND((REPAIR_HOUR / FAILURE_CNT),0)),0) ELSE 0 END MON_04
                  , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-05') THEN ISNULL( CONVERT(INT, ROUND((REPAIR_HOUR / FAILURE_CNT),0)),0) ELSE 0 END MON_05
                  , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-06') THEN ISNULL( CONVERT(INT, ROUND((REPAIR_HOUR / FAILURE_CNT),0)),0) ELSE 0 END MON_06
                  , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-07') THEN ISNULL( CONVERT(INT, ROUND((REPAIR_HOUR / FAILURE_CNT),0)),0) ELSE 0 END MON_07
                  , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-08') THEN ISNULL( CONVERT(INT, ROUND((REPAIR_HOUR / FAILURE_CNT),0)),0) ELSE 0 END MON_08
                  , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-09') THEN ISNULL( CONVERT(INT, ROUND((REPAIR_HOUR / FAILURE_CNT),0)),0) ELSE 0 END MON_09
                  , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-10') THEN ISNULL( CONVERT(INT, ROUND((REPAIR_HOUR / FAILURE_CNT),0)),0) ELSE 0 END MON_10
                  , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-11') THEN ISNULL( CONVERT(INT, ROUND((REPAIR_HOUR / FAILURE_CNT),0)),0) ELSE 0 END MON_11
                  , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-12') THEN ISNULL( CONVERT(INT, ROUND((REPAIR_HOUR / FAILURE_CNT),0)),0) ELSE 0 END MON_12
               FROM (
                      SELECT CONVERT(varchar(7), W1.END_YMD, 23) YYYYMM, COUNT(E.EQ_NO) FAILURE_CNT
                           , SUM(DATEDIFF(MINUTE, CONVERT(CHAR(16), CONVERT(VARCHAR, W1.START_YMD + ' ' + W1.START_TIME + ':00', 120), 120), CONVERT(CHAR(16), CONVERT(VARCHAR, W1.END_YMD + ' ' +W1.END_TIME + ':00', 120), 120))) REPAIR_HOUR
                        FROM EQ0101M E
                       INNER JOIN WO0201M W1 ON (E.COMPANY_CD = W1.COMPANY_CD AND W1.EQ_NO = E.EQ_NO AND W1.WO_STS = 'YZ' AND CONVERT(varchar(4), W1.END_YMD , 23 )  = #{fYearDate})
                       WHERE E.COMPANY_CD = #{companyCd}
                       GROUP BY CONVERT(varchar(7), W1.END_YMD, 23)
                    ) MTTR_A
          ) MTTR_B
         UNION ALL
        SELECT '03' GUBUN_SEQ
             , 'MTTR(M)' GUBUN_ITEM
             , '달성율(%)' GUBUN_DIV
             , ISNULL(SUM(MON_01),0) MON_01
             , ISNULL(SUM(MON_02),0) MON_02
             , ISNULL(SUM(MON_03),0) MON_03
             , ISNULL(SUM(MON_04),0) MON_04
             , ISNULL(SUM(MON_05),0) MON_05
             , ISNULL(SUM(MON_06),0) MON_06
             , ISNULL(SUM(MON_07),0) MON_07
             , ISNULL(SUM(MON_08),0) MON_08
             , ISNULL(SUM(MON_09),0) MON_09
             , ISNULL(SUM(MON_10),0) MON_10
             , ISNULL(SUM(MON_11),0) MON_11
             , ISNULL(SUM(MON_12),0) MON_12
        FROM (
               SELECT CASE WHEN YYYYMM = CONCAT('2022', '-01') THEN ISNULL((SELECT MON_01 FROM ST1001M WHERE KPI_DIV = 'MTTR' AND CONFIRM_YEAR = #{fYearDate}),0) ELSE 0 END * 100 / ISNULL( CONVERT(INT, ROUND((REPAIR_HOUR / FAILURE_CNT),0)),0) MON_01
                    , CASE WHEN YYYYMM = CONCAT('2022', '-02') THEN ISNULL((SELECT MON_02 FROM ST1001M WHERE KPI_DIV = 'MTTR' AND CONFIRM_YEAR = #{fYearDate}),0) ELSE 0 END * 100 / ISNULL( CONVERT(INT, ROUND((REPAIR_HOUR / FAILURE_CNT),0)),0) MON_02
                    , CASE WHEN YYYYMM = CONCAT('2022', '-03') THEN ISNULL((SELECT MON_03 FROM ST1001M WHERE KPI_DIV = 'MTTR' AND CONFIRM_YEAR = #{fYearDate}),0) ELSE 0 END * 100 / ISNULL( CONVERT(INT, ROUND((REPAIR_HOUR / FAILURE_CNT),0)),0) MON_03
                    , CASE WHEN YYYYMM = CONCAT('2022', '-04') THEN ISNULL((SELECT MON_04 FROM ST1001M WHERE KPI_DIV = 'MTTR' AND CONFIRM_YEAR = #{fYearDate}),0) ELSE 0 END * 100 / ISNULL( CONVERT(INT, ROUND((REPAIR_HOUR / FAILURE_CNT),0)),0) MON_04
                    , CASE WHEN YYYYMM = CONCAT('2022', '-05') THEN ISNULL((SELECT MON_05 FROM ST1001M WHERE KPI_DIV = 'MTTR' AND CONFIRM_YEAR = #{fYearDate}),0) ELSE 0 END * 100 / ISNULL( CONVERT(INT, ROUND((REPAIR_HOUR / FAILURE_CNT),0)),0) MON_05
                    , CASE WHEN YYYYMM = CONCAT('2022', '-06') THEN ISNULL((SELECT MON_06 FROM ST1001M WHERE KPI_DIV = 'MTTR' AND CONFIRM_YEAR = #{fYearDate}),0) ELSE 0 END * 100 / ISNULL( CONVERT(INT, ROUND((REPAIR_HOUR / FAILURE_CNT),0)),0) MON_06
                    , CASE WHEN YYYYMM = CONCAT('2022', '-07') THEN ISNULL((SELECT MON_07 FROM ST1001M WHERE KPI_DIV = 'MTTR' AND CONFIRM_YEAR = #{fYearDate}),0) ELSE 0 END * 100 / ISNULL( CONVERT(INT, ROUND((REPAIR_HOUR / FAILURE_CNT),0)),0) MON_07
                    , CASE WHEN YYYYMM = CONCAT('2022', '-08') THEN ISNULL((SELECT MON_08 FROM ST1001M WHERE KPI_DIV = 'MTTR' AND CONFIRM_YEAR = #{fYearDate}),0) ELSE 0 END * 100 / ISNULL( CONVERT(INT, ROUND((REPAIR_HOUR / FAILURE_CNT),0)),0) MON_08
                    , CASE WHEN YYYYMM = CONCAT('2022', '-09') THEN ISNULL((SELECT MON_09 FROM ST1001M WHERE KPI_DIV = 'MTTR' AND CONFIRM_YEAR = #{fYearDate}),0) ELSE 0 END * 100 / ISNULL( CONVERT(INT, ROUND((REPAIR_HOUR / FAILURE_CNT),0)),0) MON_09
                    , CASE WHEN YYYYMM = CONCAT('2022', '-10') THEN ISNULL((SELECT MON_10 FROM ST1001M WHERE KPI_DIV = 'MTTR' AND CONFIRM_YEAR = #{fYearDate}),0) ELSE 0 END * 100 / ISNULL( CONVERT(INT, ROUND((REPAIR_HOUR / FAILURE_CNT),0)),0) MON_10
                    , CASE WHEN YYYYMM = CONCAT('2022', '-11') THEN ISNULL((SELECT MON_11 FROM ST1001M WHERE KPI_DIV = 'MTTR' AND CONFIRM_YEAR = #{fYearDate}),0) ELSE 0 END * 100 / ISNULL( CONVERT(INT, ROUND((REPAIR_HOUR / FAILURE_CNT),0)),0) MON_11
                    , CASE WHEN YYYYMM = CONCAT('2022', '-12') THEN ISNULL((SELECT MON_12 FROM ST1001M WHERE KPI_DIV = 'MTTR' AND CONFIRM_YEAR = #{fYearDate}),0) ELSE 0 END * 100 / ISNULL( CONVERT(INT, ROUND((REPAIR_HOUR / FAILURE_CNT),0)),0) MON_12
                 FROM (
               SELECT CONVERT(varchar(7), W1.END_YMD, 23) YYYYMM, COUNT(E.EQ_NO) FAILURE_CNT
                          , SUM(DATEDIFF(MINUTE, CONVERT(CHAR(16), CONVERT(VARCHAR, W1.START_YMD + ' ' + W1.START_TIME + ':00', 120), 120), CONVERT(CHAR(16), CONVERT(VARCHAR, W1.END_YMD + ' ' +W1.END_TIME + ':00', 120), 120))) REPAIR_HOUR
                       FROM EQ0101M E
                      INNER JOIN WO0201M W1 ON (W1.COMPANY_CD = E.COMPANY_CD AND W1.EQ_NO = E.EQ_NO AND W1.WO_STS = 'YZ' AND CONVERT(varchar(4), W1.END_YMD , 23 )  = #{fYearDate})
                      WHERE E.COMPANY_CD = #{companyCd}
                      GROUP BY CONVERT(varchar(7), W1.END_YMD, 23)
                ) MTTR_A
            ) MTTR_B
        UNION ALL
       SELECT '02' GUBUN_SEQ
             , 'MTBF(H)' GUBUN_ITEM
             , '실적' GUBUN_DIV
             , ISNULL(SUM(MON_01),0) MON_01
             , ISNULL(SUM(MON_02),0) MON_02
             , ISNULL(SUM(MON_03),0) MON_03
             , ISNULL(SUM(MON_04),0) MON_04
             , ISNULL(SUM(MON_05),0) MON_05
             , ISNULL(SUM(MON_06),0) MON_06
             , ISNULL(SUM(MON_07),0) MON_07
             , ISNULL(SUM(MON_08),0) MON_08
             , ISNULL(SUM(MON_09),0) MON_09
             , ISNULL(SUM(MON_10),0) MON_10
             , ISNULL(SUM(MON_11),0) MON_11
             , ISNULL(SUM(MON_12),0) MON_12
           FROM (
             SELECT CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-01') THEN ISNULL(CONVERT(INT, ROUND((SELECT ROUND(SUM(CYCLETIME) / 3600,0) FROM EQ0901W W2 WHERE CONVERT(varchar(7), W2.EVENTDATE , 23 )=  YYYYMM) / SUM(FAILURE_CNT),0)),0) ELSE 0 END MON_01
                  , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-02') THEN ISNULL(CONVERT(INT, ROUND((SELECT ROUND(SUM(CYCLETIME) / 3600,0) FROM EQ0901W W2 WHERE CONVERT(varchar(7), W2.EVENTDATE , 23 )=  YYYYMM) / SUM(FAILURE_CNT),0)),0) ELSE 0 END MON_02
                  , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-03') THEN ISNULL(CONVERT(INT, ROUND((SELECT ROUND(SUM(CYCLETIME) / 3600,0) FROM EQ0901W W2 WHERE CONVERT(varchar(7), W2.EVENTDATE , 23 )=  YYYYMM) / SUM(FAILURE_CNT),0)),0) ELSE 0 END MON_03
                  , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-04') THEN ISNULL(CONVERT(INT, ROUND((SELECT ROUND(SUM(CYCLETIME) / 3600,0) FROM EQ0901W W2 WHERE CONVERT(varchar(7), W2.EVENTDATE , 23 )=  YYYYMM) / SUM(FAILURE_CNT),0)),0) ELSE 0 END MON_04
                  , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-05') THEN ISNULL(CONVERT(INT, ROUND((SELECT ROUND(SUM(CYCLETIME) / 3600,0) FROM EQ0901W W2 WHERE CONVERT(varchar(7), W2.EVENTDATE , 23 )=  YYYYMM) / SUM(FAILURE_CNT),0)),0) ELSE 0 END MON_05
                  , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-06') THEN ISNULL(CONVERT(INT, ROUND((SELECT ROUND(SUM(CYCLETIME) / 3600,0) FROM EQ0901W W2 WHERE CONVERT(varchar(7), W2.EVENTDATE , 23 )=  YYYYMM) / SUM(FAILURE_CNT),0)),0) ELSE 0 END MON_06
                  , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-07') THEN ISNULL(CONVERT(INT, ROUND((SELECT ROUND(SUM(CYCLETIME) / 3600,0) FROM EQ0901W W2 WHERE CONVERT(varchar(7), W2.EVENTDATE , 23 )=  YYYYMM) / SUM(FAILURE_CNT),0)),0) ELSE 0 END MON_07
                  , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-08') THEN ISNULL(CONVERT(INT, ROUND((SELECT ROUND(SUM(CYCLETIME) / 3600,0) FROM EQ0901W W2 WHERE CONVERT(varchar(7), W2.EVENTDATE , 23 )=  YYYYMM) / SUM(FAILURE_CNT),0)),0) ELSE 0 END MON_08
                  , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-09') THEN ISNULL(CONVERT(INT, ROUND((SELECT ROUND(SUM(CYCLETIME) / 3600,0) FROM EQ0901W W2 WHERE CONVERT(varchar(7), W2.EVENTDATE , 23 )=  YYYYMM) / SUM(FAILURE_CNT),0)),0) ELSE 0 END MON_09
                  , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-10') THEN ISNULL(CONVERT(INT, ROUND((SELECT ROUND(SUM(CYCLETIME) / 3600,0) FROM EQ0901W W2 WHERE CONVERT(varchar(7), W2.EVENTDATE , 23 )=  YYYYMM) / SUM(FAILURE_CNT),0)),0) ELSE 0 END MON_10
                  , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-11') THEN ISNULL(CONVERT(INT, ROUND((SELECT ROUND(SUM(CYCLETIME) / 3600,0) FROM EQ0901W W2 WHERE CONVERT(varchar(7), W2.EVENTDATE , 23 )=  YYYYMM) / SUM(FAILURE_CNT),0)),0) ELSE 0 END MON_11
                  , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-12') THEN ISNULL(CONVERT(INT, ROUND((SELECT ROUND(SUM(CYCLETIME) / 3600,0) FROM EQ0901W W2 WHERE CONVERT(varchar(7), W2.EVENTDATE , 23 )=  YYYYMM) / SUM(FAILURE_CNT),0)),0) ELSE 0 END MON_12
               FROM (
                      SELECT CONVERT(varchar(7), W1.END_YMD, 23) YYYYMM, COUNT(E.EQ_NO) FAILURE_CNT
                                 , SUM(DATEDIFF(MINUTE, CONVERT(CHAR(16), CONVERT(VARCHAR, W1.START_YMD + ' ' + W1.START_TIME + ':00', 120), 120), CONVERT(CHAR(16), CONVERT(VARCHAR, W1.END_YMD + ' ' +W1.END_TIME + ':00', 120), 120))) REPAIR_HOUR
                              FROM EQ0101M E
                             INNER JOIN WO0201M W1 ON (W1.COMPANY_CD = E.COMPANY_CD AND W1.EQ_NO = E.EQ_NO AND W1.WO_STS = 'YZ' AND CONVERT(varchar(4), W1.END_YMD , 23 )  = #{fYearDate})
                             WHERE E.COMPANY_CD = #{companyCd}
                             GROUP BY CONVERT(varchar(7), W1.END_YMD, 23)
                    ) MTBF_A
              GROUP BY YYYYMM
           ) MTBF_B
           UNION ALL
          SELECT '03' GUBUN_SEQ
               , 'MTBF(H)' GUBUN_ITEM
               , '달성율(%)' GUBUN_DIV
               , ISNULL(SUM(MON_01),0) MON_01
               , ISNULL(SUM(MON_02),0) MON_02
               , ISNULL(SUM(MON_03),0) MON_03
               , ISNULL(SUM(MON_04),0) MON_04
               , ISNULL(SUM(MON_05),0) MON_05
               , ISNULL(SUM(MON_06),0) MON_06
               , ISNULL(SUM(MON_07),0) MON_07
               , ISNULL(SUM(MON_08),0) MON_08
               , ISNULL(SUM(MON_09),0) MON_09
               , ISNULL(SUM(MON_10),0) MON_10
               , ISNULL(SUM(MON_11),0) MON_11
               , ISNULL(SUM(MON_12),0) MON_12
            FROM (
              SELECT CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-01') THEN ISNULL(CONVERT(INT, ROUND((SELECT ROUND(SUM(CYCLETIME) / 3600,0) FROM EQ0901W W2 WHERE CONVERT(varchar(7), W2.EVENTDATE , 23 )=  YYYYMM) / SUM(FAILURE_CNT),0)),0) ELSE 0 END * 100 / ISNULL((SELECT MON_01 FROM ST1001M WHERE KPI_DIV = 'MTBF' AND CONFIRM_YEAR = #{fYearDate}),0) MON_01
                   , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-02') THEN ISNULL(CONVERT(INT, ROUND((SELECT ROUND(SUM(CYCLETIME) / 3600,0) FROM EQ0901W W2 WHERE CONVERT(varchar(7), W2.EVENTDATE , 23 )=  YYYYMM) / SUM(FAILURE_CNT),0)),0) ELSE 0 END * 100 / ISNULL((SELECT MON_02 FROM ST1001M WHERE KPI_DIV = 'MTBF' AND CONFIRM_YEAR = #{fYearDate}),0) MON_02
                   , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-03') THEN ISNULL(CONVERT(INT, ROUND((SELECT ROUND(SUM(CYCLETIME) / 3600,0) FROM EQ0901W W2 WHERE CONVERT(varchar(7), W2.EVENTDATE , 23 )=  YYYYMM) / SUM(FAILURE_CNT),0)),0) ELSE 0 END * 100 / ISNULL((SELECT MON_03 FROM ST1001M WHERE KPI_DIV = 'MTBF' AND CONFIRM_YEAR = #{fYearDate}),0)  MON_03
                   , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-04') THEN ISNULL(CONVERT(INT, ROUND((SELECT ROUND(SUM(CYCLETIME) / 3600,0) FROM EQ0901W W2 WHERE CONVERT(varchar(7), W2.EVENTDATE , 23 )=  YYYYMM) / SUM(FAILURE_CNT),0)),0) ELSE 0 END * 100 / ISNULL((SELECT MON_04 FROM ST1001M WHERE KPI_DIV = 'MTBF' AND CONFIRM_YEAR = #{fYearDate}),0)  MON_04
                   , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-05') THEN ISNULL(CONVERT(INT, ROUND((SELECT ROUND(SUM(CYCLETIME) / 3600,0) FROM EQ0901W W2 WHERE CONVERT(varchar(7), W2.EVENTDATE , 23 )=  YYYYMM) / SUM(FAILURE_CNT),0)),0) ELSE 0 END * 100 / ISNULL((SELECT MON_05 FROM ST1001M WHERE KPI_DIV = 'MTBF' AND CONFIRM_YEAR = #{fYearDate}),0)  MON_05
                   , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-06') THEN ISNULL(CONVERT(INT, ROUND((SELECT ROUND(SUM(CYCLETIME) / 3600,0) FROM EQ0901W W2 WHERE CONVERT(varchar(7), W2.EVENTDATE , 23 )=  YYYYMM) / SUM(FAILURE_CNT),0)),0) ELSE 0 END * 100 / ISNULL((SELECT MON_06 FROM ST1001M WHERE KPI_DIV = 'MTBF' AND CONFIRM_YEAR = #{fYearDate}),0)  MON_06
                   , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-07') THEN ISNULL(CONVERT(INT, ROUND((SELECT ROUND(SUM(CYCLETIME) / 3600,0) FROM EQ0901W W2 WHERE CONVERT(varchar(7), W2.EVENTDATE , 23 )=  YYYYMM) / SUM(FAILURE_CNT),0)),0) ELSE 0 END * 100 / ISNULL((SELECT MON_07 FROM ST1001M WHERE KPI_DIV = 'MTBF' AND CONFIRM_YEAR = #{fYearDate}),0)  MON_07
                   , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-08') THEN ISNULL(CONVERT(INT, ROUND((SELECT ROUND(SUM(CYCLETIME) / 3600,0) FROM EQ0901W W2 WHERE CONVERT(varchar(7), W2.EVENTDATE , 23 )=  YYYYMM) / SUM(FAILURE_CNT),0)),0) ELSE 0 END * 100 / ISNULL((SELECT MON_08 FROM ST1001M WHERE KPI_DIV = 'MTBF' AND CONFIRM_YEAR = #{fYearDate}),0)  MON_08
                   , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-09') THEN ISNULL(CONVERT(INT, ROUND((SELECT ROUND(SUM(CYCLETIME) / 3600,0) FROM EQ0901W W2 WHERE CONVERT(varchar(7), W2.EVENTDATE , 23 )=  YYYYMM) / SUM(FAILURE_CNT),0)),0) ELSE 0 END * 100 / ISNULL((SELECT MON_09 FROM ST1001M WHERE KPI_DIV = 'MTBF' AND CONFIRM_YEAR = #{fYearDate}),0)  MON_09
                   , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-10') THEN ISNULL(CONVERT(INT, ROUND((SELECT ROUND(SUM(CYCLETIME) / 3600,0) FROM EQ0901W W2 WHERE CONVERT(varchar(7), W2.EVENTDATE , 23 )=  YYYYMM) / SUM(FAILURE_CNT),0)),0) ELSE 0 END * 100 / ISNULL((SELECT MON_10 FROM ST1001M WHERE KPI_DIV = 'MTBF' AND CONFIRM_YEAR = #{fYearDate}),0)  MON_10
                   , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-11') THEN ISNULL(CONVERT(INT, ROUND((SELECT ROUND(SUM(CYCLETIME) / 3600,0) FROM EQ0901W W2 WHERE CONVERT(varchar(7), W2.EVENTDATE , 23 )=  YYYYMM) / SUM(FAILURE_CNT),0)),0) ELSE 0 END * 100 / ISNULL((SELECT MON_11 FROM ST1001M WHERE KPI_DIV = 'MTBF' AND CONFIRM_YEAR = #{fYearDate}),0)  MON_11
                   , CASE WHEN YYYYMM = CONCAT(#{fYearDate}, '-12') THEN ISNULL(CONVERT(INT, ROUND((SELECT ROUND(SUM(CYCLETIME) / 3600,0) FROM EQ0901W W2 WHERE CONVERT(varchar(7), W2.EVENTDATE , 23 )=  YYYYMM) / SUM(FAILURE_CNT),0)),0) ELSE 0 END * 100 / ISNULL((SELECT MON_12 FROM ST1001M WHERE KPI_DIV = 'MTBF' AND CONFIRM_YEAR = #{fYearDate}),0)  MON_12
                FROM (
              SELECT CONVERT(varchar(7), W1.END_YMD, 23) YYYYMM, COUNT(E.EQ_NO) FAILURE_CNT
                         , SUM(DATEDIFF(MINUTE, CONVERT(CHAR(16), CONVERT(VARCHAR, W1.START_YMD + ' ' + W1.START_TIME + ':00', 120), 120), CONVERT(CHAR(16), CONVERT(VARCHAR, W1.END_YMD + ' ' +W1.END_TIME + ':00', 120), 120))) REPAIR_HOUR
                      FROM EQ0101M E
                     INNER JOIN WO0201M W1 ON (W1.COMPANY_CD = E.COMPANY_CD AND W1.EQ_NO = E.EQ_NO AND W1.WO_STS = 'YZ' AND CONVERT(varchar(4), W1.END_YMD , 23 )  = #{fYearDate})
                     WHERE E.COMPANY_CD = #{companyCd}
                     GROUP BY CONVERT(varchar(7), W1.END_YMD, 23)
               ) MTBF_A
               GROUP BY YYYYMM
               ) MTBF_B
            UNION ALL
			SELECT
                   '02' GUBUN_SEQ
                 , '설비정기점검율' GUBUN_ITEM
                 , '실적(건수)' GUBUN_DIV
                 , SUM(A.MON_01) MON_01
                 , SUM(A.MON_02) MON_02
                 , SUM(A.MON_03) MON_03
                 , SUM(A.MON_04) MON_04
                 , SUM(A.MON_05) MON_05
                 , SUM(A.MON_06) MON_06
                 , SUM(A.MON_07) MON_07
                 , SUM(A.MON_08) MON_08
                 , SUM(A.MON_09) MON_09
                 , SUM(A.MON_10) MON_10
                 , SUM(A.MON_11) MON_11
                 , SUM(A.MON_12) MON_12
              FROM (
                      SELECT '실적(건수)' EQ_DIV
                           , ISNULL(SUM(C.MON_01),0) MON_01
                           , ISNULL(SUM(C.MON_02),0) MON_02
                           , ISNULL(SUM(C.MON_03),0) MON_03
                           , ISNULL(SUM(C.MON_04),0) MON_04
                           , ISNULL(SUM(C.MON_05),0) MON_05
                           , ISNULL(SUM(C.MON_06),0) MON_06
                           , ISNULL(SUM(C.MON_07),0) MON_07
                           , ISNULL(SUM(C.MON_08),0) MON_08
                           , ISNULL(SUM(C.MON_09),0) MON_09
                           , ISNULL(SUM(C.MON_10),0) MON_10
                           , ISNULL(SUM(C.MON_11),0) MON_11
                           , ISNULL(SUM(C.MON_12),0) MON_12
                        FROM EQ_CMPLT C
                 ) A
	         GROUP BY A.EQ_DIV
	         UNION ALL
	        SELECT
                   '03' GUBUN_SEQ
                 , '설비정기점검율' GUBUN_ITEM
                 , '달성율(%)' GUBUN_DIV
                 , SUM(A.MON_01) MON_01
                 , SUM(A.MON_02) MON_02
                 , SUM(A.MON_03) MON_03
                 , SUM(A.MON_04) MON_04
                 , SUM(A.MON_05) MON_05
                 , SUM(A.MON_06) MON_06
                 , SUM(A.MON_07) MON_07
                 , SUM(A.MON_08) MON_08
                 , SUM(A.MON_09) MON_09
                 , SUM(A.MON_10) MON_10
                 , SUM(A.MON_11) MON_11
                 , SUM(A.MON_12) MON_12
              FROM (
                      SELECT '달성율(%)' EQ_DIV
                           , ROUND(ISNULL(((SUM(P.MON_01)/ SUM(C.MON_01)) * 100),0),2) MON_01
                           , ROUND(ISNULL(((SUM(P.MON_02)/ SUM(C.MON_02)) * 100),0),2) MON_02
                           , ROUND(ISNULL(((SUM(P.MON_03)/ SUM(C.MON_03)) * 100),0),2) MON_03
                           , ROUND(ISNULL(((SUM(P.MON_04)/ SUM(C.MON_04)) * 100),0),2) MON_04
                           , ROUND(ISNULL(((SUM(P.MON_05)/ SUM(C.MON_05)) * 100),0),2) MON_05
                           , ROUND(ISNULL(((SUM(P.MON_06)/ SUM(C.MON_06)) * 100),0),2) MON_06
                           , ROUND(ISNULL(((SUM(P.MON_07)/ SUM(C.MON_07)) * 100),0),2) MON_07
                           , ROUND(ISNULL(((SUM(P.MON_08)/ SUM(C.MON_08)) * 100),0),2) MON_08
                           , ROUND(ISNULL(((SUM(P.MON_09)/ SUM(C.MON_09)) * 100),0),2) MON_09
                           , ROUND(ISNULL(((SUM(P.MON_10)/ SUM(C.MON_10)) * 100),0),2) MON_10
                           , ROUND(ISNULL(((SUM(P.MON_11)/ SUM(C.MON_11)) * 100),0),2) MON_11
                           , ROUND(ISNULL(((SUM(P.MON_12)/ SUM(C.MON_12)) * 100),0),2) MON_12
                        FROM EQ_PLAN P
                       INNER JOIN EQ_CMPLT C ON C.EQ_NO = P.EQ_NO
                 ) A
          GROUP BY A.EQ_DIV

  	        ) A
        ORDER BY A.GUBUN_ITEM DESC, A.GUBUN_SEQ ASC
	</select>

	<update id="updateST1001PM" parameterType="map">
        <![CDATA[ /* st1001.updateST1001PM */ ]]>
        UPDATE ST1001M
          SET MON_01 = A_01
            , MON_02 = A_02
            , MON_03 = A_03
            , MON_04 = A_04
            , MON_05 = A_05
            , MON_06 = A_06
            , MON_07 = A_07
            , MON_08 = A_08
            , MON_09 = A_09
            , MON_10 = A_10
            , MON_11 = A_11
            , MON_12 =	A_12
         FROM (
                SELECT
                       SUM(A_01) AS A_01
                     , SUM(A_02) AS A_02
                     , SUM(A_03) AS A_03
                     , SUM(A_04) AS A_04
                     , SUM(A_05) AS A_05
                     , SUM(A_06) AS A_06
                     , SUM(A_07) AS A_07
                     , SUM(A_08) AS A_08
                     , SUM(A_09) AS A_09
                     , SUM(A_10) AS A_10
                     , SUM(A_11) AS A_11
                     , SUM(A_12) AS A_12
                  FROM (
                         SELECT
                               ISNULL((SELECT COUNT(CHK_NO) FROM IN0401M WHERE COMPANY_CD = #{companyCd} AND CHK_NO = X.CHK_NO AND SUBSTRING(REPLACE(ACTL_YMD,'-',''),0,7) = #{01} AND SUBSTRING(REPLACE(ACTL_YMD,'-',''),0,7) = #{01} GROUP BY CHK_NO),0) A_01
                              ,ISNULL((SELECT COUNT(CHK_NO) FROM IN0401M WHERE COMPANY_CD = #{companyCd} AND CHK_NO = X.CHK_NO AND SUBSTRING(REPLACE(ACTL_YMD,'-',''),0,7) = #{02} AND SUBSTRING(REPLACE(ACTL_YMD,'-',''),0,7) = #{02} GROUP BY CHK_NO),0) A_02
                              ,ISNULL((SELECT COUNT(CHK_NO) FROM IN0401M WHERE COMPANY_CD = #{companyCd} AND CHK_NO = X.CHK_NO AND SUBSTRING(REPLACE(ACTL_YMD,'-',''),0,7) = #{03} AND SUBSTRING(REPLACE(ACTL_YMD,'-',''),0,7) = #{03} GROUP BY CHK_NO),0) A_03
                              ,ISNULL((SELECT COUNT(CHK_NO) FROM IN0401M WHERE COMPANY_CD = #{companyCd} AND CHK_NO = X.CHK_NO AND SUBSTRING(REPLACE(ACTL_YMD,'-',''),0,7) = #{04} AND SUBSTRING(REPLACE(ACTL_YMD,'-',''),0,7) = #{04} GROUP BY CHK_NO),0) A_04
                              ,ISNULL((SELECT COUNT(CHK_NO) FROM IN0401M WHERE COMPANY_CD = #{companyCd} AND CHK_NO = X.CHK_NO AND SUBSTRING(REPLACE(ACTL_YMD,'-',''),0,7) = #{05} AND SUBSTRING(REPLACE(ACTL_YMD,'-',''),0,7) = #{05} GROUP BY CHK_NO),0) A_05
                              ,ISNULL((SELECT COUNT(CHK_NO) FROM IN0401M WHERE COMPANY_CD = #{companyCd} AND CHK_NO = X.CHK_NO AND SUBSTRING(REPLACE(ACTL_YMD,'-',''),0,7) = #{06} AND SUBSTRING(REPLACE(ACTL_YMD,'-',''),0,7) = #{06} GROUP BY CHK_NO),0) A_06
                              ,ISNULL((SELECT COUNT(CHK_NO) FROM IN0401M WHERE COMPANY_CD = #{companyCd} AND CHK_NO = X.CHK_NO AND SUBSTRING(REPLACE(ACTL_YMD,'-',''),0,7) = #{07} AND SUBSTRING(REPLACE(ACTL_YMD,'-',''),0,7) = #{07} GROUP BY CHK_NO),0) A_07
                              ,ISNULL((SELECT COUNT(CHK_NO) FROM IN0401M WHERE COMPANY_CD = #{companyCd} AND CHK_NO = X.CHK_NO AND SUBSTRING(REPLACE(ACTL_YMD,'-',''),0,7) = #{08} AND SUBSTRING(REPLACE(ACTL_YMD,'-',''),0,7) = #{08} GROUP BY CHK_NO),0) A_08
                              ,ISNULL((SELECT COUNT(CHK_NO) FROM IN0401M WHERE COMPANY_CD = #{companyCd} AND CHK_NO = X.CHK_NO AND SUBSTRING(REPLACE(ACTL_YMD,'-',''),0,7) = #{09} AND SUBSTRING(REPLACE(ACTL_YMD,'-',''),0,7) = #{09} GROUP BY CHK_NO),0) A_09
                              ,ISNULL((SELECT COUNT(CHK_NO) FROM IN0401M WHERE COMPANY_CD = #{companyCd} AND CHK_NO = X.CHK_NO AND SUBSTRING(REPLACE(ACTL_YMD,'-',''),0,7) = #{10} AND SUBSTRING(REPLACE(ACTL_YMD,'-',''),0,7) = #{10} GROUP BY CHK_NO),0) A_10
                              ,ISNULL((SELECT COUNT(CHK_NO) FROM IN0401M WHERE COMPANY_CD = #{companyCd} AND CHK_NO = X.CHK_NO AND SUBSTRING(REPLACE(ACTL_YMD,'-',''),0,7) = #{11} AND SUBSTRING(REPLACE(ACTL_YMD,'-',''),0,7) = #{11} GROUP BY CHK_NO),0) A_11
                              ,ISNULL((SELECT COUNT(CHK_NO) FROM IN0401M WHERE COMPANY_CD = #{companyCd} AND CHK_NO = X.CHK_NO AND SUBSTRING(REPLACE(ACTL_YMD,'-',''),0,7) = #{12} AND SUBSTRING(REPLACE(ACTL_YMD,'-',''),0,7) = #{12} GROUP BY CHK_NO),0) A_12
                           FROM IN0201M X, EQ0101M Y
                          WHERE X.EQ_NO = Y.EQ_NO
                            AND X.COMPANY_CD = Y.COMPANY_CD
                            AND X.COMPANY_CD = #{companyCd}
                            AND X.PM_TP = 'T'
                            AND X.ACT_YN = 'Y'
                            AND X.DAY_YN = 'N'
                            AND ISNULL(CYCLE_CD,'') != ''
                            AND ISNULL(CYCLE_TP,'') != ''
                        ) A
             ) AA
         WHERE ST1001M.CONFIRM_YEAR = #{fYearDate}
           AND ST1001M.KPI_DIV = 'PM'
    </update>
</mapper>