<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--************************************************************************************
* Program Name : 점검결과 작성
* Description : 점검결과 작성 검색
* Author : jit13
* Created Date :
* SQL 목록
***************************************************************************************
* SQLID                 설명
***************************************************************************************
* retrieveIN0401    : 점검결과 작성 조회
* retrieveIN0401Sub : 점검결과 작성 상세목록 조회
*************************************************************************************-->
<mapper namespace="in0801">
    <!-- 점검결과 조회 -->
    <select id="retrieveIN0801" parameterType="map" resultType="map" >
        <![CDATA[ /* in0801.retrieveIN0801 */ ]]>
        SELECT A.EQ_NO
             , A.COMPANY_CD
             , dbo.FN_NAME(A.EQ_NO, 'EQUIP') AS EQ_NM
             , A.CHK_NM
             , A.ACTL_YMD
             , A.CHK_NO
             , A.CYCLE_CD
             , A.CYCLE_TP
             , A.CYCLE_DESC
             , A.CHK_SCHD_NO
             , A.CMPLT_YN
             , A.CHK_DTL_NO
             , A.SEQ_NO
             , A.CHK_DTL_NM
             , A.CHK_PART_DESC
             , A.CMMNT
             , A.INPUT_AVAILABLE
             , A.INPUT_AVAILABLE_DATE
             , A.INPUT_TP
             , CASE WHEN INPUT_TP = 'STS' THEN ''
               ELSE CONVERT(VARCHAR, A.CHK_STD_VAL) END CHK_STD_VAL
             , CASE WHEN INPUT_TP = 'STS' THEN ''
               ELSE CONVERT(VARCHAR, A.CHK_MIN_VAL) END CHK_MIN_VAL
             , CASE WHEN INPUT_TP = 'STS' THEN ''
               ELSE CONVERT(VARCHAR, A.CHK_MAX_VAL) END CHK_MAX_VAL
             , CASE WHEN INPUT_TP = 'STS' THEN ''
               ELSE CONVERT(VARCHAR, A.WARN_MIN_VAL) END WARN_MIN_VAL
             , CASE WHEN INPUT_TP = 'STS' THEN ''
               ELSE CONVERT(VARCHAR, A.WARN_MAX_VAL) END WARN_MAX_VAL
             , CASE WHEN INPUT_TP = 'STS' THEN ''
               ELSE CONVERT(VARCHAR, R.CHK_VAL) END CHK_VAL
             , A.UNIT_CD
             , (SELECT UNIT_NM FROM CO0401M WHERE UNIT_CD = A.UNIT_CD AND COMPANY_CD = #{companyCd}) UNIT_NM
             , R.CHK_STS
             , R.FILE_ATCH_ID
             , (SELECT COUNT(*) FROM SC_FILE WHERE FILE_ATCH_ID = R.FILE_ATCH_ID) AS FILE_CNT
             , R.CMMNT RESULT_CMMNT
             , R.CHK_YMD
             , R.CHK_TIME
             , R.CHK_USER_ID
             , (SELECT USER_NM FROM SC_USER WHERE USER_ID = R.CHK_USER_ID AND COMPANY_CD = #{companyCd}) CHK_USER_DESC
             , R.CHK_RSLT_NO
             , A.UNCHK_CMMNT
          FROM (
                SELECT CH.EQ_NO
                     , CH.COMPANY_CD
                     , CH.CHK_NM
                     , RH.ACTL_YMD
                     , CH.CHK_NO
                     , CH.CYCLE_CD
                     , CH.CYCLE_TP
                     , (CH.CYCLE_CD + ' ' + dbo.FN_NAME(CH.CYCLE_TP, 'PERIOD_TYPE')) CYCLE_DESC
                     , RH.CHK_SCHD_NO
                     , RH.CMPLT_YN
                     , C1.CHK_DTL_NO
                     , C1.SEQ_NO
                     , C1.CHK_DTL_NM
                     , C1.CHK_PART_DESC
                     , C1.CMMNT
                     , CASE WHEN RH.ACTL_YMD > LIMIT_DATE.LAST_AVAILABLE_DATE THEN 'NOT' ELSE '' END INPUT_AVAILABLE
                     , LIMIT_DATE.LAST_AVAILABLE_DATE INPUT_AVAILABLE_DATE
                     , C1.INPUT_TP
                     , C1.UNIT_CD
                     , C1.CHK_STD_VAL
                     , C1.CHK_MIN_VAL
                     , C1.CHK_MAX_VAL
                     , C1.WARN_MIN_VAL
                     , C1.WARN_MAX_VAL
                     , RH.CMMNT AS UNCHK_CMMNT
                  FROM IN0201M CH
                 INNER JOIN IN0401M RH ON (RH.CHK_NO = CH.CHK_NO AND CH.COMPANY_CD = #{companyCd})
                  LEFT OUTER JOIN IN0201D_R C1 ON (C1.CHK_NO = CH.CHK_NO AND C1.CHK_REV_SEQ = RH.CHK_REV_SEQ AND C1.COMPANY_CD = CH.COMPANY_CD)
                     , (SELECT CONVERT(VARCHAR,GETDATE() + 7 - DATEPART(WEEKDAY,GETDATE()),23) LAST_AVAILABLE_DATE ) LIMIT_DATE
                 WHERE 1=1
                   AND CH.COMPANY_CD = #{companyCd}
                <if test="feqNo != null &amp;&amp; feqNo != ''">
                   AND CH.EQ_NO = #{feqNo}
                </if>
                   <if test="forgCd != null &amp;&amp; forgCd != ''">
                   AND CH.ORG_CD = #{forgCd}
                </if>
                <if test="fStartActlDate != null &amp;&amp; fStartActlDate != '' &amp;&amp; fEndActlDate != null &amp;&amp; fEndActlDate != ''">
                   AND RH.ACTL_YMD   BETWEEN   #{fStartActlDate} AND  #{fEndActlDate}
                </if>
                   ) A
                 LEFT OUTER JOIN IN0401D R ON (R.CHK_SCHD_NO = A.CHK_SCHD_NO AND R.CHK_DTL_NO = A.CHK_DTL_NO AND R.COMPANY_CD = A.COMPANY_CD)
         WHERE 1=1
        <if test='fcmpltYn != null &amp;&amp; !fcmpltYn.equals("A")'>
          <if test='fcmpltYn.equals("Y")'>
           AND A.CMPLT_YN = 'Y'
          </if>
          <if test='fcmpltYn.equals("N")'>
           AND A.CMPLT_YN = 'N'
          </if>
        </if>
        <if test="fchkUserId != null &amp;&amp; fchkUserId != ''">
           AND UPPER(R.CHK_USER_ID) LIKE '%' + UPPER(#{fchkUserId}) + '%'
        </if>
        <if test="fchkNm != null &amp;&amp; fchkNm != ''">
           AND UPPER(A.CHK_NM) LIKE '%' + UPPER(#{fchkNm}) + '%'
        </if>
         ORDER BY A.ACTL_YMD, A.CHK_NO, CAST(A.SEQ_NO AS INT) ASC
    </select>

    <!-- 점검결과 저장  -->
    <insert id="saveIN0801List" parameterType="map" >
        <![CDATA[ /* in0801.saveIN0801List */ ]]>
        INSERT INTO IN0401D (
               CHK_VAL
             , COMPANY_CD
             , CHK_STS
             , CHK_YMD
             , CHK_TIME
             , ACTL_YMD
             , HAND_YN
             , EQ_NO
             , CHK_DTL_NO
             , CMMNT
             , CHK_USER_ID
             , CHK_RSLT_NO
             , CHK_SCHD_NO
             , FILE_ATCH_ID
             , FST_REG_DT
             , FST_REG_USER_ID
             , FNL_EDIT_DT
             , FNL_EDIT_USER_ID
        )
        VALUES (
               #{chkVal}
             , #{companyCd}
             , #{chkSts}
             <if test="chkYmd == ''">
             , CONVERT(VARCHAR,GETDATE(), 23)
             </if>
             <if test="chkYmd != ''">
             , #{chkYmd}
             </if>
             , REPLACE(CONVERT(VARCHAR(5),GETDATE(),24),':','')
             , #{actlYmd}
             , 'Y'
             , #{eqNo}
             , #{chkDtlNo}
             , #{resultCmmnt}
             , #{chkUserId}
             , NEXT VALUE FOR DBO.SQIN_CHECK_RESULT_01
             , #{chkSchdNo}
             <if test="fileAtchId == ''">
             , null
             </if>
             <if test="fileAtchId != ''">
             , #{fileAtchId}
             </if>
             , GETDATE()
             , #{fstRegUserId}
             , GETDATE()
             , #{fnlEditUserId}
        )
    </insert>

    <!-- 점검결과 수정  -->
    <update id="updateIN0801List" parameterType="map" >
        <![CDATA[ /* in0801.updateIN0801List */ ]]>
        UPDATE IN0401D
           SET
               CHK_VAL          = #{chkVal}
             , CHK_STS          = #{chkSts}
             , CMMNT            = #{resultCmmnt}
             , HAND_YN          = 'Y'
             , CHK_USER_ID      = ISNULL(#{chkUserId},#{fnlEditUserId})
             <if test="chkYmd == ''">
             , CHK_YMD          = CONVERT(VARCHAR,GETDATE(), 23)
             </if>
             <if test="chkYmd != ''">
             , CHK_YMD          = #{chkYmd}
             </if>
             , CHK_TIME         = REPLACE(CONVERT(VARCHAR(5),GETDATE(),24),':','')
             <if test="fileAtchId == ''">
             , FILE_ATCH_ID     = null
             </if>
             <if test="fileAtchId != ''">
             , FILE_ATCH_ID     = #{fileAtchId}
             </if>
             , FNL_EDIT_DT    = GETDATE()
             , FNL_EDIT_USER_ID = #{fnlEditUserId}
         WHERE CHK_RSLT_NO = #{chkRsltNo}
           AND COMPANY_CD = #{companyCd}
    </update>

    <!-- 스케쥴내의 모든 점검항목에 대한 결과가 입력되었을 경우에만 완료처리-->
    <!-- 완료일자는 점검결과의 점검일자중 최대값을 가져온다 -->
    <update id="updateIN0801CompleteCheck" parameterType="map" >
        <![CDATA[ /* in0801.updateIN0801CompleteCheck */ ]]>
        UPDATE IN0401M SET CMPLT_YN = 'Y', CMPL_YMD = CONVERT(VARCHAR, GETDATE(),23)
         WHERE CHK_NO = #{chkNo}
          AND COMPANY_CD = #{companyCd}
          AND ACTL_YMD = #{actlYmd}
          AND (SELECT COUNT(*) CNT
                 FROM IN0401M X
                 LEFT OUTER JOIN IN0201D Y ON (X.CHK_NO = Y.CHK_NO AND X.COMPANY_CD = Y.COMPANY_CD)
                INNER JOIN IN0201M Z ON (X.CHK_NO = Z.CHK_NO AND X.COMPANY_CD = Z.COMPANY_CD)
                WHERE X.CHK_NO = #{chkNo}
                  AND X.COMPANY_CD = #{companyCd}
                  AND Z.DAY_YN = 'N'
                  AND X.ACTL_YMD = #{actlYmd}) =
              (SELECT COUNT(*) CNT
                 FROM IN0401D A
                INNER JOIN IN0401M B ON (A.CHK_SCHD_NO = B.CHK_SCHD_NO AND A.COMPANY_CD = B.COMPANY_CD)
                INNER JOIN IN0201M C ON (B.CHK_NO = C.CHK_NO AND B.COMPANY_CD = C.COMPANY_CD)
                WHERE B.CHK_NO = #{chkNo}
                  AND A.COMPANY_CD = #{companyCd}
                  AND C.DAY_YN = 'N'
                  AND B.ACTL_YMD = #{actlYmd}
                  AND A.CHK_STS IS NOT NULL
                  AND A.CHK_STS != ''
              )
    </update>

    <update id="updateIN0801LastCheckYmd" parameterType="map">
        <![CDATA[ /* in0801.updateIN0801LastCheckYmd */ ]]>
        UPDATE IN0201M
           SET LAST_CHK_YMD = (SELECT MAX(CMPL_YMD)
                                   FROM IN0401M M
                                  WHERE M.CHK_NO = CHK_NO
                                    AND CMPLT_YN = 'Y' AND M.COMPANY_CD = #{companyCd})
         WHERE CHK_NO   = #{chkNo}
           AND COMPANY_CD = #{companyCd}
           AND ISNULL(LAST_CHK_YMD,'0000-00-00') <![CDATA[ < ]]> (SELECT MAX(CMPL_YMD)
                                                                 FROM IN0401M M
                                                                WHERE M.CHK_NO = CHK_NO AND M.COMPANY_CD = #{companyCd}
                                                                  AND CMPLT_YN = 'Y')
    </update>
</mapper>