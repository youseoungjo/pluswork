<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--************************************************************************************
* Program Name : 점검결과 작성
* Description : 점검결과 작성 검색
* Author : jit13
* Created Date :
* SQL 목록
***************************************************************************************
* SQLID                 설명
***************************************************************************************
* retrieveIN0401    : 점검결과 작성 조회
* retrieveIN0401Sub : 점검결과 작성 상세목록 조회
*************************************************************************************-->
<mapper namespace="in0401">
    <!-- 점검결과 작성 조회 -->
    <select id="retrieveIN0401" parameterType="map" resultType="map" >
        <![CDATA[ /* in0401.retrieveIN0401 */ ]]>
        SELECT X.ORG_CD
             , X.COMPANY_CD
             , dbo.FN_NAME(X.ORG_CD, 'DEPT') ORG_CD_DESC
             , Y.EQ_NO
             , Y.EQ_NM
             , X.CHK_NM
             , M.ACTL_YMD
             , X.CYCLE_CD
             , X.CYCLE_TP
             , (X.CYCLE_CD + ' ' + dbo.FN_NAME(X.CYCLE_TP, 'CYCLE_TP')) CYCLE_DESC
             , X.CHK_NO
             , M.CHK_SCHD_NO
             , M.CMPLT_YN
             , CASE M.CMPLT_YN WHEN 'Y' THEN M.CMPL_YMD
               ELSE ''
               END CMPL_YMD
            , CASE WHEN M.CMPLT_YN =  'Y' THEN CONVERT(VARCHAR,COUNT(DISTINCT R.CHK_RSLT_NO))
              ELSE CASE WHEN COUNT(DISTINCT R.CHK_RSLT_NO) = 0 THEN CONVERT(VARCHAR,COUNT(DISTINCT C1.CHK_DTL_NO))
                   ELSE CONCAT(COUNT(DISTINCT R.CHK_RSLT_NO),' of ',COUNT(DISTINCT C1.CHK_DTL_NO)) END
               END RESULT_COUNT
             , M.CMMNT
          FROM IN0201M X
         INNER JOIN EQ0101M Y ON (Y.EQ_NO = X.EQ_NO AND Y.COMPANY_CD = X.COMPANY_CD)
         INNER JOIN IN0401M M ON (M.CHK_NO = X.CHK_NO AND M.COMPANY_CD = X.COMPANY_CD)
          LEFT OUTER JOIN IN0201D C1 ON (C1.CHK_NO = X.CHK_NO AND C1.COMPANY_CD = X.COMPANY_CD)
          LEFT OUTER JOIN IN0401D R ON (R.CHK_SCHD_NO = M.CHK_SCHD_NO AND R.COMPANY_CD = M.COMPANY_CD)
         WHERE Y.REV_NO = #{revNo}
           AND X.COMPANY_CD = #{companyCd}
           AND X.DAY_YN = 'N'
        <if test="fStartActlDate != null &amp;&amp; fStartActlDate != '' &amp;&amp; fEndActlDate != null &amp;&amp; fEndActlDate != ''">
           AND M.ACTL_YMD   BETWEEN   #{fStartActlDate} AND  #{fEndActlDate}
        </if>
        <if test="fStartCmplDate != null &amp;&amp; fStartCmplDate != '' &amp;&amp; fEndCmplDate != null &amp;&amp; fEndCmplDate != ''">
           AND M.CMPL_YMD   BETWEEN   #{fStartCmplDate} AND  #{fEndCmplDate}
        </if>
        <if test="feqNo != null &amp;&amp; feqNo != ''">
           AND X.EQ_NO = #{feqNo}
        </if>
        <if test="fchkNm != null &amp;&amp; fchkNm != ''">
           AND UPPER(X.CHK_NM) LIKE '%' + UPPER(#{fchkNm}) + '%'
        </if>
        <if test="forgCd != null &amp;&amp; forgCd != ''">
           AND X.ORG_CD = #{forgCd}
        </if>
        <if test='fcmpltYn != null &amp;&amp; !fcmpltYn.equals("A")'>
          <if test='fcmpltYn.equals("Y")'>
           AND M.CMPLT_YN = 'Y'
          </if>
          <if test='fcmpltYn.equals("N")'>
           AND M.CMPLT_YN = 'N'
          </if>
        </if>
         GROUP BY X.COMPANY_CD, X.ORG_CD, Y.EQ_NO, Y.ITEM_NO, Y.EQ_NM, X.CHK_NO, X.CHK_NM, X.CYCLE_CD, X.CYCLE_TP, M.CHK_SCHD_NO, M.ACTL_YMD, M.CMPLT_YN, M.CMPL_YMD, M.CMMNT
         ORDER BY X.ORG_CD, Y.ITEM_NO, X.CHK_NM, M.ACTL_YMD, X.CYCLE_TP, X.CHK_NO

    </select>

    <!-- 점검결과 상세조회 -->
    <select id="retrieveIN0401Sub" parameterType="map" resultType="map" >
        <![CDATA[ /* in0401.retrieveIN0401Sub */ ]]>
        SELECT
               A.EQ_NO
             , A.COMPANY_CD
             , A.CHK_NM
             , A.ACTL_YMD
             , A.CHK_NO
             , A.CYCLE_CD
             , A.CYCLE_TP
             , DBO.FN_NAME(A.CYCLE_TP, 'CYCLE_TP') AS CYCLE_DESC
             , A.CHK_SCHD_NO
             , A.CMPLT_YN
             , A.CHK_DTL_NO
             , A.SEQ_NO
             , A.CHK_DTL_NM
             , A.CHK_PART_DESC
             , A.CMMNT
             , A.INPUT_AVAILABLE
             , A.INPUT_AVAILABLE_DATE
             , A.INPUT_TP
             , CASE WHEN INPUT_TP = 'STS' THEN ''
			   ELSE CONVERT(VARCHAR, A.CHK_STD_VAL) END CHK_STD_VAL
             , CASE WHEN INPUT_TP = 'STS' THEN ''
			   ELSE CONVERT(VARCHAR, A.CHK_MIN_VAL) END CHK_MIN_VAL
             , CASE WHEN INPUT_TP = 'STS' THEN ''
			   ELSE CONVERT(VARCHAR, A.CHK_MAX_VAL) END CHK_MAX_VAL
             , CASE WHEN INPUT_TP = 'STS' THEN ''
			   ELSE CONVERT(VARCHAR, A.WARN_MIN_VAL) END WARN_MIN_VAL
             , CASE WHEN INPUT_TP = 'STS' THEN ''
			   ELSE CONVERT(VARCHAR, A.WARN_MAX_VAL) END WARN_MAX_VAL
             , CASE WHEN INPUT_TP = 'STS' THEN ''
			   ELSE CONVERT(VARCHAR, R.CHK_VAL) END CHK_VAL
             , A.UNIT_CD
             , (SELECT UNIT_NM FROM CO0401M WHERE UNIT_CD = A.UNIT_CD) UNIT_NM
             , R.CHK_STS
             , R.FILE_ATCH_ID
             , R.CMMNT RESULT_CMMNT
             , ISNULL(R.CHK_YMD, CONVERT(VARCHAR, GETDATE(), 23)) AS CHK_YMD
             , R.CHK_TIME
             , R.CHK_USER_ID
             , (SELECT USER_NM FROM SC_USER WHERE USER_ID = R.CHK_USER_ID AND COMPANY_CD = #{companyCd}) CHK_USER_DESC
             , R.CHK_RSLT_NO
          FROM (
                 SELECT
                        CH.EQ_NO
                      , CH.COMPANY_CD
                      , CH.CHK_NM
                      , RH.ACTL_YMD
                      , CH.CHK_NO
                      , CH.CYCLE_CD
                      , CH.CYCLE_TP
                      , (CH.CYCLE_CD + ' ' + dbo.FN_NAME(CH.CYCLE_TP, 'CYCLE_TP')) CYCLE_DESC
                      , RH.CHK_SCHD_NO
                      , RH.CMPLT_YN
                      , C1.CHK_DTL_NO
                      , C1.SEQ_NO
                      , C1.CHK_DTL_NM
                      , C1.CHK_PART_DESC
                      , C1.CMMNT
                      , CASE WHEN RH.ACTL_YMD > LIMIT_DATE.LAST_AVAILABLE_DATE THEN 'NOT' ELSE '' END INPUT_AVAILABLE
                      , LIMIT_DATE.LAST_AVAILABLE_DATE INPUT_AVAILABLE_DATE
                      , C1.INPUT_TP
                      , C1.UNIT_CD
                      , C1.CHK_STD_VAL
                      , C1.CHK_MIN_VAL
                      , C1.CHK_MAX_VAL
                      , C1.WARN_MIN_VAL
                      , C1.WARN_MAX_VAL
                   FROM IN0201M CH
                  INNER JOIN IN0401M RH ON (RH.CHK_NO = CH.CHK_NO AND RH.COMPANY_CD = CH.COMPANY_CD)
                   LEFT OUTER JOIN IN0201D_R C1 ON (C1.CHK_NO = CH.CHK_NO AND C1.CHK_REV_SEQ = RH.CHK_REV_SEQ AND C1.COMPANY_CD = RH.COMPANY_CD)
<!--                    LEFT OUTER JOIN IN0201D_R C1 ON (C1.CHK_NO = CH.CHK_NO AND C1.CHK_REV_SEQ = RH.CHK_REV_SEQ) -->
                   ,(SELECT CONVERT(VARCHAR,GETDATE() + 7 - DATEPART(WEEKDAY,GETDATE()),23) LAST_AVAILABLE_DATE ) LIMIT_DATE
                  WHERE CH.DAY_YN = 'N'
                    AND CH.COMPANY_CD = #{companyCd}
                    AND CH.EQ_NO = #{eqNo}
                    AND CH.ORG_CD = #{orgCd}
                 <if test="fStartActlDate != null &amp;&amp; fStartActlDate != '' &amp;&amp; fEndActlDate != null &amp;&amp; fEndActlDate != ''">
                    AND RH.ACTL_YMD   BETWEEN   #{fStartActlDate} AND  #{fEndActlDate}
                 </if>
                 <if test="fStartCmplDate != null &amp;&amp; fStartCmplDate != '' &amp;&amp; fEndCmplDate != null &amp;&amp; fEndCmplDate != ''">
                    AND RH.CMPL_YMD   BETWEEN   #{fStartCmplDate} AND  #{fEndCmplDate}
                 </if>
               ) A
             LEFT OUTER JOIN IN0401D R ON (R.CHK_SCHD_NO = A.CHK_SCHD_NO AND R.CHK_DTL_NO = A.CHK_DTL_NO AND R.COMPANY_CD = A.COMPANY_CD)
         WHERE 1=1
           AND A.CHK_NO = #{chkNo}
           AND A.COMPANY_CD = #{companyCd}

         ORDER BY CAST(A.SEQ_NO AS INT) ASC
    </select>

    <!-- 점검결과 저장  -->
    <insert id="saveIN0401ListSub" parameterType="map" >
        <![CDATA[ /* in0401.saveIN0401ListSub */ ]]>
        INSERT INTO IN0401D (
               CHK_VAL
             , COMPANY_CD
             , CHK_STS
             , CHK_YMD
             , CHK_TIME
             , ACTL_YMD
             , HAND_YN
             , EQ_NO
             , CHK_DTL_NO
             , CMMNT
             , CHK_USER_ID
             , CHK_RSLT_NO
             , CHK_SCHD_NO
             , FILE_ATCH_ID
             , FST_REG_DT
             , FST_REG_USER_ID
             , FNL_EDIT_DT
             , FNL_EDIT_USER_ID
        )
        VALUES (
               #{chkVal}
             , #{companyCd}
             , #{chkSts}
             <if test="chkYmd == ''">
             , CONVERT(VARCHAR,GETDATE(),23)
             </if>
             <if test="chkYmd != ''">
             , #{chkYmd}
             </if>
             , REPLACE(CONVERT(VARCHAR(5),GETDATE(),24),':','')
             , #{actlYmd}
             , 'Y'
             , #{eqNo}
             , #{chkDtlNo}
             , #{resultCmmnt}
             , #{chkUserId}
             , NEXT VALUE FOR DBO.SQIN_CHECK_RESULT_01
             , #{chkSchdNo}
             <if test="fileAtchId == ''">
             , null
             </if>
             <if test="fileAtchId != ''">
             , #{fileAtchId}
             </if>
             , GETDATE()
             , #{fstRegUserId}
             , GETDATE()
             , #{fnlEditUserId}
        )
    </insert>

    <!-- 점검결과 수정  -->
    <update id="updateIN0401ListSub" parameterType="map" >
        <![CDATA[ /* in0401.updateIN0401ListSub */ ]]>
        UPDATE IN0401D
           SET
               CHK_VAL          = #{chkVal}
             , CHK_STS          = #{chkSts}
             , CMMNT            = #{resultCmmnt}
             , HAND_YN          = 'Y'
             , CHK_USER_ID      = ISNULL(#{chkUserId},#{fnlEditUserId})
             <if test="chkYmd == ''">
             , CHK_YMD          = CONVERT(VARCHAR,GETDATE(), 23)
             </if>
             <if test="chkYmd != ''">
             , CHK_YMD          = #{chkYmd}
             </if>
             , CHK_TIME         = REPLACE(CONVERT(VARCHAR(5),GETDATE(),24),':','')
             <if test="fileAtchId == ''">
             , FILE_ATCH_ID     = null
             </if>
             <if test="fileAtchId != ''">
             , FILE_ATCH_ID     = #{fileAtchId}
             </if>
             , FNL_EDIT_DT    = GETDATE()
             , FNL_EDIT_USER_ID = #{fnlEditUserId}
         WHERE CHK_RSLT_NO = #{chkRsltNo}
           AND COMPANY_CD  = #{companyCd}
    </update>

    <!-- 스케쥴내의 모든 점검항목에 대한 결과가 입력되었을 경우에만 완료처리-->
    <!-- 완료일자는 점검결과의 점검일자중 최대값을 가져온다 -->
    <update id="updateIN0401CompleteCheck" parameterType="map" >
        <![CDATA[ /* in0401.updateIN0401CompleteCheck */ ]]>
        UPDATE IN0401M
           SET
                CMPL_YMD = ISNULL((SELECT MAX(CHK_YMD)
                                     FROM IN0401D D
                                    INNER JOIN IN0401M M ON (D.CHK_SCHD_NO = M.CHK_SCHD_NO AND D.COMPANY_CD = M.COMPANY_CD)
                                    WHERE D.COMPANY_CD = #{companyCd}
                                    )
                                  , CONVERT(VARCHAR,GETDATE(), 23))
              , CMPLT_YN      = 'Y'
          WHERE CHK_SCHD_NO = #{chkSchdNo}
            AND COMPANY_CD  = #{companyCd}
    </update>

    <update id="updateIN0401LastCheckYmd" parameterType="map">
        <![CDATA[ /* in0401.updateIN0401LastCheckYmd */ ]]>
        UPDATE IN0201M
           SET
               LAST_CHK_YMD = (SELECT MAX(CMPL_YMD)
                                   FROM IN0401M X
								  INNER JOIN IN0201M Y ON (X.CHK_NO = Y.CHK_NO AND X.COMPANY_CD = Y.COMPANY_CD)
                                  WHERE CMPLT_YN = 'Y' AND X.COMPANY_CD = #{companyCd})
         WHERE CHK_NO   = #{chkNo}
           AND COMPANY_CD = #{companyCd}
           AND ISNULL(LAST_CHK_YMD,'00000000') <![CDATA[ < ]]> (SELECT MAX(CMPL_YMD)
                                                                 FROM IN0401M A
                                                                INNER JOIN IN0201M B ON (A.CHK_NO = B.CHK_NO AND A.COMPANY_CD = B.COMPANY_CD)
                                                                WHERE CMPLT_YN = 'Y' AND A.COMPANY_CD = #{companyCd})
    </update>
</mapper>