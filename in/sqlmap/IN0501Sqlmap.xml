<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--************************************************************************************
* Program Name : 점검결과 검색
* Description : 점검결과 검색
* Author : jit13
* Created Date :
* SQL 목록
***************************************************************************************
* SQLID                 설명
***************************************************************************************
* retrieveIN0501    : 점검결과 목록 조회
* retrieveIN0501Sub : 점검결과 항목 조회
*************************************************************************************-->
<mapper namespace="in0501">
    <!-- 점검결과 목록 조회 -->
    <select id="retrieveIN0501" parameterType="map" resultType="map" >
        <![CDATA[ /* in0501.retrieveIN0501 */ ]]>
        SELECT DISTINCT
               X.CHK_TP
             , X.COMPANY_CD
             , X.ORG_CD
             , dbo.FN_NAME(X.ORG_CD, 'DEPT') ORG_CD_DESC
             , Z.EQ_NO
             , Z.EQ_NM
             , X.CHK_NM
             , (X.ORG_CD  +  '_doosungcmms_'  +  X.EQ_NO  +  '_doosungcmms_'  +  X.CHK_NM) HDR_KEY
          FROM IN0201M X,  EQ0101M Z
         WHERE X.EQ_NO  = Z.EQ_NO
           AND X.COMPANY_CD = Z.COMPANY_CD
           AND Z.REV_NO = #{revNo}
           AND X.COMPANY_CD = #{companyCd}
           AND EXISTS (SELECT 1
                         FROM IN0401M R, IN0401D Z1
                        WHERE R.CHK_SCHD_NO = Z1.CHK_SCHD_NO
                          AND R.COMPANY_CD = Z1.COMPANY_CD
                          AND R.COMPANY_CD = #{companyCd}
                          AND R.CHK_NO = X.CHK_NO
                          AND R.CMPLT_YN = 'Y'
                       <if test="fStartDate != null &amp;&amp; fStartDate != ''">
                          AND R.CMPL_YMD <![CDATA[ >= ]]> #{fStartDate}
                       </if>
                       <if test="fEndDate != null &amp;&amp; fEndDate != ''">
                          AND R.CMPL_YMD <![CDATA[ <= ]]> #{fEndDate}
                       </if>
                       <if test="fchkUserId != null &amp;&amp; fchkUserId != ''">
                          AND UPPER(Z1.CHK_USER_ID) LIKE '%' + UPPER(#{fchkUserId}) + '%'
                       </if>
                      )
        <if test="fchkNm != null &amp;&amp; fchkNm != ''">
           AND UPPER(CHK_NM) LIKE '%' + UPPER(#{fchkNm}) + '%'
        </if>
        <if test="feqNo != null &amp;&amp; feqNo != ''">
           AND EXISTS (SELECT 1
                         FROM EQ0101M J
                        WHERE J.EQ_NO  = #{companyCd}
                          AND J.REV_NO = #{revNo}
                          AND J.EQ_NO  = #{feqNo})
        </if>
        <if test="forgCd != null &amp;&amp; forgCd != ''">
           AND X.ORG_CD = #{forgCd}
        </if>
         ORDER BY X.ORG_CD, Z.EQ_NO, X.CHK_NM
    </select>

    <!-- 트리에서 점검결과 목록 조회 -->
    <select id="retrieveIN0501ToTree" parameterType="map" resultType="map" >
        <![CDATA[ /* in0501.retrieveIN0501ToTree */ ]]>
        WITH EQ_SUB
          AS (SELECT CLS_CD,
                     PRNT_CLS_CD,
                     CLS_LVL,
                     COMPANY_CD
              FROM   EQ0201M
              WHERE  EQ_CLS = #{eqClsDiv}
                     AND CLS_CD IN (${eqNo})
                     AND COMPANY_CD = #{companyCd}
              UNION ALL
              SELECT M.CLS_CD,
                     M.PRNT_CLS_CD,
                     M.CLS_LVL,
                     M.COMPANY_CD
              FROM   EQ0201M M
                     JOIN EQ_SUB N
                       ON N.CLS_CD = M.PRNT_CLS_CD AND N.COMPANY_CD = M.COMPANY_CD
              WHERE  1 = 1)
        SELECT DISTINCT
               X.CHK_TP
             , X.COMPANY_CD
             , X.ORG_CD
             , dbo.FN_NAME(X.ORG_CD, 'DEPT') ORG_CD_DESC
             , Z.EQ_NO
             , Z.EQ_NM
             , X.CHK_NM
             , (X.ORG_CD  +  '_doosungcmms_'  +  X.EQ_NO  +  '_doosungcmms_'  +  X.CHK_NM) HDR_KEY
          FROM IN0201M X,  EQ0101M Z
         WHERE X.EQ_NO  = Z.EQ_NO
           AND X.COMPANY_CD = Z.COMPANY_CD
           AND Z.REV_NO = #{revNo}
           AND X.COMPANY_CD = #{companyCd}
           AND EXISTS (SELECT 1
                         FROM IN0401M R, IN0401D Z1
                        WHERE R.CHK_SCHD_NO = Z1.CHK_SCHD_NO
                          AND R.COMPANY_CD = Z1.COMPANY_CD
                          AND R.COMPANY_CD = #{companyCd}
                          AND R.CHK_NO = X.CHK_NO
                          AND R.CMPLT_YN = 'Y'
                      )
         <if test="eqClsDiv == 'EQ_TP'">
          AND Z.EQ_TP IN (
              SELECT CLS_CD FROM EQ_SUB
              )
         </if>
         <if test="eqClsDiv == 'EQ_LOC'">
          AND Z.EQ_LOC IN (
                SELECT CLS_CD FROM EQ_SUB
              )
         </if>
         <if test="eqClsDiv == 'EQ_PRCS'">
          AND Z.EQ_PRCS IN (
                SELECT CLS_CD FROM EQ_SUB
              )
         </if>
         <if test="eqClsDiv == 'EQ_MY'">
          AND Z.EQ_PRCS IN (
                 SELECT EQ_PRCS
                  FROM EQ0101M
                 WHERE 1=1
                   AND EQ_NO IN (${eqNo})
                   AND COMPANY_CD = #{companyCd}
              )
          AND Z.EQ_NO IN (SELECT EQ_NO FROM EQ0101P WHERE USE_YN = 'Y' AND USER_ID = #{userId} AND COMPANY_CD = #{companyCd})
         </if>
         ORDER BY X.ORG_CD, Z.EQ_NO, X.CHK_NM
    </select>

    <!-- 점검항목데이터작성 조회 -->
    <select id="retrieveIN0501Sub" parameterType="map" resultType="map" >
        <![CDATA[ /* in0501.retrieveIN0501Sub */ ]]>
        SELECT
               HT.CYCLE_CD
             , HT.COMPANY_CD
             , HT.CYCLE_TP
             , HT.CYCLE_DESC
             , HT.CHK_NO
             , HT.SEQ_NO
             , HT.CHK_DTL_NM
             , HT.CHK_PART_DESC
             , HT.INPUT_TP
             , HT.UNIT_CD
             , HT.UNIT_NM
        <foreach collection="cmplYmdList" item="cmplYmdList" open="" separator="" close="">
             , MAX(CASE WHEN RT.CMPL_YMD = #{cmplYmdList.cmplYmd} THEN RT.CHK_VAL ELSE NULL END ) CHK_VAL_${cmplYmdList.cmplYmd}
             , MAX(CASE WHEN RT.CMPL_YMD = #{cmplYmdList.cmplYmd} THEN RT.CHK_STS ELSE NULL END ) CHK_STS_${cmplYmdList.cmplYmd}
        </foreach>
             , HT.HDR_KEY
             , HT.CHK_DTL_NO
          FROM
             (
              SELECT
                     H.CYCLE_CD
                   , H.COMPANY_CD
                   , H.CYCLE_TP
                   , (H.CYCLE_CD + ' ' + dbo.FN_NAME(H.CYCLE_TP, 'CYCLE_TP')) CYCLE_DESC
                   , H.CHK_NO
                   , X.SEQ_NO
                   , X.CHK_DTL_NM
                   , X.CHK_PART_DESC
                   , X.INPUT_TP
                   , X.UNIT_CD
                   , (SELECT UNIT_NM FROM CO0401M WHERE UNIT_CD = X.UNIT_CD AND COMPANY_CD = X.COMPANY_CD) UNIT_NM
                   , (H.ORG_CD  +  '_doosungcmms_'  +  H.EQ_NO  +  '_doosungcmms_'  +  H.CHK_NM) HDR_KEY
                   , X.CHK_DTL_NO
                   , X.CHK_REV_SEQ
                FROM IN0201M H
			   INNER JOIN IN0201D_R X ON X.CHK_NO = H.CHK_NO AND X.COMPANY_CD = H.COMPANY_CD
               WHERE H.ORG_CD  +  '_doosungcmms_'  +  H.EQ_NO  +  '_doosungcmms_'  +  H.CHK_NM = #{hdrKey}
              ) HT
             INNER JOIN
             (
              SELECT
                     A.CHK_NO
                   , A.COMPANY_CD
                   , A.CHK_SCHD_NO
                   , REPLACE(A.CMPL_YMD, '-', '') CMPL_YMD
                   , B.CHK_RSLT_NO
                   , B.CHK_DTL_NO
                   , CASE WHEN (SELECT AA.INPUT_TP FROM IN0201D AA WHERE AA.CHK_DTL_NO = B.CHK_DTL_NO AND AA.COMPANY_CD = #{companyCd} ) = 'STS' THEN ''
                     ELSE CONVERT(VARCHAR, B.CHK_VAL) END CHK_VAL
                   , B.CHK_STS
                   , A.CHK_REV_SEQ
                FROM IN0401M A
		  	   INNER JOIN IN0401D B ON B.CHK_SCHD_NO = A.CHK_SCHD_NO AND B.COMPANY_CD = A.COMPANY_CD
               WHERE A.CMPLT_YN = 'Y'
                 AND A.COMPANY_CD = #{companyCd}
                 AND A.CMPL_YMD <![CDATA[ >= ]]> #{fStartDate}
                 AND A.CMPL_YMD <![CDATA[ <= ]]> #{fEndDate}
                   ) RT ON (RT.CHK_DTL_NO = HT.CHK_DTL_NO AND RT.CHK_NO = HT.CHK_NO AND RT.CHK_REV_SEQ = HT.CHK_REV_SEQ AND RT.COMPANY_CD = HT.COMPANY_CD)
         WHERE 1=1
         GROUP BY HT.COMPANY_CD, HT.CYCLE_CD, HT.CYCLE_TP, HT.CYCLE_DESC, HT.CHK_NO, HT.SEQ_NO, HT.CHK_DTL_NM, HT.CHK_PART_DESC, HT.INPUT_TP, HT.UNIT_CD, HT.UNIT_NM, HT.HDR_KEY, HT.CHK_DTL_NO
         ORDER BY HT.CYCLE_TP DESC, HT.CHK_NO, HT.SEQ_NO
    </select>

    <!-- 점검일자 가져오기 -->
    <select id="retrieveIN0501SubCmplYmd" parameterType="map" resultType="map" >
        <![CDATA[ /* in0501.retrieveIN0501SubCmplYmd */ ]]>
        SELECT DISTINCT CMPL_YMD
          FROM (
                 SELECT REPLACE(RH.CMPL_YMD, '-', '') CMPL_YMD
                   FROM IN0201M LH, IN0401M RH
                  WHERE LH.CHK_NO = RH.CHK_NO
                    AND LH.COMPANY_CD = RH.COMPANY_CD
                    AND LH.COMPANY_CD = #{companyCd}
                    AND RH.CMPL_YMD <![CDATA[ >= ]]> #{fStartDate}
                    AND RH.CMPL_YMD <![CDATA[ <= ]]> #{fEndDate}
                    AND LH.ORG_CD  +  '_doosungcmms_'  +  LH.EQ_NO  +  '_doosungcmms_'  +  LH.CHK_NM = #{hdrKey}
                    AND RH.CMPLT_YN = 'Y'
               ) A
    </select>
</mapper>