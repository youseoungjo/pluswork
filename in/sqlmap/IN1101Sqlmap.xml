<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--************************************************************************************
* Program Name : 일상점검결과 작성
* Description : 일상점검결과 작성 검색
* Author : jit13
* Created Date :
* SQL 목록
***************************************************************************************
* SQLID                 설명
***************************************************************************************
* retrieveIN0401    : 일상점검결과 작성 조회
* retrieveIN0401Sub : 일상점검결과 작성 상세목록 조회
*************************************************************************************-->
<mapper namespace="in1101">
    <!-- 일상점검결과 조회 -->
    <select id="retrieveIN1101" parameterType="map" resultType="map" >
        <![CDATA[ /* in1101.retrieveIN1101 */ ]]>
        SELECT X.CHK_NO
             , X.COMPANY_CD
             , z.CHK_NM
             , X.CHK_DTL_NO
             , X.CHK_DTL_NM
             , X.SEQ_NO
             , X.CHK_METHOD
             , X.CHK_PART_DESC
             , X.INPUT_TP
             , CASE WHEN X.INPUT_TP = 'STS' THEN ''
			   ELSE CONVERT(VARCHAR, X.CHK_STD_VAL) END CHK_STD_VAL
             , CASE WHEN INPUT_TP = 'STS' THEN ''
			   ELSE CONVERT(VARCHAR, X.CHK_MIN_VAL) END CHK_MIN_VAL
             , CASE WHEN X.INPUT_TP = 'STS' THEN ''
			   ELSE CONVERT(VARCHAR, X.CHK_MAX_VAL) END CHK_MAX_VAL
             , CASE WHEN X.INPUT_TP = 'STS' THEN ''
			   ELSE CONVERT(VARCHAR, X.WARN_MIN_VAL) END WARN_MIN_VAL
             , CASE WHEN X.INPUT_TP = 'STS' THEN ''
			   ELSE CONVERT(VARCHAR, X.WARN_MAX_VAL) END WARN_MAX_VAL
             , CASE WHEN X.INPUT_TP = 'STS' THEN ''
			   ELSE CONVERT(VARCHAR, Y.CHK_VAL) END CHK_VAL
             , Z.DAY_YN
             , Y.CHK_RSLT_NO
             , Y.CHK_STS
             , ISNULL(Y.CHK_YMD, CONVERT(VARCHAR, GETDATE(), 23)) AS CHK_YMD
             , Y.CHK_TIME
             , Y.CHK_USER_ID
             , (SELECT USER_NM FROM SC_USER WHERE USER_ID = Y.CHK_USER_ID AND COMPANY_CD = #{companyCd}) CHK_USER_DESC
             , Y.CHK_YN
             , X.UNIT_CD
             , (SELECT UNIT_NM FROM CO0401M WHERE UNIT_CD = X.UNIT_CD AND COMPANY_CD = #{companyCd}) UNIT_NM
             , Y.CMMNT
             , Y.CMMNT RESULT_CMMNT
             , Y.FILE_ATCH_ID
             , (SELECT COUNT(*) FROM SC_FILE WHERE FILE_ATCH_ID = Y.FILE_ATCH_ID) AS FILE_CNT
             , Z.EQ_NO
             , A.EQ_NM
          FROM IN0201D X
          LEFT OUTER JOIN IN0401D Y ON (X.CHK_DTL_NO = Y.CHK_DTL_NO AND Y.CHK_YMD = CONVERT(VARCHAR, GETDATE(), 23) AND X.COMPANY_CD = Y.COMPANY_CD)
         INNER JOIN IN0201M Z ON (X.CHK_NO = Z.CHK_NO AND Z.DAY_YN = 'Y' AND X.COMPANY_CD = Z.COMPANY_CD)
         INNER JOIN EQ0101M A ON (Z.EQ_NO = A.EQ_NO AND Z.COMPANY_CD = A.COMPANY_CD)
         WHERE 1=1
           AND X.COMPANY_CD = #{companyCd}
        <if test="feqNo != null &amp;&amp; feqNo != ''">
           AND Z.EQ_NO = #{feqNo}
        </if>
        <if test="forgCd != null &amp;&amp; forgCd != ''">
           AND Z.ORG_CD IN (${forgCd})
        </if>
        <if test="fchkUserId != null &amp;&amp; fchkUserId != ''">
           AND UPPER(Y.CHK_USER_ID) LIKE '%' + UPPER(#{fchkUserId}) + '%'
        </if>
        <if test="fchkNm != null &amp;&amp; fchkNm != ''">
           AND UPPER(Z.CHK_NM) LIKE '%' + UPPER(#{fchkNm}) + '%'
        </if>
        <if test="chkConS != null &amp;&amp; chkConS != ''">
           AND X.CHK_CON IN (${chkConS})
        </if>
        ORDER BY z.CHK_NM ASC, X.SEQ_NO ASC
    </select>

    <!-- 일상점검결과 저장  -->
    <insert id="saveIN1101List" parameterType="map" >
        <![CDATA[ /* in1101.saveIN1101List */ ]]>
        INSERT INTO IN0401D (
               CHK_VAL
             , COMPANY_CD
             , CHK_STS
             , CHK_YMD
             , CHK_TIME
             , HAND_YN
             , EQ_NO
             , CHK_DTL_NO
             , CMMNT
             , CHK_USER_ID
             , CHK_RSLT_NO
             , CHK_SCHD_NO
             , FILE_ATCH_ID
             , DAY_YN
             , CHK_YN
             , FST_REG_DT
             , FST_REG_USER_ID
             , FNL_EDIT_DT
             , FNL_EDIT_USER_ID
        )
        VALUES (
               #{chkVal}
             , #{companyCd}
             , #{chkSts}
             <if test="chkYmd == ''">
             , CONVERT(VARCHAR,GETDATE(), 23)
             </if>
             <if test="chkYmd != ''">
             , #{chkYmd}
             </if>
             , REPLACE(CONVERT(VARCHAR(5),GETDATE(),24),':','')
             , 'Y'
             , #{eqNo}
             , #{chkDtlNo}
             , #{resultCmmnt}
             , #{chkUserId}
             , NEXT VALUE FOR DBO.SQIN_CHECK_RESULT_01
             , #{chkSchdNo}
             <if test="fileAtchId == ''">
             , null
             </if>
             <if test="fileAtchId != ''">
             , #{fileAtchId}
             </if>
             , 'Y'
             , 'Y'
             , GETDATE()
             , #{fstRegUserId}
             , GETDATE()
             , #{fnlEditUserId}
        )
    </insert>

    <!-- 일상점검결과 수정  -->
    <update id="updateIN1101List" parameterType="map" >
        <![CDATA[ /* in1101.updateIN1101List */ ]]>
        UPDATE IN0401D
           SET
               CHK_VAL          = #{chkVal}
             , CHK_STS          = #{chkSts}
             , CMMNT            = #{resultCmmnt}
             , HAND_YN          = 'Y'
             , CHK_USER_ID      = ISNULL(#{chkUserId},#{fnlEditUserId})
             <if test="chkYmd == ''">
             , CHK_YMD          = CONVERT(VARCHAR,GETDATE(), 23)
             </if>
             <if test="chkYmd != ''">
             , CHK_YMD          = #{chkYmd}
             </if>
             , CHK_TIME         = REPLACE(CONVERT(VARCHAR(5),GETDATE(),24),':','')
             <if test="fileAtchId == ''">
             , FILE_ATCH_ID     = null
             </if>
             <if test="fileAtchId != ''">
             , FILE_ATCH_ID     = #{fileAtchId}
             </if>
             , DAY_YN     = 'Y'
             , CHK_YN     = 'Y'
             , FNL_EDIT_DT    = GETDATE()
             , FNL_EDIT_USER_ID = #{fnlEditUserId}
         WHERE CHK_RSLT_NO = #{chkRsltNo}
           AND COMPANY_CD  = #{companyCd}
    </update>

</mapper>