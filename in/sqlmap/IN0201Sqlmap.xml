<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--************************************************************************************
* Program Name : 설비별 점검데이터검색
* Description : 설비별 점검데이터 검색
* Author : jit13
* Created Date :
* SQL 목록
***************************************************************************************
* SQLID                 설명
***************************************************************************************
* retrieveIN0201    : 설비별 점검데이터 목록 조회
* retrieveIN0201Sub : 설비별 점검데이터 상세목록 조회
*************************************************************************************-->
<mapper namespace="in0201">
    <!-- 점검데이터작성 조회 -->
    <select id="retrieveIN0201" parameterType="map" resultType="map" >
        <![CDATA[ /* in0201.retrieveIN0201 */ ]]>
          SELECT X.ORG_CD
               , dbo.FN_NAME(X.ORG_CD, 'DEPT') ORG_CD_DESC
               , X.COMPANY_CD
               , Y.EQ_NO
               , Y.EQ_NM
               , X.CHK_NM
               , X.CYCLE_CD
               , X.CYCLE_TP
               , (X.CYCLE_CD + ' ' + dbo.FN_NAME(X.CYCLE_TP, 'CYCLE_TP')) CYCLE_DESC
               , X.CHK_NO
               , X.ACT_YN
               , ISNULL((SELECT MAX(CMPL_YMD) FROM IN0401M WHERE CHK_NO = X.CHK_NO AND CMPLT_YN = 'Y' AND COMPANY_CD = #{companyCd}), X.LAST_CHK_YMD) LAST_CHK_YMD
               , (SELECT MIN(ACTL_YMD)
                    FROM IN0401M
                   WHERE CHK_NO = X.CHK_NO
                     AND CMPLT_YN = 'N'
                     AND COMPANY_CD = #{companyCd}
                     AND ACTL_YMD > ISNULL((SELECT MAX(CMPL_YMD) FROM IN0401M WHERE CHK_NO = X.CHK_NO AND CMPLT_YN = 'Y' AND COMPANY_CD = #{companyCd}), X.LAST_CHK_YMD)
                 ) NEXT_CHK_YMD
               , (SELECT COUNT(CHK_DTL_NO) FROM IN0201D WHERE CHK_NO = X.CHK_NO AND COMPANY_CD = #{companyCd}) CHK_COUNT
            FROM IN0201M X
           INNER JOIN EQ0101M Y ON (X.EQ_NO = Y.EQ_NO AND X.COMPANY_CD = Y.COMPANY_CD)
           WHERE 1=1
             AND Y.REV_NO = #{revNo}
             AND X.COMPANY_CD = #{companyCd}
          <if test="feqNo != null &amp;&amp; feqNo != ''">
             AND X.EQ_NO  = #{feqNo}
          </if>
          <if test="fchkNm != null &amp;&amp; fchkNm != ''">
             AND UPPER(X.CHK_NM) LIKE '%' + UPPER(#{fchkNm}) + '%'
          </if>
          <if test="forgCd != null &amp;&amp; forgCd != ''">
             AND X.ORG_CD = #{forgCd}
          </if>
           ORDER BY X.ORG_CD, Y.ITEM_NO, X.CYCLE_TP , X.CYCLE_CD, X.CHK_NM
    </select>

    <select id="retrieveIN0201ToTree" parameterType="map" resultType="map" >
        <![CDATA[ /* in0201.retrieveIN0201ToTree */ ]]>
		 WITH EQ_SUB
          AS (SELECT CLS_CD,
                     PRNT_CLS_CD,
                     CLS_LVL,
                     COMPANY_CD
              FROM   EQ0201M
              WHERE  EQ_CLS = #{eqClsDiv}
                     AND CLS_CD IN (${eqNo})
                     AND COMPANY_CD = #{companyCd}
              UNION ALL
              SELECT M.CLS_CD,
                     M.PRNT_CLS_CD,
                     M.CLS_LVL,
                     M.COMPANY_CD
              FROM   EQ0201M M
                     JOIN EQ_SUB N
                       ON N.CLS_CD = M.PRNT_CLS_CD AND N.COMPANY_CD = M.COMPANY_CD
              WHERE  1 = 1)
          SELECT X.ORG_CD
               , dbo.FN_NAME(X.ORG_CD, 'DEPT') ORG_CD_DESC
               , X.COMPANY_CD
               , Y.EQ_NO
               , Y.EQ_NM
               , X.CHK_NM
               , X.CYCLE_CD
               , X.CYCLE_TP
               , (X.CYCLE_CD + ' ' + dbo.FN_NAME(X.CYCLE_TP, 'CYCLE_TP')) CYCLE_DESC
               , X.CHK_NO
               , X.ACT_YN
               , ISNULL((SELECT MAX(CMPL_YMD) FROM IN0401M WHERE CHK_NO = X.CHK_NO AND CMPLT_YN = 'Y' AND COMPANY_CD = #{companyCd}), X.LAST_CHK_YMD) LAST_CHK_YMD
               , (SELECT MIN(ACTL_YMD)
                    FROM IN0401M
                   WHERE CHK_NO = X.CHK_NO
                     AND CMPLT_YN = 'N'
                     AND COMPANY_CD = #{companyCd}
                     AND ACTL_YMD > ISNULL((SELECT MAX(CMPL_YMD) FROM IN0401M WHERE CHK_NO = X.CHK_NO AND CMPLT_YN = 'Y' AND COMPANY_CD = #{companyCd}), X.LAST_CHK_YMD)
                 ) NEXT_CHK_YMD
               , (SELECT COUNT(CHK_DTL_NO) FROM IN0201D WHERE CHK_NO = X.CHK_NO AND COMPANY_CD = #{companyCd}) CHK_COUNT
            FROM IN0201M X
           INNER JOIN EQ0101M Y ON (X.EQ_NO = Y.EQ_NO AND X.COMPANY_CD = Y.COMPANY_CD)
           WHERE 1=1
             AND Y.REV_NO = #{revNo}
             AND X.COMPANY_CD = #{companyCd}
          <if test="eqClsDiv == 'EQ_TP'">
          AND Y.EQ_TP IN (
              SELECT CLS_CD FROM EQ_SUB
              )
         </if>
         <if test="eqClsDiv == 'EQ_LOC'">
          AND Y.EQ_LOC IN (
                SELECT CLS_CD FROM EQ_SUB
              )
         </if>
         <if test="eqClsDiv == 'EQ_PRCS'">
          AND Y.EQ_PRCS IN (
                SELECT CLS_CD FROM EQ_SUB
              )
         </if>
         <if test="eqClsDiv == 'EQ_MY'">
          AND Y.EQ_PRCS IN (
                 SELECT EQ_PRCS
                  FROM EQ0101M
                 WHERE 1=1
                   AND EQ_NO IN (${eqNo})
                   AND COMPANY_CD = #{companyCd}
              )
          AND Y.EQ_NO IN (SELECT EQ_NO FROM EQ0101P WHERE USE_YN = 'Y' AND USER_ID = #{userId} AND COMPANY_CD = #{companyCd})
         </if>
           ORDER BY X.ORG_CD, Y.ITEM_NO, X.CYCLE_TP , X.CYCLE_CD, X.CHK_NM
    </select>

    <!-- 점검항목데이터작성 조회 -->
    <select id="retrieveIN0201Sub" parameterType="map" resultType="map" >
        <![CDATA[ /* in0201.retrieveIN0201Sub */ ]]>
        SELECT
               A.CYCLE_CD
             , A.COMPANY_CD
             , A.CYCLE_TP
             , A.CYCLE_DESC
             , A.CHK_NO
             , A.LAST_CHK_YMD
             , A.NEXT_CHK_YMD
             , A.ACT_YN
             , A.ORG_CD
             , A.ORG_CD_DESC
             , D.SEQ_NO
             , D.CHK_DTL_NM
             , D.CHK_PART_DESC
             , D.INPUT_TP
             , D.UNIT_CD
             , (SELECT UNIT_NM FROM CO0401M WHERE UNIT_CD = D.UNIT_CD) UNIT_NM
             , CASE WHEN D.INPUT_TP = 'STS' THEN ''
			   ELSE CONVERT(VARCHAR, D.CHK_STD_VAL) END CHK_STD_VAL
             , CASE WHEN D.INPUT_TP = 'STS' THEN ''
			   ELSE CONVERT(VARCHAR, D.CHK_MIN_VAL) END CHK_MIN_VAL
             , CASE WHEN D.INPUT_TP = 'STS' THEN ''
			   ELSE CONVERT(VARCHAR, D.CHK_MAX_VAL) END CHK_MAX_VAL
             , CASE WHEN D.INPUT_TP = 'STS' THEN ''
			   ELSE CONVERT(VARCHAR, D.WARN_MIN_VAL) END WARN_MIN_VAL
             , CASE WHEN D.INPUT_TP = 'STS' THEN ''
			   ELSE CONVERT(VARCHAR, D.WARN_MAX_VAL) END WARN_MAX_VAL
             , D.CMMNT
             , D.CHK_DTL_NO
         FROM (
               SELECT X.CYCLE_CD
                    , X.COMPANY_CD
                    , X.CYCLE_TP
                    , (X.CYCLE_CD + ' ' + dbo.FN_NAME(X.CYCLE_TP, 'CYCLE_TP')) CYCLE_DESC
                    , X.ORG_CD
                    , dbo.FN_NAME(X.ORG_CD, 'DEPT') ORG_CD_DESC
                    , X.CHK_NO
                    , ISNULL((SELECT MAX(CMPL_YMD) FROM IN0401M WHERE CHK_NO = X.CHK_NO AND CMPLT_YN = 'Y' AND COMPANY_CD = #{companyCd}), X.LAST_CHK_YMD) LAST_CHK_YMD
                    , (SELECT MIN(ACTL_YMD)
                         FROM IN0401M
                        WHERE CHK_NO = X.CHK_NO
                          AND CMPLT_YN = 'N'
                          AND COMPANY_CD = #{companyCd}
                          AND ACTL_YMD > ISNULL((SELECT MAX(CMPL_YMD) FROM IN0401M WHERE CHK_NO = X.CHK_NO AND CMPLT_YN = 'Y' AND COMPANY_CD = #{companyCd}), X.LAST_CHK_YMD)
                       ) NEXT_CHK_YMD
                    , X.ACT_YN
                 FROM IN0201M X, EQ0101M Y
                WHERE X.EQ_NO = Y.EQ_NO
                  AND X.COMPANY_CD = Y.COMPANY_CD
                  AND X.EQ_NO = #{eqNo}
                  AND X.COMPANY_CD = #{companyCd}
                  AND Y.REV_NO = #{revNo}
                  AND X.ORG_CD  +  '_doosungcmms_'  +  X.CHK_NM
                           =  (SELECT ORG_CD  +  '_doosungcmms_'  +  CHK_NM FROM IN0201M WHERE CHK_NO = #{chkNo} AND COMPANY_CD = #{companyCd} )
              ) A, IN0201D D
        WHERE A.CHK_NO = D.CHK_NO
          AND A.COMPANY_CD = D.COMPANY_CD
        ORDER BY A.CHK_NO, D.SEQ_NO
    </select>
</mapper>